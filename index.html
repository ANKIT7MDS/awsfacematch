<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8">
  <title>Face Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --brand:#ff8800;
      --bg:#fff7ef;
      --card:#ffffff;
      --muted:#777;
      --danger:#b00020;
      --ok:#108a00;
      --border:#eee;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#fff;font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{background:var(--brand);color:#fff;padding:10px 14px;font-weight:700}
    main{padding:14px;max-width:1200px;margin:auto}
    .layout{display:grid;grid-template-columns: 1fr 1fr;gap:14px}
    @media (max-width:900px){.layout{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card .hd{padding:10px 14px;border-bottom:1px solid var(--border);font-weight:600}
    .card .bd{padding:14px}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input[type=text],input[type=tel],input[type=file]{width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:8px;font:inherit}
    .btn{display:inline-block;background:var(--brand);color:#fff;border:0;border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.gray{background:#222}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .hint{color:var(--muted);font-size:.92rem}
    .ok{color:var(--ok);font-weight:600}
    .danger{color:#fff;background:#ffe3e6;border:1px solid #ffd1d6;padding:12px;border-radius:8px;color:#a10015}
    details.err{margin-top:6px}
    #video{width:100%;background:#000;border-radius:12px}
    #canvas{width:100%;display:none;border-radius:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:700px){.grid{grid-template-columns:1fr}}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;background:#f3f3f3;border-radius:10px;border:1px solid var(--border)}
    .cardR{padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .meta{font-size:.9rem;color:#444;margin-top:6px}
    .muted{color:var(--muted)}
    .msg{padding:10px;border:1px dashed var(--border);border-radius:8px;color:#444;background:#fafafa}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f0f0f0;font-size:.8rem}
    .stat{margin:8px 0 0 0}
  </style>
</head>
<body>
  <header>Face Search</header>
  <main>
    <div class="layout">
      <!-- LEFT: Form + Camera -->
      <section class="card">
        <div class="hd">खोज</div>
        <div class="bd">
          <div class="row">
            <div style="flex:1">
              <label>नाम <span class="muted">(अनिवार्य)</span></label>
              <input id="name" type="text" placeholder="आपका नाम" autocomplete="name" required>
            </div>
            <div style="flex:1">
              <label>मोबाइल नंबर <span class="muted">(अनिवार्य)</span></label>
              <input id="mobile" type="tel" placeholder="10 अंकों का नंबर" maxlength="10" inputmode="numeric" required>
            </div>
          </div>

          <label class="stat">सेल्फी कैमरा</label>
          <video id="video" playsinline autoplay muted></video>
          <canvas id="canvas"></canvas>

          <div class="actions">
            <button id="btnSnap" class="btn">सेल्फ़ी लें</button>
            <button id="btnRetake" class="btn gray" type="button">दोबारा लें</button>
          </div>

          <div class="stat">
            <span id="selfieStatus" class="muted">सेल्फ़ी तैयार करें या फ़ाइल चुनें।</span>
          </div>

          <label class="stat">या फ़ाइल चुनें</label>
          <input id="fileInput" type="file" accept="image/*">

          <div class="hint" style="margin:10px 0 4px">
            PNG/WebP → JPEG auto. * मोबाइल पर कैमरा अपने-आप खुलेगा (Allow दें)।
          </div>

          <div class="actions" style="margin-top:12px">
            <button id="btnSearch" class="btn" style="min-width:160px">Search</button>
          </div>

          <div id="status" class="stat"></div>
          <details id="errBox" class="err">
            <summary>एरर डीटेल्स</summary>
            <pre id="errText" style="white-space:pre-wrap"></pre>
          </details>
        </div>
      </section>

      <!-- RIGHT: Results -->
      <section class="card">
        <div class="hd">परिणाम</div>
        <div class="bd">
          <div id="found" class="ok" style="display:none"></div>
          <div id="results" class="grid"></div>
          <div id="empty" class="msg" style="display:none">कोई फोटो नहीं मिला।</div>
        </div>
      </section>
    </div>
  </main>

<script>
/* ====== CONFIG ====== */
// change if needed OR pass in URL:  ?api=...&event=...
const API_BASE = param('api') || 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
const DEFAULT_EVENT_ID = param('event') || 'demo-2025-01';   // अपने इवेंट के हिसाब से सेट करें
const DEFAULT_SIM = Number(param('sim') || 70);              // न्यूनतम similarity

/* ====== DOM ====== */
const $ = sel => document.querySelector(sel);
const nameEl   = $('#name');
const mobileEl = $('#mobile');
const video    = $('#video');
const canvas   = $('#canvas');
const fileEl   = $('#fileInput');
const btnSnap  = $('#btnSnap');
const btnRetake= $('#btnRetake');
const btnSearch= $('#btnSearch');
const selfieStatus = $('#selfieStatus');
const resultsEl = $('#results');
const emptyEl   = $('#empty');
const foundEl   = $('#found');
const errBox    = $('#errBox');
const errText   = $('#errText');
const statusEl  = $('#status');

/* ====== STATE ====== */
const state = {
  stream: null,
  imageBase64: '', // only base64 (no dataurl header)
  imgBytes: 0,
  lastFileName: ''
};

/* ====== HELPERS ====== */
function param(k){
  const u = new URL(location.href);
  return u.searchParams.get(k);
}
function stripDataUrl(dataUrl){
  const idx = dataUrl.indexOf(',');
  return idx > -1 ? dataUrl.slice(idx+1) : dataUrl;
}
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

/* ====== CAMERA ====== */
async function startCamera(){
  try{
    state.stream?.getTracks()?.forEach(t => t.stop());
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode: 'user' },
      audio:false
    });
    state.stream = stream;
    video.srcObject = stream;
    await video.play().catch(()=>{});
  }catch(err){
    // सिर्फ़ चेतावनी दिखाएँ, फ़ाइल अपलोड fallback रहेगा
    console.warn('camera error', err);
    statusMsg('कैमरा उपलब्ध नहीं। फ़ाइल से भी खोज कर सकते हैं।', 'warn');
  }
}
function stopCamera(){
  try{ state.stream?.getTracks()?.forEach(t => t.stop()); }catch{}
  video.srcObject = null;
}
function snapshot(){
  const w = video.videoWidth || 720;
  const h = video.videoHeight || 720;
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0,w,h);
  const dataUrl = canvas.toDataURL('image/jpeg', .9);
  state.imageBase64 = stripDataUrl(dataUrl);
  state.imgBytes = Math.round((state.imageBase64.length * 3) / 4);
}

/* ====== FILE → BASE64 ====== */
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}
async function useFile(file){
  try{
    const dataUrl = await fileToDataURL(file);
    // draw on canvas to normalize format (and allow retake button to hide video)
    const img = new Image();
    await new Promise((res,rej)=>{
      img.onload=res; img.onerror=rej; img.src=dataUrl;
    });
    const w = img.width || 720, h = img.height || 720;
    canvas.width=w; canvas.height=h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    const jpeg = canvas.toDataURL('image/jpeg', .9);
    state.imageBase64 = stripDataUrl(jpeg);
    state.imgBytes = Math.round((state.imageBase64.length * 3)/4);
    canvas.style.display='block';
    video.style.display='none';
    selfieStatus.textContent = 'सेल्फ़ी तैयार ✓';
  }catch(err){
    showErr('फ़ाइल पढ़ने में समस्या', err);
  }
}

/* ====== UI EVENTS ====== */
btnSnap.addEventListener('click', async (e)=>{
  e.preventDefault();
  if(!video.srcObject){ await startCamera(); await sleep(200); }
  snapshot();
  canvas.style.display='block';
  video.style.display='none';
  selfieStatus.textContent = `सेल्फ़ी तैयार ✓ (${state.imgBytes} bytes)`;
});

btnRetake.addEventListener('click', (e)=>{
  e.preventDefault();
  canvas.style.display='none';
  video.style.display='block';
  state.imageBase64 = '';
  selfieStatus.textContent = 'सेल्फ़ी फिर से लें या फ़ाइल चुनें।';
});

fileEl.addEventListener('change', (e)=>{
  const f = e.target.files?.[0];
  if(f){ state.lastFileName = f.name; useFile(f); }
});

btnSearch.addEventListener('click', (e)=>{ e.preventDefault(); doSearch(); });

/* ====== SEARCH ====== */
function validMobile(m){
  return /^\d{10}$/.test((m||'').trim());
}
function statusMsg(msg, type='info'){
  statusEl.textContent = msg || '';
  statusEl.className = type==='warn' ? 'muted' : '';
}

async function fetchSmart(url, opt){
  const resp = await fetch(url, opt);
  let dataText = '';
  try{
    if(resp.headers.get('content-type')?.includes('application/json')){
      const j = await resp.json();
      return { ok: resp.ok, status: resp.status, data: j };
    }else{
      dataText = await resp.text();
      return { ok: resp.ok, status: resp.status, data: dataText };
    }
  }catch(e){
    return { ok:false, status: resp.status, data: dataText || 'JSON parse error' };
  }
}

async function doSearch(){
  errBox.open = false; errText.textContent='';
  const nm = (nameEl.value||'').trim();
  const mb = (mobileEl.value||'').trim();

  if(!nm){ showMsg('कृपया नाम भरें।'); return; }
  if(!validMobile(mb)){ showMsg('कृपया 10 अंकों का मोबाइल भरें।'); return; }

  // prepare image
  if(!state.imageBase64){
    // if video running, take a shot
    if(video.srcObject){ snapshot(); canvas.style.display='block'; video.style.display='none'; }
  }
  if(!state.imageBase64){
    showMsg('कृपया सेल्फ़ी लें या फ़ाइल चुनें।'); return;
  }

  btnSearch.disabled = true;
  showMsg('खोज जारी है…');

  const body = {
    eventId: DEFAULT_EVENT_ID,
    imageBase64: state.imageBase64,
    name: nm,
    mobile: mb,
    sim: DEFAULT_SIM
  };

  try{
    const r = await fetchSmart(API_BASE + '/search', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });

    if(!r.ok){
      showMsg(`सर्वर में दिक्कत: API ${r.status}`, true);
      errText.textContent = (typeof r.data==='string') ? r.data : JSON.stringify(r.data,null,2);
      errBox.open = true;
      btnSearch.disabled=false;
      return;
    }

    const payload = (typeof r.data==='string') ? JSON.parseSafe(r.data) : r.data;
    const items = payload?.items || payload?.results || payload?.matches || [];
    renderResults(items);
    const n = items.length|0;
    foundEl.style.display = 'block';
    foundEl.textContent = `मिले ${n} फोटो।`;
    showMsg('');
  }catch(err){
    showErr('search error', err);
  }finally{
    btnSearch.disabled=false;
  }
}

JSON.parseSafe = (s)=>{ try{return JSON.parse(s);}catch{return {}} };

function showMsg(msg, isErr=false){
  if(isErr){
    statusEl.innerHTML = `<div class="danger">${msg}</div>`;
  }else{
    statusEl.textContent = msg;
  }
}
function showErr(title, err){
  console.error(title, err);
  showMsg('नेटवर्क/ब्राउज़र एरर। बाद में फिर प्रयास करें।', true);
  errText.textContent = (err && err.stack) ? err.stack : String(err);
  errBox.open = true;
}

/* ====== RESULTS RENDER (with fallbacks) ====== */
function getId(r){ return r.photoId || r.id || r.imageId || ''; }
function getScore(r){ 
  const v = r.similarity ?? r.score ?? r.confidence ?? 0;
  return Math.round(v * 100) / 100;
}
function primaryKey(r){
  return r.s3Key || r.key || r.s3key || r.path || r.urlKey || '';
}
function buildImgUrlFromKey(key){ 
  return API_BASE + '/download?key=' + encodeURIComponent(key); 
}
function buildKeyCandidates(r){
  const prim = primaryKey(r);
  if (prim) return [prim];

  const ev  = r.eventId || r.event || DEFAULT_EVENT_ID;
  const pid = getId(r);
  const keys = [];
  if(ev && pid){
    const base = `events/${ev}/originals/${pid}`;
    ['.jpg','.JPG','.jpeg','.JPEG','.png','.webp'].forEach(ext => keys.push(base+ext));
  }
  return keys;
}
function tryNextImg(img){
  let rest=[];
  try{ rest = JSON.parse(img.dataset.keys||'[]'); }catch{}
  if(!rest.length){
    const ph = document.createElement('div');
    ph.className='thumb';
    ph.style.display='flex'; ph.style.alignItems='center'; ph.style.justifyContent='center'; ph.style.color='#888';
    ph.textContent='No preview';
    img.replaceWith(ph);
    return;
  }
  const next = rest.shift();
  img.dataset.keys = JSON.stringify(rest);
  img.src = buildImgUrlFromKey(next);
}
function cardHTML(r){
  const pid = getId(r);
  const sim = getScore(r);
  const keys = buildKeyCandidates(r);
  const first = keys[0];

  const imgPart = first
    ? `<img class="thumb" loading="lazy" alt="${pid||'photo'}"
             src="${buildImgUrlFromKey(first)}"
             data-keys='${JSON.stringify(keys.slice(1))}'
             onerror="tryNextImg(this)">`
    : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:#888">No preview</div>`;

  return `
    <div class="cardR">
      ${imgPart}
      <div class="meta">
        ${pid ? `<div><b>ID:</b> ${pid}</div>` : ''}
        ${sim ? `<div><span class="pill">~${sim}%</span> match</div>` : ''}
        ${primaryKey(r) ? `<div class="muted" style="word-break:break-all">${primaryKey(r)}</div>` : ''}
      </div>
    </div>`;
}
function renderResults(items){
  if(!items || !items.length){
    resultsEl.innerHTML = '';
    emptyEl.style.display='block';
    return;
  }
  emptyEl.style.display='none';
  resultsEl.innerHTML = items.map(cardHTML).join('');
}

/* ====== AUTOSTART ====== */
(async function init(){
  // URL से नाम/मोबाइल prefill (optional)
  if(param('name')) nameEl.value = param('name');
  if(param('mobile')) mobileEl.value = param('mobile');

  // कैमरा start (mobile/desktop दोनों पर)
  await startCamera();
  // पेज फोकस पर अगर कैमरा बंद है तो फिर से कोशिश
  window.addEventListener('focus', ()=>{
    if(!video.srcObject) startCamera().catch(()=>{});
  });
})();
</script>
</body>
</html>

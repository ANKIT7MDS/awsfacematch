<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>भारतीय जनता पार्टी — मंदसौर (Face Search)</title>
  <style>
    :root{
      --brand:#ff8800; --ink:#222; --muted:#6b7280; --bg:#fff7ed; --card:#fffaf5; --err:#fee2e2; --ok:#dcfce7;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
    body{margin:0;background:#fff}
    header{background:var(--brand);color:#000;font-weight:700;padding:10px 16px}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:14px;color:#111;font-weight:700}
    input[type=text]{width:100%;padding:14px 12px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px}
    input:focus{outline:3px solid #ffe5cc;border-color:#ffcb8a}
    .note{color:#6b7280;font-size:13px}
    .panel{background:var(--card);border:1px solid #fde7d3;border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    video,canvas{width:100%;max-height:380px;background:#000;border-radius:12px}
    .btn{appearance:none;border:0;border-radius:12px;background:var(--brand);color:#000;padding:14px 18px;font-weight:800;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.outline{background:#111;color:#fff}
    .btn.ghost{background:#111;color:#fff;opacity:.85}
    .msg{margin-top:12px;border-radius:12px;padding:12px 14px}
    .msg.err{background:var(--err);border:1px solid #fca5a5;color:#7f1d1d}
    .msg.ok{background:var(--ok);border:1px solid #86efac;color:#14532d}
    details{margin-top:6px}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;background:#f3f4f6;color:#111;font-size:13px}
    .footer{text-align:center;color:#6b7280;font-size:12px;margin:26px 0}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>भारतीय जनता पार्टी — मंदसौर (Face Search)</header>
  <div class="wrap">
    <div class="grid">
      <div class="field">
        <label for="name">नाम (अनिवार्य)</label>
        <input id="name" type="text" placeholder="आपका नाम" autocomplete="name" />
      </div>
      <div class="field">
        <label for="mobile">मोबाइल नंबर (अनिवार्य)</label>
        <input id="mobile" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="10" placeholder="10 अंकों का मोबाइल" />
      </div>
    </div>

    <div class="grid" style="margin-top:14px">
      <div>
        <div class="field">
          <label>सेल्फ़ी कैमरा</label>
          <video id="video" playsinline autoplay muted></video>
          <canvas id="canvas" hidden></canvas>
        </div>
        <div class="actions">
          <button id="btnStart" class="btn">कैमरा चालू करें</button>
          <button id="btnSnap" class="btn outline" disabled>सेल्फ़ी लें</button>
          <button id="btnRetake" class="btn ghost" disabled>दोबारा लें</button>
        </div>
      </div>
      <div>
        <div class="field">
          <label for="file">या फ़ाइल चुनें</label>
          <input id="file" type="file" accept="image/*" />
        </div>
        <div class="field">
          <button id="btnSearch" class="btn" style="width:100%">Search</button>
          <div class="note">PNG/WebP → JPEG auto. * मोबाइल पर कैमरा अपने-आप खुलेगा (Allow दें)। फ़ाइल अपलोड की ज़रूरत नहीं।</div>
          <div id="status" class="msg" hidden></div>
          <details id="errBox" hidden>
            <summary>एरर डिटेल्स</summary>
            <pre id="errJson" style="white-space:pre-wrap"></pre>
          </details>
          <div class="note">सर्च परिणाम नए टैब में खुलेंगे।</div>
          <div class="note">स्टेज: <span id="stage" class="pill">PROD2</span></div>
        </div>
      </div>
    </div>

    <div class="footer">© 2025</div>
  </div>

<script>
(function(){
  const SEARCH_API = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2/search';
  const DOWNLOAD_API = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2/download';

  const $ = sel => document.querySelector(sel);
  const video = $('#video');
  const canvas = $('#canvas');
  const file = $('#file');
  const btnStart = $('#btnStart');
  const btnSnap = $('#btnSnap');
  const btnRetake = $('#btnRetake');
  const btnSearch = $('#btnSearch');
  const statusEl = $('#status');
  const errBox = $('#errBox');
  const errJson = $('#errJson');

  let stream = null;
  let capturedDataURL = '';

  function getQuery(name){
    const q = new URLSearchParams(location.search);
    return q.get(name);
  }
  function getEventId(){
    return getQuery('e') || getQuery('event') || 'demo-2025-01';
  }

  function setStatus(msg, type='err'){
    statusEl.hidden = false; statusEl.textContent = msg; statusEl.className = 'msg ' + (type==='ok'?'ok':'err');
  }
  function clearStatus(){ statusEl.hidden = true; errBox.hidden = true; }

  async function startCamera(){
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
      video.srcObject = stream; await video.play();
      btnSnap.disabled = false; btnRetake.disabled = true; $('#btnStart').disabled = true;
    }catch(err){
      console.warn('camera error', err);
      setStatus('कैमरा एरर: अनुमति दें या किसी और ब्राउज़र में खोलें।');
    }
  }
  function stopCamera(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  }

  function dataURLFromVideo(){
    const w = video.videoWidth || 640, h = video.videoHeight || 480;
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video,0,0,w,h);
    const url = canvas.toDataURL('image/jpeg', 0.9);
    return url;
  }

  function fileToDataURL(f){
    return new Promise((res,rej)=>{ const rd = new FileReader(); rd.onerror=rej; rd.onload=()=>res(rd.result); rd.readAsDataURL(f); });
  }

  function toBase64(dataURL){
    if(!dataURL) return '';
    const i = dataURL.indexOf(',');
    return i>-1?dataURL.slice(i+1):dataURL;
  }

  async function fetchSmart(url, {body, headers={}}){
    const resp = await fetch(url, {method:'POST', headers:{'content-type':'application/json', ...headers}, body: JSON.stringify(body)});
    const txt = await resp.text();
    let json; try{ json = JSON.parse(txt); }catch{ json = null; }
    if(!resp.ok){
      const err = new Error('API '+resp.status);
      err.status = resp.status; err.url = url; err.bodyText = txt; err.headers = Object.fromEntries(resp.headers.entries()); err.json = json;
      throw err;
    }
    return json ?? { ok:true, data:txt };
  }

  function normalizeResults(data){
    // Accept several shapes and return [{thumb, download, name}]
    const out=[];
    if(!data) return out;
    const push = (thumb, download, name='')=> out.push({thumb, download, name});

    if(Array.isArray(data.photos)){
      data.photos.forEach(p=> push(p.thumbUrl||p.thumbnail||p.url, p.downloadUrl||p.url||p.href, p.photoId||p.id||''));
    }
    const items = data.items || data.results || data.matches || data.keys || [];
    if(Array.isArray(items)){
      items.forEach(it=>{
        const key = typeof it==='string'? it : (it.s3Key||it.key||it.path);
        if(key){
          const dl = `${DOWNLOAD_API}?key=${encodeURIComponent(key)}`;
          push(dl, dl, (it.photoId||it.id||key));
        }
      });
    }
    return out;
  }

  function openResultsTab(list){
    const html = `<!doctype html><meta charset="utf-8"><title>Results</title>
      <style>body{font-family:system-ui;margin:0;background:#fff} .wrap{max-width:1024px;margin:0 auto;padding:12px}
      .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
      .card{border:1px solid #eee;border-radius:12px;overflow:hidden}
      img{display:block;width:100%;height:220px;object-fit:cover}
      .row{display:flex;justify-content:space-between;align-items:center;padding:8px}
      a.btn{background:#111;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none}
      </style>
      <div class="wrap"><h2>Search Results (${list.length})</h2>
      <div class="grid">${list.map(x=> `<div class="card"><img loading="lazy" src="${x.thumb}"/><div class="row"><div>${x.name||''}</div><a class="btn" href="${x.download}" target="_blank" rel="noopener">Download</a></div></div>`).join('')}</div></div>`;
    const w = window.open('about:blank','_blank');
    if(w){ w.document.write(html); w.document.close(); }
  }

  async function callSearch(imageDataURL){
    const name = $('#name').value.trim();
    const mobile = $('#mobile').value.trim();
    const eventId = getEventId();

    const base64 = toBase64(imageDataURL||'');
    const payload = {
      eventId,
      phone: mobile,
      name,
      imageBase64: base64,
      image: base64,           // alias for some backends
      contentType: 'image/jpeg'
    };

    // Basic validations
    if(!/^[0-9]{10}$/.test(mobile)) throw new Error('मोबाइल 10 अंकों का भरें');
    if(!base64 || base64.length < 5000) throw new Error('सेल्फ़ी कैप्चर करें या फ़ाइल चुनें');

    // Hit API
    const data = await fetchSmart(SEARCH_API, {body: payload});
    return data;
  }

  async function doSearch(){
    clearStatus();
    btnSearch.disabled = true; const spinTxt = btnSearch.textContent; btnSearch.textContent = 'Searching…';
    try{
      let dataURL = capturedDataURL;
      if(file.files[0]) dataURL = await fileToDataURL(file.files[0]);
      if(!dataURL && stream) dataURL = dataURLFromVideo();

      const data = await callSearch(dataURL);
      const list = normalizeResults(data);
      setStatus('सर्च सफल। '+list.length+' फोटो मिले।', 'ok');
      openResultsTab(list);
    }catch(err){
      console.error('search error', err);
      setStatus('सर्व में दिक्कत: '+ (err.status? ('API '+err.status) : err.message));
      errBox.hidden = false; errJson.textContent = JSON.stringify({
        message: err.message,
        status: err.status||null,
        url: err.url||null,
        headers: err.headers||null,
        body: err.bodyText||null,
        json: err.json||null
      }, null, 2);
    }finally{
      btnSearch.disabled = false; btnSearch.textContent = spinTxt;
    }
  }

  // UI events
  btnStart.addEventListener('click', startCamera);
  btnSnap.addEventListener('click', ()=>{
    capturedDataURL = dataURLFromVideo();
    btnRetake.disabled = false; btnSnap.disabled = true; setStatus('सेल्फ़ी सेव हो गई। Search दबाएँ।', 'ok');
  });
  btnRetake.addEventListener('click', ()=>{ capturedDataURL=''; setStatus(''); clearStatus(); btnSnap.disabled=false; btnRetake.disabled=true; });
  btnSearch.addEventListener('click', ()=> doSearch());

  // Try auto camera on mobile
  if(navigator.mediaDevices && location.protocol==='https:'){
    // iOS needs a user gesture; on desktop we try once.
    if(!/iPhone|iPad|iPod/i.test(navigator.userAgent)) startCamera();
  }

  // --- Dev tests (open with #test) ---
  if(location.hash==="#test"){
    console.log('Running basic tests…');
    const b64 = toBase64('data:image/jpeg;base64,QUJDRA==');
    console.assert(b64==='QUJDRA==','base64 extraction');
    const n = normalizeResults({keys:['events/demo-2025-01/originals/IMG_0001.jpg']});
    console.assert(n.length===1 && n[0].download.includes('/download?key='),'normalize keys');
  }
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>भारतीय जनता पार्टी — मंदसौर | WedMatch — Face Search</title>
  <style>
    :root{
      --brand:#ff8a00; --brand-d:#f27700; --ink:#0f1720; --muted:#667085;
      --bg:#fff9f2; --card:#fff; --bd:#f1e4d4;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
    header{background:var(--brand);color:#111;padding:10px 16px;font-weight:800}
    main{max-width:1100px;margin:16px auto;padding:8px 12px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px 16px;margin-bottom:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row.single{grid-template-columns:1fr}
    label{display:block;font-size:12px;font-weight:700;margin:6px 0 6px;color:#111}
    input[type=text]{width:100%;border:1px solid var(--bd);border-radius:10px;padding:12px 12px;font-size:16px}
    #video{width:100%;aspect-ratio:4/3;background:#000;border:1px solid var(--bd);border-radius:12px}
    .btn{background:var(--brand);border:none;border-radius:10px;font-weight:800;padding:12px 14px;cursor:pointer}
    .btn:hover{background:var(--brand-d)} .btn.block{width:100%}
    .btn.ghost{background:#fff;border:1px solid var(--bd);color:#111}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .banner{margin-top:10px;border-radius:10px;padding:10px 12px;background:#fff7ed;border:1px solid var(--bd);display:none}
    .banner.err{background:#fff1f2;border-color:#fecaca}
  </style>
</head>
<body>
<header>भारतीय जनता पार्टी — मंदसौर (Face Search)</header>
<main>
  <div class="card">
    <div class="row">
      <div>
        <label>नाम <small>(अनिवार्य)</small></label>
        <input id="name" type="text" placeholder="आपका नाम" autocomplete="name" />
      </div>
      <div>
        <label>मोबाइल नंबर <small>(अनिवार्य)</small></label>
        <input id="phone" type="text" inputmode="numeric" pattern="\\d{10}" maxlength="10" placeholder="मोबाइल" autocomplete="tel-national" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>सेल्फी कैमरा</label>
        <video id="video" autoplay playsinline muted></video>
        <div class="actions">
          <button id="btnSnap" class="btn">सेल्फ़ी लें</button>
          <button id="btnRetake" class="btn ghost">दोबारा लें</button>
        </div>
      </div>
      <div>
        <label>या फ़ाइल चुनें</label>
        <input id="file" type="file" accept="image/*" />
        <div class="actions">
          <button id="btnSearch" class="btn block">Search</button>
        </div>
        <p class="muted">PNG/WebP → JPEG auto. * मोबाइल पर कैमरा अपने‑आप खुलेगा (Allow दें)। फ़ाइल अपलोड की ज़रूरत नहीं।</p>
        <div id="bn" class="banner"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div id="out" class="muted">—</div>
  </div>
</main>

<script>
(() => {
  // ====== CONFIG ======
  const API_BASE = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
  const EVENT_ID = 'demo-2025-01';  // जरूरत हो तो बदलें

  // ====== DOM ======
  const els = {
    name: document.getElementById('name'),
    phone: document.getElementById('phone'),
    file: document.getElementById('file'),
    video: document.getElementById('video'),
    snap: document.getElementById('btnSnap'),
    retake: document.getElementById('btnRetake'),
    btnSearch: document.getElementById('btnSearch'),
    out: document.getElementById('out'),
    bn: document.getElementById('bn')
  };

  function bn(msg, isErr=false){
    els.bn.textContent = msg || '';
    els.bn.style.display = msg ? 'block' : 'none';
    els.bn.classList.toggle('err', !!isErr);
  }

  // ====== CAMERA ======
  let mediaStream = null;
  let selfieBlob = null;

  async function startCamera(){
    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      els.video.srcObject = mediaStream;
    }catch(e){
      bn('कैमरा उपलब्ध नहीं: ' + (e.message || e), true);
    }
  }
  function stopCamera(){
    if(mediaStream){ mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; els.video.srcObject = null; }
  }

  // auto-open on mobile + resume on focus
  document.addEventListener('DOMContentLoaded', () => {
    if(/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){
      setTimeout(startCamera, 350);
    }
  });
  window.addEventListener('focus', () => { if(!mediaStream) startCamera(); });

  // Take selfie
  els.snap.addEventListener('click', async () => {
    try{
      const c = document.createElement('canvas');
      const w = 720, h = Math.round(w * 3/4);
      c.width = w; c.height = h;
      const ctx = c.getContext('2d');
      ctx.drawImage(els.video, 0, 0, w, h);
      const blob = await new Promise(res => c.toBlob(res, 'image/jpeg', 0.9));
      selfieBlob = blob;
      bn('सेल्फ़ी तैयार।');
    }catch(e){
      bn('सेल्फ़ी नहीं ली जा पाई: ' + (e.message || e), true);
    }
  });

  // Retake
  els.retake.addEventListener('click', () => { selfieBlob = null; bn(''); });

  // File picker — keeps a blob ready
  els.file.addEventListener('change', async (e) => {
    const f = e.target.files && e.target.files[0];
    selfieBlob = f || null;
    if (selfieBlob) bn('फ़ाइल चुनी गई।');
  });

  // helper: blob/file → base64 (raw, no data: prefix)
  async function blobToBase64(blob){
    const ab = await blob.arrayBuffer();
    let s = ''; const bytes = new Uint8Array(ab);
    for (let i=0;i<bytes.length;i++) s += String.fromCharCode(bytes[i]);
    return btoa(s);
  }

  // ====== SEARCH ======
  els.btnSearch.addEventListener('click', async () => {
    try{
      bn('');
      const name = (els.name.value || '').trim();
      const phone = (els.phone.value || '').trim();
      if(!name){ bn('कृपया नाम भरें।', true); return; }
      if(!/^\\d{10}$/.test(phone)){ bn('कृपया 10 अंकों का मोबाइल भरें।', true); return; }

      // selfie source: captured blob OR picked file
      if(!selfieBlob){ bn('कृपया पहले सेल्फ़ी लें (या फ़ाइल चुनें)।', true); return; }

      els.btnSearch.disabled = true;

      // IMPORTANT: API expects `imageBase64`
      const imageBase64 = await blobToBase64(selfieBlob);
      const payload = { eventId: EVENT_ID, imageBase64, name, phone };

      const res = await fetch(`${API_BASE}/search`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      let data = null; try{ data = JSON.parse(text); }catch{}

      if(!res.ok){
        console.warn('search 400+ =>', text);
        bn(`सर्च में दिक्कत: API ${res.status}`, true);
        return;
      }

      // open results in new tab without touching existing working code on your current results page
      const html = (data && data.html) ? data.html : JSON.stringify(data || text);
      const win = window.open('', '_blank');
      win.document.write('<pre style="white-space:pre-wrap;font:14px system-ui">'+html.replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]))+'</pre>');
      win.document.close();
      bn('खोज पूर्ण।');
    }catch(e){
      console.error(e);
      bn('त्रुटि: ' + (e.message || e), true);
    }finally{
      els.btnSearch.disabled = false;
    }
  });
})();
</script>
</body>
</html>

<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Face Search</title>
  <style>
    :root{
      --accent:#ff8600;
      --bg:#fff7ef;
      --card:#fff;
      --muted:#666;
      --border:#eee;
      --danger:#b00020;
      --ok:#0a7f2e;
    }
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:var(--bg);}
    .wrap{max-width:1080px;margin-inline:auto;padding:16px;}
    h1{margin:0 0 12px;padding:10px 12px;background:#ff8d0a;color:#111;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    @media(max-width:860px){.grid{grid-template-columns:1fr}}
    .field{display:flex;flex-direction:column;gap:6px}
    input[type="text"], input[type="tel"], input[type="file"]{padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:16px;background:#fff}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
    .camera{position:relative;background:#000;border-radius:12px;overflow:hidden;min-height:260px}
    video{width:100%;height:auto;display:block;background:#000}
    .btn{cursor:pointer;user-select:none;border:none;border-radius:10px;padding:14px 18px;background:var(--accent);color:#111;font-weight:700;font-size:18px}
    .btn:disabled{opacity:.5;pointer-events:none}
    .status{margin-top:8px;padding:10px;border-radius:10px;background:#fff;border:1px solid var(--border);color:#222}
    .status.ok{border-color:#cfe8d7;background:#f3fbf6;color:var(--ok)}
    .status.err{border-color:#ffd6d6;background:#fff3f3;color:var(--danger)}
    /* results */
    .results{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    @media(min-width:960px){.results{grid-template-columns:repeat(3,1fr)}}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .thumbBox{position:relative;height:200px;background:#f7f7f7;display:flex;align-items:center;justify-content:center;color:#999;font-size:14px}
    .thumb{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:10px 12px;color:#333;font-size:14px;border-top:1px dashed #eee}
    .meta small{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .pill{display:inline-block;background:#f3f5ff;border:1px solid #e6eaff;border-radius:999px;padding:4px 10px;font-size:12px;color:#445}
  </style>
</head>
<body>
  <h1>भारतीय जनता पार्टी — मंदसौर (Face Search)</h1>
  <div class="wrap">

    <div class="grid">
      <!-- Left: form + camera -->
      <div class="panel">
        <div class="grid">
          <div class="field">
            <label>नाम (अनिवार्य)</label>
            <input id="name" type="text" placeholder="अपना नाम">
          </div>
          <div class="field">
            <label>मोबाइल नंबर (अनिवार्य)</label>
            <input id="mobile" type="tel" placeholder="10 अंकों का मोबाइल">
          </div>
        </div>

        <div class="field" style="margin-top:10px">
          <label>सेल्फी कैमरा</label>
          <div class="camera" id="camBox">
            <video id="video" muted playsinline></video>
          </div>
          <div class="row">
            <button id="btnStart" class="btn" type="button">कैमरा चालू करें</button>
            <button id="btnSnap" class="btn" type="button">सेल्फी लें</button>
            <button id="btnStop" class="btn" type="button">कैमरा बंद</button>
            <span id="camInfo" class="pill">PNG/WebP → JPEG auto</span>
          </div>
        </div>

        <div class="field" style="margin-top:8px">
          <label>या फ़ाइल चुनें</label>
          <input id="file" type="file" accept="image/*">
        </div>

        <div class="field" style="margin-top:12px">
          <button id="btnSearch" class="btn" type="button">Search</button>
          <div id="msg" class="status" hidden></div>
        </div>
      </div>

      <!-- Right: results -->
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <div><b>मिले फोटो:</b> <span id="count">0</span></div>
          <div class="pill">थंबनेल ऑटो-लोड</div>
        </div>
        <div id="results" class="results" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
// अपने API का बेस URL यहाँ दें (ट्रailing स्लैश न हो)
const API_BASE = (localStorage.getItem('API_BASE')
  || 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2').replace(/\/+$/,'');

// newtab=1 होगा तो नया टैब, वरना इसी पेज में
const urlParams = new URLSearchParams(location.search);
const OPEN_IN_NEW_TAB = urlParams.get('newtab') === '1' ? true : false;

/* ====== Helpers ====== */
const $ = sel => document.querySelector(sel);
const msg = (text, type='info')=>{
  const box = $('#msg');
  box.hidden = false;
  box.className = 'status ' + (type==='err'?'err':type==='ok'?'ok':'');
  box.textContent = text;
};
const clearMsg = ()=>{$('#msg').hidden = true;}

/* ====== Camera ====== */
let stream = null;
const video = $('#video');

async function startCam(){
  try{
    if(stream){return}
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
    video.srcObject = stream;
    await video.play().catch(()=>{}); // iOS safety
  }catch(err){
    console.warn('camera error', err);
    msg('कैमरा नहीं खुला। आप फ़ाइल से भी खोज सकते हैं।', 'err');
  }
}
function stopCam(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
  video.removeAttribute('srcObject');
}

function getCanvasBlobFromVideo(){
  const c = document.createElement('canvas');
  const vw = video.videoWidth || 720;
  const vh = video.videoHeight || 720;
  c.width = 720;
  c.height = Math.round(720*vh/vw);
  const ctx = c.getContext('2d');
  ctx.drawImage(video, 0, 0, c.width, c.height);
  return new Promise(res=>c.toBlob(b=>res(b),'image/jpeg',0.9));
}

/* ====== Network ====== */
async function fetchSmart(url, opts={}){
  const res = await fetch(url, opts);
  if(!res.ok){
    let bodyText = '';
    try{ bodyText = await res.text(); }catch{}
    const err = new Error(`API ${res.status}`);
    err.status = res.status; err.body = bodyText;
    throw err;
  }
  const ct = res.headers.get('content-type')||'';
  if(ct.includes('application/json')) return res.json();
  return res;
}

/* ====== SEARCH ====== */
async function doSearch(){
  clearMsg();
  const name = $('#name').value.trim();
  const mobile = $('#mobile').value.trim();

  if(!name){ msg('कृपया नाम भरें।','err'); return; }
  if(!/^\d{10}$/.test(mobile)){ msg('कृपया 10 अंकों का मोबाइल भरें।','err'); return; }

  // Source: file OR camera
  let imageBase64 = null, s3Bucket = null, s3Key = null;

  const file = $('#file').files?.[0];
  if(file){
    const buf = await file.arrayBuffer();
    imageBase64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
  }else if(stream){
    const blob = await getCanvasBlobFromVideo();
    const buf = await blob.arrayBuffer();
    imageBase64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
  }

  msg('खोज चल रही है…', 'info');
  $('#btnSearch').disabled = true;

  try{
    const payload = { name, mobile, sim: 70 };
    if(imageBase64) payload.imageBase64 = imageBase64;

    // NOTE: बैकएंड 400 करेगा तो नीचे catch में साफ संदेश मिलेगा
    const resp = await fetchSmart(`${API_BASE}/search`, {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(payload),
    });

    // resp.results = [{photoId, s3Key, score}, ...]
    const results = Array.isArray(resp.results)? resp.results : [];
    renderResultsHere(results, {name, mobile});

    msg(`मिले ${results.length} फोटो।`, 'ok');
  }catch(err){
    console.error('search error', err);
    const det = err.body ? `\nडिटेल्स: ${err.body}` : '';
    msg(`सर्व में दिक्कत: API ${err.status||'error'}${det}`, 'err');
  }finally{
    $('#btnSearch').disabled = false;
  }
}

/* ====== RESULTS (Same page) ====== */
function renderResultsHere(items, meta){
  const box = $('#results');
  box.innerHTML = '';
  $('#count').textContent = items.length;

  if(!items.length){
    const div = document.createElement('div');
    div.style.gridColumn = '1 / -1';
    div.className = 'status';
    div.textContent = 'कोई मिलान नहीं मिला।';
    box.appendChild(div);
    return;
  }

  for(const it of items){
    const card = document.createElement('div');
    card.className = 'card';

    const thumbBox = document.createElement('div');
    thumbBox.className = 'thumbBox';
    const img = document.createElement('img');
    img.className = 'thumb';
    img.alt = it.photoId || 'photo';
    img.loading = 'lazy';
    img.decoding = 'async';
    img.crossOrigin = 'anonymous';
    img.referrerPolicy = 'no-referrer';

    // <<<<<<<<<< थंबनेल का असली फिक्स >>>>>>>>>>
    // साइनड इमेज URL (key में / होते हैं, इसलिए encodeURIComponent)
    const key = encodeURIComponent(it.s3Key || '');
    const cacheBust = Date.now();
    const imgUrl = `${API_BASE}/download?key=${key}&t=${cacheBust}`;
    img.src = imgUrl;

    img.onerror = ()=>{
      thumbBox.textContent = 'No preview';
      img.remove();
    };

    thumbBox.appendChild(img);
    card.appendChild(thumbBox);

    const metaDiv = document.createElement('div');
    metaDiv.className = 'meta';
    metaDiv.innerHTML = `
      <div><b>ID:</b> ${it.photoId || '-'}  •  <small>~${Math.round((it.score||0)*100)}%</small></div>
      <div><small>${it.s3Key||''}</small></div>
      <div class="row" style="margin-top:8px">
        <a class="btn" href="${imgUrl}&dl=1" target="_blank" rel="noopener">डाउनलोड</a>
      </div>
    `;
    card.appendChild(metaDiv);

    box.appendChild(card);
  }
}

/* ====== Events ====== */
$('#btnStart').addEventListener('click', startCam);
$('#btnStop').addEventListener('click', stopCam);
$('#btnSnap').addEventListener('click', async ()=>{
  if(!stream){ await startCam(); }
  // सिर्फ़ UI में एक हल्का हरा पल्स दिखाने के लिए
  $('#camBox').style.boxShadow = '0 0 0 3px rgba(16,185,129,.45) inset';
  setTimeout(()=>$('#camBox').style.boxShadow='none', 300);
});
$('#btnSearch').addEventListener('click', doSearch);

// पेज फ़ोकस बदलने पर iOS में abort warn आता है; harmless
window.addEventListener('focus', ()=>{ if(video && video.paused && stream) video.play().catch(()=>{});});
</script>
</body>
</html>

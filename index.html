<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>भारतीय जनता पार्टी — मंदसौर | WedMatch — Selfie Search</title>

  <!-- ZIP download libs -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --brand:#ff8a00; --brand-d:#f27700; --ink:#0f1720; --muted:#667085;
      --bg:#fff9f2; --card:#fff; --bd:#f1e4d4; --sel:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 system-ui,Segoe UI,Roboto,Arial}
    header{background:var(--brand);color:#111;padding:14px 18px;font-weight:800}
    main{max-width:1100px;margin:0 auto;padding:16px}

    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;margin-bottom:14px}
    label{display:block;font-weight:600;margin:6px 0 4px}
    input,select,button{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:10px;background:#fff}
    input:focus{outline:2px solid #ffd7a6;border-color:#ffd7a6}
    .row{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:12px}

    .btn{background:var(--brand);border:none;border-radius:10px;color:#111;font-weight:700;cursor:pointer;padding:12px 14px}
    .btn:hover{background:var(--brand-d)}
    .btn.secondary{background:#111;color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--bd);color:var(--ink)}
    .btn.block{width:100%}

    #video{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;border:1px solid var(--bd)}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .thumb{position:relative;background:#fff;border:1px solid var(--bd);border-radius:12px;overflow:hidden}
    .thumb img{width:100%;height:160px;object-fit:cover;display:block}
    .thumb .cap{padding:8px;font-size:12px;color:var(--muted)}
    .thumb input[type="checkbox"]{position:absolute;top:8px;left:8px;width:18px;height:18px}
    .thumb.sel{outline:2px solid var(--sel);}

    .toolbar{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}

    @media (max-width:720px){
      .grid-2{grid-template-columns:1fr}
      .toolbar{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<header>भारतीय जनता पार्टी — मंदसौर</header>
<main>

  <!-- Search form -->
  <section class="card">
    <div class="row grid-2">
      <div>
        <label>नाम</label>
        <input id="name" placeholder="आपका नाम (optional)">
      </div>
      <div>
        <label>मोबाइल नंबर</label>
        <input id="phone" placeholder="मोबाइल (optional)">
      </div>
    </div>

    <div class="row grid-2" style="margin-top:10px">
      <div>
        <label>सेल्फी कैमरा</label>
        <video id="video" autoplay muted playsinline></video>
        <div class="actions" style="margin-top:8px">
          <button class="btn" id="camOn">कैमरा चालू करें</button>
          <button class="btn ghost" id="snap">फोटो कैप्चर</button>
          <button class="btn secondary" id="camOff">कैमरा बंद</button>
        </div>
      </div>
      <div>
        <label>या फ़ाइल चुनें</label>
        <input id="file" type="file" accept="image/*">
        <div class="muted" style="margin-top:6px">PNG/WebP → JPEG auto.</div>

        <div class="actions" style="margin-top:12px">
          <button class="btn block" id="doSearch">Search</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Results -->
  <section class="card">
    <div class="actions" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="muted" id="msg">—</div>
      <div class="muted"><b id="foundCount">मिले: 0</b></div>
    </div>

    <div class="toolbar" style="margin-bottom:10px">
      <button class="btn ghost" id="btnSelectAll">Select All</button>
      <button class="btn ghost" id="btnClear">Clear</button>
      <button class="btn" id="btnDownload">Download Selected</button>
    </div>

    <div id="grid" class="grid"></div>
  </section>

</main>

<script>
  // ------------ CONFIG ------------
  const API_BASE = localStorage.getItem('apiBase') || '';
  if (!API_BASE) {
    console.warn('API base सेट नहीं है. एक बार यह चलाएँ:\nlocalStorage.setItem("apiBase","https://<api-id>.execute-api.ap-south-1.amazonaws.com/PROD2"); location.reload();');
  }

  // ------------ CAMERA ------------
  const video = document.getElementById('video');
  let stream;

  document.getElementById('camOn').onclick = async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      video.srcObject = stream;
    } catch (e) { alert('कैमरा उपलब्ध नहीं: ' + e.message); }
  };
  document.getElementById('camOff').onclick = () => {
    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; video.srcObject = null; }
  };
  document.getElementById('snap').onclick = () => {
    if (!video.srcObject) { alert('पहले कैमरा चालू करें'); return; }
    const c = document.createElement('canvas'); c.width = video.videoWidth; c.height = video.videoHeight;
    c.getContext('2d').drawImage(video, 0, 0);
    c.toBlob(b => {
      const f = new File([b], 'selfie.jpg', { type: 'image/jpeg' });
      runSearch(f);
    }, 'image/jpeg', 0.92);
  };

  // ------------ SEARCH ------------
  document.getElementById('doSearch').onclick = () => {
    const f = document.getElementById('file').files?.[0];
    if (!f) { alert('कृपया selfie upload करें या कैमरा से कैप्चर करें'); return; }
    runSearch(f);
  };

  async function runSearch(file) {
    setMsg('Searching...');
    clearGrid();

    try {
      const jpeg = await toJpeg(file);
      const imageBase64 = await fileToBase64(jpeg); // raw base64 (data: prefix हटाके)

      const payload = {
        name: (document.getElementById('name').value || '').trim(),
        phone: (document.getElementById('phone').value || '').trim(),
        imageBase64
      };

      const res = await fetch(`${API_BASE}/search`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const txt = await res.text();
      let data; try { data = JSON.parse(txt); } catch { data = { _raw: txt }; }

      if (!res.ok) {
        console.warn('search fail', data);
        setMsg(data?.message || 'Search failed');
        return;
      }

      const matches = data.matches || [];
      if (!matches.length) { setMsg('कोई मैच नहीं मिला'); setFound(0); return; }

      fillGrid(matches);
      setFound(matches.length);
      setMsg('मिले फोटो तैयार हैं');
    } catch (e) {
      console.error(e);
      setMsg('नेटवर्क/प्रोसेस त्रुटि');
    }
  }

  function setMsg(t) { document.getElementById('msg').textContent = t; }
  function setFound(n) { document.getElementById('foundCount').textContent = `मिले: ${n}`; }

  // PNG/WebP → JPEG (downscale)
  async function toJpeg(file, maxDim = 1600, quality = 0.9) {
    if (/jpe?g$/i.test(file.name) && /jpe?g/i.test(file.type)) return file;
    const img = await blobToImage(file);
    const w = img.width, h = img.height; let nw = w, nh = h;
    if (Math.max(w, h) > maxDim) { const k = maxDim / Math.max(w, h); nw = Math.round(w * k); nh = Math.round(h * k); }
    const c = document.createElement('canvas'); c.width = nw; c.height = nh;
    c.getContext('2d').drawImage(img, 0, 0, nw, nh);
    const b = await new Promise(r => c.toBlob(r, 'image/jpeg', quality));
    return new File([b], file.name.replace(/\.\w+$/, '.jpg'), { type: 'image/jpeg' });
  }
  function blobToImage(file) {
    return new Promise((res, rej) => {
      const u = URL.createObjectURL(file), i = new Image();
      i.onload = () => { URL.revokeObjectURL(u); res(i) }; i.onerror = e => { URL.revokeObjectURL(u); rej(e) }; i.src = u;
    });
  }
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => {
        const s = String(fr.result || '');
        const raw = s.includes(',') ? s.split(',')[1] : s;
        resolve(raw);
      };
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }

  // ------------ GRID / SELECT ------------
  const grid = document.getElementById('grid');

  function clearGrid() { grid.innerHTML = ''; setFound(0); }

  function bestImageSrc(m) {
    const key = m.s3Key || m.photoId || m.key || '';
    const direct = m.imageUrl || m.signedUrl || m.url || '';
    if (key) return `${API_BASE}/download?key=${encodeURIComponent(key)}&t=${Date.now()}`; // proxy‑first
    if (direct) return `${direct}${direct.includes('?') ? '&' : '?'}t=${Date.now()}`;
    return '';
  }

  function fillGrid(matches) {
    grid.innerHTML = '';
    matches.forEach((m, idx) => {
      const key = m.s3Key || m.photoId || m.key || '';
      const name = (key.split('/').pop() || m.name || `photo_${idx}`).replace(/\s+/g, '_');

      const card = document.createElement('div');
      card.className = 'thumb';
      card.innerHTML = `
        <input type="checkbox">
        <img loading="lazy" alt="${name}">
        <div class="cap">${name}</div>
      `;

      const img = card.querySelector('img');
      img.crossOrigin = 'anonymous';

      let primary = bestImageSrc(m);
      img.src = primary;

      img.onerror = () => {
        const usedProxy = primary.startsWith(API_BASE + '/download');
        const key2 = m.s3Key || m.photoId || m.key || '';
        const direct2 = m.imageUrl || m.signedUrl || m.url || '';
        if (usedProxy && direct2) {
          primary = `${direct2}${direct2.includes('?') ? '&' : '?'}t=${Date.now()}`; img.src = primary;
        } else if (!usedProxy && key2) {
          primary = `${API_BASE}/download?key=${encodeURIComponent(key2)}&t=${Date.now()}`; img.src = primary;
        } else {
          img.onerror = null;
          img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200">
            <rect width="100%" height="100%" fill="#f3f4f6"/>
            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                  font-family="system-ui" font-size="14" fill="#9ca3af">Preview unavailable</text>
          </svg>`);
        }
      };

      const cb = card.querySelector('input');
      cb.addEventListener('change', () => { card.classList.toggle('sel', cb.checked); });
      card.addEventListener('click', e => {
        if (e.target.tagName !== 'INPUT') { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); }
      });

      grid.appendChild(card);
    });
  }

  // Select/Clear
  document.getElementById('btnSelectAll').onclick = () => {
    [...grid.querySelectorAll('.thumb input[type="checkbox"]')].forEach(cb => {
      if (!cb.checked) { cb.checked = true; cb.dispatchEvent(new Event('change')); }
    });
  };
  document.getElementById('btnClear').onclick = () => {
    [...grid.querySelectorAll('.thumb input[type="checkbox"]')].forEach(cb => {
      if (cb.checked) { cb.checked = false; cb.dispatchEvent(new Event('change')); }
    });
  };

  // ------------ DOWNLOAD SELECTED (ZIP) ------------
  document.getElementById('btnDownload').onclick = async () => {
    const picks = [...grid.querySelectorAll('.thumb')].filter(t => t.querySelector('input').checked);
    if (!picks.length) { alert('कोई फ़ोटो select नहीं है'); return; }

    setMsg('Preparing ZIP…');
    const zip = new JSZip(); let done = 0;

    for (const t of picks) {
      const img = t.querySelector('img');
      const cap = t.querySelector('.cap')?.textContent?.trim() || `photo_${Date.now()}`;
      const fileName = cap.replace(/\.[a-z0-9]+$/i, '') + '.jpg'; // force .jpg

      try {
        const b = await fetch(img.src, { mode: 'cors' }).then(r => r.blob());
        zip.file(fileName, b);
        done++;
        setMsg(`Added ${done}/${picks.length}`);
      } catch (e) {
        console.warn('download fail', e);
      }
    }

    const blob = await zip.generateAsync({ type: 'blob' });
    saveAs(blob, `wedmatch_${new Date().toISOString().slice(0, 10)}.zip`);
    setMsg(`ZIP ready (${picks.length} files)`);
  };
</script>
</body>
</html>

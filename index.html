<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>भारतीय जनता पार्टी — मंदसौर (Face Search)</title>
  <style>
    :root{
      --brand:#ff8a00;
      --brand-dark:#e47600;
      --bg:#fff7ef;
      --panel:#fffaf3;
      --text:#222;
      --muted:#777;
      --danger:#c62828;
      --ok:#0b8457;
      --card:#ffffff;
      --shadow:0 2px 6px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:var(--bg);
    }
    header{
      position:sticky;top:0;z-index:40;
      background:var(--brand);
      color:#fff;
      padding:10px 16px;
      font-weight:700;
      box-shadow:var(--shadow);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px;}
    .card{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;}
    .grid-2{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width:860px){.grid-2{grid-template-columns:1fr}}
    label{font-size:14px;font-weight:700;margin-bottom:6px;display:block}
    input[type="text"],input[type="tel"]{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid #ddd;background:#fff;
      font-size:16px;outline:none;
    }
    input[type="text"]:focus,input[type="tel"]:focus{border-color:var(--brand)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:680px){.row{grid-template-columns:1fr}}
    .video-box{
      background:#000;border-radius:12px;overflow:hidden;position:relative;
      display:flex;align-items:center;justify-content:center;height:min(62vw,440px);
    }
    video{width:100%;height:100%;object-fit:cover}
    .btn{
      appearance:none;border:none;border-radius:12px;padding:12px 18px;font-weight:700;
      cursor:pointer;box-shadow:var(--shadow);background:var(--brand);color:#fff;font-size:16px;
    }
    .btn:hover{background:var(--brand-dark)}
    .btn.secondary{background:#111}
    .btn.link{background:transparent;color:var(--brand);box-shadow:none;padding:0}
    .hint{font-size:13px;color:var(--muted)}
    .error{background:#fdeaea;border:1px solid #f2b5b5;color:var(--danger);padding:10px 12px;border-radius:10px}
    .ok{color:var(--ok);font-weight:700}
    .controls{display:flex;gap:12px;flex-wrap:wrap}
    .thumb-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(min-width:520px){.thumb-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media(min-width:840px){.thumb-grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .thumb a{display:block;background:var(--card);border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
    .thumb img{display:block;width:100%;height:220px;object-fit:cover;background:#eee}
    .status{margin-top:8px;font-size:13px;color:var(--muted)}
    .note{margin-top:8px;font-size:13px;color:#333}
    .hidden{display:none !important}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef7f1;color:#0b8457;font-size:12px;font-weight:700}
    .footer-bar{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-top:10px}
    .pager{display:flex;gap:8px;align-items:center}
    .pager .btn{padding:8px 12px}
  </style>
</head>
<body>
  <header>भारतीय जनता पार्टी — मंदसौर (Face Search)</header>
  <div class="wrap">
    <div class="card">
      <div class="grid-2">
        <div>
          <div class="row">
            <div>
              <label>नाम (अनिवार्य)</label>
              <input id="name" type="text" placeholder="आपका नाम" autocomplete="name" required />
            </div>
            <div>
              <label>मोबाइल नंबर (अनिवार्य)</label>
              <input id="phone" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="10" placeholder="10 अंकों का मोबाइल" autocomplete="tel" required />
            </div>
          </div>

          <div style="margin-top:14px">
            <label>सेल्फी कैमरा</label>
            <div class="video-box">
              <video id="video" playsinline muted></video>
            </div>
            <div class="controls" style="margin-top:10px">
              <button id="btnSnap" class="btn">सेल्फी लें</button>
              <button id="btnRetake" class="btn secondary">दोबारा लें</button>
              <span id="selfieReady" class="pill hidden">सेल्फ़ी तैयार ✓</span>
            </div>
          </div>
        </div>

        <div>
          <div class="file-row">
            <label>या फ़ाइल चुनें</label>
            <input id="file" type="file" accept="image/*" />
          </div>

          <div style="margin-top:14px">
            <button id="btnSearch" class="btn" style="width:100%">Search</button>
          </div>

          <p class="hint" style="margin-top:10px">PNG/WebP → JPEG auto. * मोबाइल पर कैमरा अपने‑आप खुलेगा (Allow दें)। फ़ाइल अपलोड की ज़रूरत नहीं।</p>

          <div id="msg" class="error hidden" style="margin-top:10px"></div>
          <div id="note" class="note"></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="footer-bar">
        <div class="status" id="status">—</div>
        <div class="pager">
          <button class="btn" id="prevBtn">Prev</button>
          <button class="btn" id="nextBtn">Next</button>
        </div>
      </div>
      <div id="grid" class="thumb-grid" style="margin-top:12px"></div>
    </div>
  </div>

  <canvas id="canvas" class="hidden"></canvas>

<script>
/* ====== Config (बदलना हो तो सिर्फ यहाँ) ====== */
const API_BASE  = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
// default Event (query ?e=EVENT से ओवरराइड कर सकते हैं)
const qs = new URLSearchParams(location.search);
const EVENT_ID = qs.get('e') || 'demo-2025-01';
const JPEG_QUALITY = .85;
const PAGE_SIZE = 12; // फ्रंट-एंड pagination

/* ====== Helpers ====== */
const els = {
  video: document.getElementById('video'),
  canvas: document.getElementById('canvas'),
  file: document.getElementById('file'),
  btnSnap: document.getElementById('btnSnap'),
  btnRetake: document.getElementById('btnRetake'),
  btnSearch: document.getElementById('btnSearch'),
  selfieReady: document.getElementById('selfieReady'),
  name: document.getElementById('name'),
  phone: document.getElementById('phone'),
  msg: document.getElementById('msg'),
  grid: document.getElementById('grid'),
  status: document.getElementById('status'),
  note: document.getElementById('note'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
};

const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
if (isMobile) document.querySelector('.file-row')?.classList.add('hidden'); // मोबाइल पर file input छुपाएँ

function setStatus(t){ els.status.textContent = t || '—'; }
function setAlert(t){ els.msg.textContent = t; els.msg.classList.remove('hidden'); }
function clearAlert(){ els.msg.textContent=''; els.msg.classList.add('hidden'); }
function bn(t){ els.note.textContent = t || ''; }

/* ====== Camera ====== */
let stream = null;
let selfieBlob = null; // captured jpeg
async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio:false });
    els.video.srcObject = stream;
    els.video.play().catch(()=>{});
    bn('कैमरा चालू।');
  }catch(err){
    console.warn('camera error', err);
    bn('कैमरा अनुमति न मिलने पर आप फ़ाइल चुनकर भी खोज सकते हैं।');
  }
}
function stopCamera(){
  try{ stream?.getTracks()?.forEach(t=>t.stop()); }catch{}
  els.video.srcObject = null;
}

function snap(){
  const v = els.video;
  if (!v.videoWidth) { setAlert('कैमरा तैयार नहीं है।'); return; }
  const c = els.canvas;
  const W = Math.min(1024, v.videoWidth);
  const H = Math.round((v.videoHeight / v.videoWidth) * W);
  c.width=W; c.height=H;
  const ctx=c.getContext('2d');
  ctx.drawImage(v,0,0,W,H);
  return new Promise(res => c.toBlob(b=>res(b),'image/jpeg',JPEG_QUALITY));
}

/* ====== Keys extraction/render (robust) ====== */
function parseKeyFromAnything(x){
  if(!x) return null;
  if(typeof x === 'string'){
    if(/amazonaws\.com\//i.test(x)){
      const m = x.match(/amazonaws\.com\/(.+)$/i);
      return m ? m[1] : x;
    }
    return x;
  }
  if(typeof x === 'object'){
    const cand = x.s3Key || x.key || x.S3Key || x.s3key || x.objectKey || x.path || x.url || x.URL;
    return parseKeyFromAnything(cand || '');
  }
  return null;
}
function extractKeys(data){
  if(Array.isArray(data)) return data.map(parseKeyFromAnything).filter(Boolean);
  const pools = [data?.items, data?.keys, data?.results, data?.matches, data?.photos, data?.data];
  for(const arr of pools){ if(Array.isArray(arr)) return arr.map(parseKeyFromAnything).filter(Boolean); }
  return [];
}
function render(keys, append=false){
  if(!append) els.grid.innerHTML='';
  const clean = (keys||[]).map(parseKeyFromAnything).filter(Boolean);
  if(!clean.length){ if(!append) setStatus('कोई फोटो नहीं मिली।'); return; }
  const frag = document.createDocumentFragment();
  for(const key of clean){
    const href = `${API_BASE}/download?key=${encodeURIComponent(key)}&ts=${Date.now()}`;
    const a = document.createElement('a');
    a.href = href; a.target='_blank'; a.rel='noopener';
    const d = document.createElement('div'); d.className='thumb';
    const img = document.createElement('img'); img.loading='lazy'; img.decoding='async';
    img.alt = (String(key).split('/').pop()) || 'photo'; img.src = href;
    d.appendChild(img); a.appendChild(d); frag.appendChild(a);
  }
  els.grid.appendChild(frag);
  setStatus(`मिले: ${els.grid.querySelectorAll('img').length} फ़ोटो`);
  clearAlert(); bn('');
}

/* ====== Client-side pagination ====== */
let allKeys = [];
let page = 0;
function showPage(p=0){
  page = Math.max(0, Math.min(p, Math.floor((allKeys.length-1)/PAGE_SIZE)));
  const slice = allKeys.slice(page*PAGE_SIZE, (page+1)*PAGE_SIZE);
  render(slice, false);
  els.prevBtn.disabled = (page===0);
  els.nextBtn.disabled = ((page+1)*PAGE_SIZE >= allKeys.length);
}

/* ====== Call /search ====== */
async function searchWithImage(imageBlob){
  clearAlert(); setStatus('खोज जारी…');
  const name = els.name.value.trim();
  const phone = (els.phone.value||'').replace(/\D+/g,'');
  if(!name){ setAlert('कृपया नाम भरें।'); return; }
  if(!/^\d{10}$/.test(phone)){ setAlert('कृपया 10 अंकों का मोबाइल भरें।'); return; }

  // फोटो बाइट्स → base64
  let b64 = '';
  if(imageBlob){
    b64 = await new Promise((resolve)=>{
      const r = new FileReader();
      r.onload = () => resolve(String(r.result).split(',')[1] || '');
      r.readAsDataURL(imageBlob);
    });
  }

  const payload = {
    eventId: EVENT_ID,
    image: b64,            // selfie base64 (खाली होने पर भी backend को चले)
    name, phone
  };

  try{
    const res = await fetch(`${API_BASE}/search`, {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(payload)
    });
    const json = await res.json().catch(()=>({}));
    if(!res.ok){
      console.error('search error', res.status, json);
      setAlert(`सर्च में दिक्कत: API ${res.status}`);
      return;
    }
    // Collect keys
    allKeys = extractKeys(json);
    if (!Array.isArray(allKeys) || allKeys.length===0) {
      setStatus('कोई फोटो नहीं मिली।');
      els.grid.innerHTML='';
      return;
    }
    showPage(0);
  }catch(err){
    console.error(err);
    setAlert('नेटवर्क/ब्राउज़र एरर। बाद में फिर प्रयास करें।');
  }
}

/* ====== UI wire ====== */
els.btnSnap.addEventListener('click', async () => {
  const blob = await snap();
  if(blob){
    selfieBlob = blob;
    els.selfieReady.classList.remove('hidden');
    bn('सेल्फी सेव हो गई। Search दबाएँ।');
  }
});

els.btnRetake.addEventListener('click', () => {
  selfieBlob=null;
  els.selfieReady.classList.add('hidden');
  bn('नयी सेल्फी लें।');
});

els.file.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(f){
    // ensure JPEG
    const img = await f.arrayBuffer();
    const b = new Blob([img], {type:f.type || 'image/*'});
    // draw to canvas -> jpeg
    const imgEl = new Image();
    imgEl.onload = async () => {
      const c = els.canvas;
      const max = 1024;
      let w = imgEl.width, h = imgEl.height;
      if (w > max) { h = Math.round(h * (max / w)); w = max; }
      c.width = w; c.height = h;
      const ctx = c.getContext('2d');
      ctx.drawImage(imgEl, 0, 0, w, h);
      c.toBlob((jb)=>{ selfieBlob = jb; els.selfieReady.classList.remove('hidden'); }, 'image/jpeg', JPEG_QUALITY);
    };
    imgEl.src = URL.createObjectURL(b);
  }
});

els.btnSearch.addEventListener('click', () => searchWithImage(selfieBlob));

els.prevBtn.addEventListener('click', ()=> showPage(page-1));
els.nextBtn.addEventListener('click', ()=> showPage(page+1));

/* ====== Auto start camera ====== */
window.addEventListener('load', startCamera);
window.addEventListener('focus', ()=>{ if(!els.video.srcObject) startCamera(); });
window.addEventListener('beforeunload', stopCamera);
</script>
</body>
</html>

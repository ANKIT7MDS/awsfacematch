<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>WedMatch – सेल्फी सर्च</title>
<style>
:root{
  --brand:#ff8800;
  --brand-d:#d86e00;
  --ink:#111;
  --muted:#666;
  --bg:#fff7ef;
  --card:#fff;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header{background:var(--brand);color:#fff;padding:14px 16px;font-weight:700}
.container{max-width:1100px;margin:14px auto;padding:0 12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:820px){.row{grid-template-columns:1fr}}
.card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 4px 14px rgba(0,0,0,.06)}
label{font-weight:700;display:block;margin:6px 0}
input[type="text"],input[type="tel"]{width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;background:#fff}
small{color:var(--muted)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;border:0;background:var(--brand);color:#fff;font-weight:800;cursor:pointer}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.secondary{background:#111}
.btn.ghost{background:#fff;border:1px solid #ddd;color:#111}
.btn.block{width:100%}
.toolbar{display:flex;gap:10px;flex-wrap:wrap}
video{width:100%;max-height:340px;background:#000;border-radius:12px}
#capturePreview{width:100%;border-radius:12px;display:none}
.notice{padding:10px 12px;border-radius:10px;background:#fff;box-shadow:inset 0 0 0 1px #eee;color:#111}
.notice.bad{background:#fff2f2;color:#a40000}
.grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
@media(max-width:1000px){.grid{grid-template-columns:repeat(4,1fr)}}
@media(max-width:780px){.grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:560px){.grid{grid-template-columns:repeat(2,1fr)}}
.thumb{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.05);overflow:hidden}
.thumb img{width:100%;display:block}
.meta{font-size:12px;padding:6px 8px;color:#444;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.footerbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:10px}
hr.sep{border:0;border-top:1px solid #eee;margin:14px 0}
/* File input मोबाइल पर छुपा दें */
@media(max-width:820px){
  .fileRow{display:none}
}
/* Simple modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:50}
.modal.show{display:flex}
.modal .sheet{background:#111;color:#fff;border-radius:16px;padding:14px;max-width:420px;width:92%}
.modal img{width:100%;border-radius:12px;background:#000}
.modal .rowbtn{display:flex;gap:10px;margin-top:10px}
a.link{color:var(--brand-d);text-decoration:none}
</style>
</head>
<body>
<header>भारतीय जनता पार्टी — मंदसौर (Face Search)</header>
<main class="container">

  <div class="card">
    <div class="row">
      <div>
        <label>नाम <small>(अनिवार्य)</small></label>
        <input id="name" type="text" placeholder="अपका नाम" required>
      </div>
      <div>
        <label>मोबाइल नंबर <small>(अनिवार्य)</small></label>
        <input id="phone" type="tel" inputmode="numeric" pattern="\\d{10}" placeholder="10 अंकों का मोबाइल" required>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <label>सेल्फी कैमरा</label>
        <video id="video" autoplay playsinline muted></video>
        <img id="capturePreview" alt="Preview"/>
        <div class="toolbar" style="margin-top:10px">
          <button id="btnSnap" class="btn"><span>सेल्फी लें</span></button>
          <button id="btnRetake" class="btn ghost" style="display:none">दोबारा लें</button>
        </div>
        <div id="camMsg" class="notice" style="margin-top:10px;display:none"></div>
      </div>

      <div>
        <div class="fileRow">
          <label>या फ़ाइल चुनें</label>
          <input id="file" type="file" accept="image/*"/>
          <small>PNG/WebP → JPEG auto.</small>
        </div>
        <div style="margin-top:12px">
          <button id="btnSearch" class="btn block">Search</button>
        </div>
        <div class="notice" style="margin-top:10px">
          * मोबाइल पर कैमरा अपने-आप खुलेगा (Allow दें)। फ़ाइल अपलोड की ज़रूरत नहीं।
        </div>
      </div>
    </div>
  </div>

  <div id="resultsCard" class="card" style="margin-top:12px; display:none">
    <div class="footerbar">
      <div><strong>मिले फ़ोटो</strong></div>
      <div class="toolbar">
        <button class="btn ghost" id="btnNewTab">नयी विंडो में खोलें</button>
        <button class="btn" id="btnNext" style="display:none">Next</button>
      </div>
    </div>
    <div id="grid" class="grid" style="margin-top:10px"></div>
  </div>

  <div id="err" class="notice bad" style="display:none;margin-top:12px"></div>

</main>

<!-- Confirm modal -->
<div id="confirmModal" class="modal">
  <div class="sheet">
    <div style="font-weight:700;margin-bottom:6px">सेल्फी की पुष्टि</div>
    <img id="confirmImg" alt="Selfie preview"/>
    <div class="rowbtn">
      <button class="btn ghost" id="mRetake">Retake</button>
      <button class="btn" id="mUse">Use this</button>
    </div>
  </div>
</div>

<script>
(function(){
  const API_BASE = "https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2";
  const EVENT_ID = "demo-2025-01"; // चाहें तो इसे बदलें
  const OPEN_IN_NEW_TAB = true;     // नई विंडो में गैलरी खोलने का विकल्प

  const els = {
    v: $('#video'),
    prev: $('#capturePreview'),
    btnSnap: $('#btnSnap'),
    btnRetake: $('#btnRetake'),
    name: $('#name'),
    phone: $('#phone'),
    file: $('#file'),
    btnSearch: $('#btnSearch'),
    grid: $('#grid'),
    resultsCard: $('#resultsCard'),
    btnNext: $('#btnNext'),
    btnNewTab: $('#btnNewTab'),
    err: $('#err'),
    camMsg: $('#camMsg'),
    modal: $('#confirmModal'),
    mImg: $('#confirmImg'),
    mUse: $('#mUse'),
    mRetake: $('#mRetake')
  };

  let mediaStream = null;
  let selfieFile = null;
  let searchState = { nextToken: null, lastPayload: null, items: [] };

  // ---------- tiny helpers ----------
  function $(sel){ return document.querySelector(sel); }
  function show(el, v=true){ el.style.display = v ? '' : 'none'; }
  function banner(msg, bad=false){
    els.err.textContent = msg;
    els.err.style.display = msg ? '' : 'none';
    els.err.className = 'notice' + (bad ? ' bad' : '');
  }
  function camBanner(msg){ els.camMsg.textContent = msg; show(els.camMsg, !!msg); }

  // ---------- camera ----------
  async function getStream(constraints){
    const g = (c)=>{
      if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) return navigator.mediaDevices.getUserMedia(c);
      const legacy = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
      return new Promise((res,rej)=>{
        if(!legacy) return rej(new Error('getUserMedia not supported'));
        legacy.call(navigator,c,res,rej);
      });
    };
    try{
      return await g(constraints);
    }catch(e){
      return null;
    }
  }

  async function startCamera(){
    if (mediaStream) return mediaStream;
    camBanner('कैमरा खोल रहे हैं… कृपया Allow दें');
    // first try user-facing
    let st = await getStream({video:{facingMode:'user'}, audio:false});
    if(!st) st = await getStream({video:true,audio:false});
    if(!st){
      camBanner('कैमरा नहीं खुल पाया। ब्राउज़र सेटिंग्स से Camera: Allow करें।');
      return null;
    }
    mediaStream = st;
    els.v.srcObject = st;
    await els.v.play().catch(()=>{});
    camBanner('कैमरा चालू हो गया।');
    return st;
  }

  async function stopCamera(){
    if(mediaStream){
      mediaStream.getTracks().forEach(t=>t.stop());
      mediaStream = null;
    }
    els.v.srcObject = null;
  }

  function blobToFile(blob, name='selfie.jpg'){ return new File([blob], name, {type:'image/jpeg'}); }

  function snapToBlob(){
    const w = els.v.videoWidth || 640;
    const h = els.v.videoHeight || 480;
    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    const ctx = c.getContext('2d'); ctx.drawImage(els.v, 0, 0, w, h);
    return new Promise(res=> c.toBlob(b=> res(b), 'image/jpeg', 0.9));
  }

  // ---------- UI handlers ----------
  els.btnSnap.addEventListener('click', async (e)=>{
    e.preventDefault();
    try{
      if(!mediaStream) await startCamera();
      const blob = await snapToBlob();
      els.prev.src = URL.createObjectURL(blob);
      show(els.prev, true);
      els.mImg.src = els.prev.src;
      show(els.modal, true);
      selfieFile = blobToFile(blob);
      show(els.btnRetake, true);
    }catch(err){
      banner('सेल्फी नहीं ले पाए: ' + (err && err.message ? err.message : err), true);
    }
  });

  els.btnRetake.addEventListener('click', async ()=>{
    show(els.modal,false);
    show(els.prev,false);
    selfieFile = null;
    await startCamera();
  });

  // modal
  els.mUse.addEventListener('click', ()=> show(els.modal,false));
  els.mRetake.addEventListener('click', ()=> els.btnRetake.click());

  // file fallback (desktop)
  els.file.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    // show preview
    els.prev.src = URL.createObjectURL(f);
    show(els.prev, true);
    selfieFile = f;
  });

  // ---------- search ----------
  async function fileToBase64(f){
    const buf = await f.arrayBuffer();
    let binary=''; const bytes = new Uint8Array(buf);
    for (let i=0;i<bytes.length;i++) binary += String.fromCharCode(bytes[i]);
    return btoa(binary);
  }

  async function runSearch(nextToken=null){
    banner('');
    // validations
    const name = els.name.value.trim();
    const phone = els.phone.value.trim();
    if(!name){ banner('कृपया नाम भरें।', true); return; }
    if(!/^\d{10}$/.test(phone)){ banner('कृपया 10 अंकों का मोबाइल भरें।', true); return; }
    if(!selfieFile){ banner('कृपया पहले सेल्फी लें।', true); return; }

    // payload
    const base64 = await fileToBase64(selfieFile);
    const payload = { eventId: EVENT_ID, selfie: base64, name, phone, nextToken };
    searchState.lastPayload = payload;

    try{
      els.btnSearch.disabled = true;
      camBanner('');
      const r = await fetch(API_BASE + '/search', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!r.ok){ throw new Error('API ' + r.status); }
      const data = await r.json();

      const items = (data.items || data.matches || []).map(x => (x.s3Key || x.key || x.s3key || x.path || x));
      searchState.items = nextToken ? searchState.items.concat(items) : items;
      searchState.nextToken = data.nextToken || data.next || null;

      renderResults(items, !!nextToken);
      show(els.btnNext, !!searchState.nextToken);
      show(els.resultsCard, true);

      if (OPEN_IN_NEW_TAB) {
        // नयी टैब में भी खोल दें (optional)
        openInNewTab(items);
      }
    }catch(err){
      banner('सर्च में दिक्कत: ' + (err && err.message ? err.message : err), true);
    }finally{
      els.btnSearch.disabled = false;
    }
  }

  function thumbUrl(key){ return API_BASE + '/download?key=' + encodeURIComponent(key); }

  function renderResults(items, append){
    if(!append) els.grid.innerHTML='';
    for(const key of items){
      const div = document.createElement('div');
      div.className='thumb';
      div.innerHTML = '<img loading="lazy" alt="" src="'+ thumbUrl(key) +'"/><div class="meta">'+ key.split('/').pop() +'</div>';
      els.grid.appendChild(div);
    }
  }

  function openInNewTab(items){
    const w = window.open('', '_blank');
    if(!w) return;
    const imgs = items.map(k => `<a href="${thumbUrl(k)}" target="_blank"><img style="width:100%;max-width:520px;border-radius:12px;margin:8px auto;display:block" src="${thumbUrl(k)}"/></a>`).join('');
    w.document.write(`<!doctype html><meta name="viewport" content="width=device-width,initial-scale=1"><title>Results</title>
      <body style="font-family:system-ui;background:#111;color:#fff"><div style="max-width:820px;margin:10px auto;padding:8px">${imgs}</div></body>`);
    w.document.close();
  }

  els.btnSearch.addEventListener('click', e=>{ e.preventDefault(); runSearch(); });
  els.btnNext.addEventListener('click', e=>{ e.preventDefault(); if(searchState.nextToken) runSearch(searchState.nextToken); });
  els.btnNewTab.addEventListener('click', e=>{ e.preventDefault(); openInNewTab(searchState.items || []); });

  // ---------- boot ----------
  // मोबाइल पर तुरंत कैमरा ट्राय करें (HTTPS + Allow पॉपअप)
  document.addEventListener('DOMContentLoaded', async ()=>{
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    if(isMobile){
      // हल्का सा डिले, कुछ ब्राउज़र में ज़रूरी
      setTimeout(()=> startCamera(), 350);
    }
  });
  // टैब पर वापस आने पर अगर स्ट्रीम बंद है तो दोबारा
  window.addEventListener('focus', ()=> { if(!mediaStream) startCamera(); });

})();
</script>
</body>
</html>

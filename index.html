<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>भारतीय जनता पार्टी — मंदसौर (Face Search)</title>
<style>
  :root{
    --brand:#ff8a00;
    --dark:#222;
    --muted:#777;
    --bg:#fff7ef;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;color:#222}
  header{background:var(--brand);color:#111;padding:10px 16px;font-weight:700}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media(max-width:900px){.row{grid-template-columns:1fr}}
  .card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:16px}
  label{font-size:14px;color:#444;margin-bottom:6px;display:block}
  input[type=text], input[type=tel]{width:100%;padding:12px 14px;border:1px solid #ddd;border-radius:10px;font-size:16px;background:#fff}
  .hint{font-size:12px;color:#666;margin-top:8px}
  .btn{background:var(--brand);border:none;color:#111;font-weight:700;padding:12px 18px;border-radius:12px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.dark{background:#111;color:#fff}
  .btn.ghost{background:#eee}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .video, .canvas{width:100%;border-radius:12px;background:#000;max-height:60vh;object-fit:cover}
  .err{background:#ffe3e3;color:#8a0000;padding:10px 12px;border-radius:10px}
  .ok{background:#e9ffe9;color:#065e06;padding:8px 10px;border-radius:10px;display:inline-flex;gap:6px;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:14px;margin-top:8px}
  .thumb{border:1px solid #eee;border-radius:12px;overflow:hidden;background:#fafafa}
  .thumb img{width:100%;display:block}
  .thumb .meta{padding:6px 8px;font-size:12px;color:#666;display:flex;justify-content:space-between;align-items:center}
  .pill{font-size:12px;background:#111;color:#fff;border-radius:999px;padding:3px 8px}
  .right{text-align:right}
  .center{text-align:center}
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt24{margin-top:24px}
  .footer{padding:10px 0;color:#777;font-size:12px;text-align:center}
  .pagination{display:flex;gap:8px;justify-content:center;margin-top:10px}
</style>
</head>
<body>
<header>भारतीय जनता पार्टी — मंदसौर (Face Search)</header>
<div class="wrap">

  <div class="row">
    <div class="card">
      <label>नाम (अनिवार्य)</label>
      <input id="name" type="text" placeholder="अपका नाम">
      <div class="mt12"></div>
      <label>मोबाइल नंबर (अनिवार्य)</label>
      <input id="phone" inputmode="numeric" maxlength="10" pattern="[0-9]{10}" type="tel" placeholder="10 अंकों का मोबाइल">
      <div class="mt16"></div>
      <label>सेल्फी कैमरा</label>
      <video id="video" class="video" playsinline autoplay muted></video>
      <canvas id="canvas" class="canvas" hidden></canvas>
      <div class="toolbar mt12">
        <button id="btnSnap" class="btn">सेल्फ़ी लें</button>
        <button id="btnRetake" class="btn ghost" disabled>दोबारा लें</button>
        <span id="selfieStatus" class="ok" hidden>सेल्फ़ी तैयार ✓</span>
      </div>
      <div class="hint">PNG/WebP → JPEG auto. * मोबाइल पर कैमरा अपने-आप खुलेगा (Allow दें)। फ़ाइल अपलोड की ज़रूरत नहीं।</div>
    </div>

    <div class="card">
      <label>या फ़ाइल चुनें</label>
      <input id="file" type="file" accept="image/*">
      <div class="mt12">
        <button id="btnSearch" class="btn" style="width:260px">Search</button>
      </div>
      <div id="msg" class="mt12"></div>
      <div id="note" class="hint mt12">कृपया 10 अंकों का मोबाइल भरें।</div>
    </div>
  </div>

  <div class="card mt16">
    <div class="toolbar">
      <strong>मिले: <span id="count">0</span> फोटो</strong>
    </div>
    <div id="grid" class="grid"></div>
    <div class="pagination">
      <button id="prev" class="btn ghost" disabled>Prev</button>
      <button id="next" class="btn ghost" disabled>Next</button>
    </div>
  </div>

  <div class="footer">Powered by WedMatch</div>
</div>

<script>
(() => {
  // ===== Config =====
  const API_BASE = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
  const qs = new URLSearchParams(location.search);
  const EVENT_ID = qs.get('e') || 'demo-2025-01';
  const MAX_SIDE = 720;             // selfie resize
  const JPEG_QUALITY = 0.85;

  // ===== Elements =====
  const $ = sel => document.querySelector(sel);
  const video = $('#video');
  const canvas = $('#canvas');
  const file = $('#file');
  const nameEl = $('#name');
  const phoneEl = $('#phone');
  const btnSnap = $('#btnSnap');
  const btnRetake = $('#btnRetake');
  const btnSearch = $('#btnSearch');
  const msg = $('#msg');
  const grid = $('#grid');
  const countEl = $('#count');
  const selfieStatus = $('#selfieStatus');
  const prevBtn = $('#prev');
  const nextBtn = $('#next');

  let selfieDataUrl = ''; // data:image/jpeg;base64,...
  let results = [];
  let page = 0, pageSize = 10;

  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  // Hide file input on mobile
  if (isMobile) file.style.display = 'none';

  // ===== Camera =====
  async function openCamera(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'user' , width: {ideal: 1280}, height: {ideal: 720}},
        audio: false
      });
      video.srcObject = stream;
      video.play().catch(()=>{});
    }catch(err){
      console.warn('camera error', err);
      showErr('कैमरा नहीं खुला। कृपया अनुमति दें या फ़ाइल चुने।');
    }
  }
  if (location.protocol === 'https:' || location.hostname === 'localhost'){
    openCamera();
    // Safari focus fix
    window.addEventListener('focus', () => {
      if (video && !video.srcObject) openCamera();
    });
  }

  function showErr(text){
    msg.className = 'err';
    msg.textContent = text;
  }
  function showOk(text){
    msg.className = 'ok';
    msg.textContent = text;
  }

  // Resize + to JPEG DataURL
  function toJpegDataUrl(imgOrVideo){
    const w = imgOrVideo.videoWidth || imgOrVideo.naturalWidth || imgOrVideo.width;
    const h = imgOrVideo.videoHeight || imgOrVideo.naturalHeight || imgOrVideo.height;
    if (!w || !h) return '';
    let nw = w, nh = h;
    if (Math.max(w,h) > MAX_SIDE){
      const r = MAX_SIDE / Math.max(w,h);
      nw = Math.round(w * r);
      nh = Math.round(h * r);
    }
    canvas.width = nw; canvas.height = nh;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(imgOrVideo, 0, 0, nw, nh);
    return canvas.toDataURL('image/jpeg', JPEG_QUALITY);
  }

  btnSnap.addEventListener('click', () => {
    selfieDataUrl = toJpegDataUrl(video);
    if (!selfieDataUrl){ showErr('सेल्फ़ी कैप्चर नहीं हो सकी।'); return; }
    selfieStatus.hidden = false;
    btnRetake.disabled = false;
    showOk('सेल्फ़ी सेव हो गई। Search दबाएँ।');
  });

  btnRetake.addEventListener('click', () => {
    selfieDataUrl = '';
    selfieStatus.hidden = true;
    btnRetake.disabled = true;
    showOk('फिर से सेल्फ़ी लें।');
  });

  file.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    const img = new Image();
    img.onload = () => {
      selfieDataUrl = toJpegDataUrl(img);
      selfieStatus.hidden = false;
      btnRetake.disabled = false;
      showOk('फ़ाइल से सेल्फ़ी सेट हो गई।');
    };
    img.onerror = () => showErr('फ़ाइल पढ़ने में समस्या।');
    img.src = URL.createObjectURL(f);
  });

  function valid(){
    const name = nameEl.value.trim();
    const phone = phoneEl.value.trim();
    if (!name){ showErr('कृपया नाम भरें।'); return false; }
    if (!/^[0-9]{10}$/.test(phone)){ showErr('कृपया 10 अंकों का मोबाइल भरें।'); return false; }
    if (!selfieDataUrl){ showErr('कृपया सेल्फ़ी लें।'); return false; }
    return true;
  }

  // Helper to safely parse JSON
  async function parseMaybeJson(resp){
    const txt = await resp.text();
    try{ return {json: JSON.parse(txt), raw: txt}; }catch{ return {json: null, raw: txt}; }
  }

  btnSearch.addEventListener('click', async () => {
    if (!valid()) return;
    try{
      btnSearch.disabled = true;
      showOk('खोज जारी…');
      const b64 = selfieDataUrl.split(',')[1]; // strip data:image/jpeg;base64,
      // Build payload (send multiple key names for compatibility)
      const payload = {
        eventId: EVENT_ID,
        selfie: b64,
        image: b64,
        jpegB64: b64,
        name: nameEl.value.trim(),
        phone: phoneEl.value.trim()
      };
      // Debug: log size
      console.log('selfie bytes ~', Math.round((b64.length * 3) / 4));

      const resp = await fetch(`${API_BASE}/search`, {
        method: 'POST',
        headers: {'content-type':'application/json','x-client':'wedmatch-ui'},
        body: JSON.stringify(payload)
      });
      const {json, raw} = await parseMaybeJson(resp);
      if (!resp.ok){
        console.error('search error', resp.status, json||raw);
        showErr(`सर्च में दिक्कत: API ${resp.status}`);
        btnSearch.disabled = false;
        return;
      }
      // Normalize results
      const keys = (json?.keys) || (json?.results) || (json?.matches?.map(m => m.s3Key)) || [];
      results = keys || [];
      page = 0;
      render();
      showOk(`मिले ${results.length} फोटो`);
      btnSearch.disabled = false;
    }catch(err){
      console.error(err);
      showErr('नेटवर्क/ब्राउज़र एरर। बाद में फिर प्रयास करें।');
      btnSearch.disabled = false;
    }
  });

  function pageSlice(){
    const start = page * pageSize;
    const end = start + pageSize;
    return results.slice(start, end);
  }

  function render(){
    countEl.textContent = results.length;
    grid.innerHTML = '';
    const pageItems = pageSlice();
    pageItems.forEach(key => {
      const url = `${API_BASE}/download?key=${encodeURIComponent(key)}`;
      const card = document.createElement('div');
      card.className = 'thumb';
      card.innerHTML = `
        <a href="${url}" target="_blank" rel="noopener">
          <img loading="lazy" src="${url}" alt="photo">
        </a>
        <div class="meta">
          <span class="pill">OPEN</span>
          <span class="right" title="${key}">${key.split('/').pop()}</span>
        </div>`;
      grid.appendChild(card);
    });
    prevBtn.disabled = (page === 0);
    nextBtn.disabled = ((page+1)*pageSize >= results.length);
  }

  prevBtn.addEventListener('click', () => { if(page>0){page--; render();} });
  nextBtn.addEventListener('click', () => { if((page+1)*pageSize < results.length){page++; render();} });

  // Autofocus on load
  nameEl.focus();

})();</script>
</body>
</html>

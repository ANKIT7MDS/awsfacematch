<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Face Search</title>
<style>
  :root{
    --brand:#ff8a00;
    --ink:#222;
    --muted:#666;
    --ok:#1a7f37;
    --err:#c0392b;
    --bg:#fff7ef;
    --card:#fff;
    --border:#eee;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
    background:#fff; color:var(--ink);
  }
  header{
    background:var(--brand); color:#fff; padding:12px 16px; font-weight:700;
  }
  .wrap{max-width:1080px; margin:0 auto; padding:16px; }
  .grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px;}
  @media (max-width:900px){ .grid{grid-template-columns: 1fr} }

  label{display:block; font-size:14px; color:var(--muted); margin:4px 0 6px;}
  input[type="text"],input[type="tel"],input[type="file"]{
    width:100%; padding:12px 12px; border:1px solid var(--border); border-radius:10px; font-size:16px; background:#fff;
  }

  .panel{
    background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;
  }
  .videoBox{
    position:relative; background:#000; border-radius:12px; overflow:hidden; min-height:260px;
    border:1px solid var(--border);
  }
  video{ width:100%; height:auto; display:block; background:#000; }
  canvas{ display:none; }
  .controls{ display:flex; gap:10px; margin:12px 0 0; }
  .btn{
    appearance:none; border:0; background:var(--brand); color:#fff; font-weight:700; border-radius:10px;
    padding:12px 16px; cursor:pointer; transition:transform .05s ease;
    position:relative; z-index:5; pointer-events:auto;
  }
  .btn:active{ transform:scale(.99); }
  .btn.secondary{ background:#111; }
  .btn.muted{ background:#e6e6e6; color:#222; }
  .btn:disabled{ opacity:.55; cursor:not-allowed; }

  .hint{ font-size:13px; color:var(--muted); margin-top:8px; }
  .msg{ margin-top:12px; padding:12px; border-radius:10px; background:var(--bg); border:1px solid var(--border); }
  .msg.ok{ background:#eaf7ef; border-color:#d6efe0; color:var(--ok); }
  .msg.err{ background:#fdecea; border-color:#fad3cf; color:var(--err); }
  .msg.info{ background:#eef6ff; border-color:#d9ebff; color:#0b66c3; }

  .results{ margin-top:18px; display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:14px; }
  .card{
    border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#fff;
  }
  .thumb{ width:100%; aspect-ratio:1/1; object-fit:cover; display:block; background:#f3f3f3; }
  .meta{ padding:10px 12px; font-size:13px; color:#333; }
  .meta b{ font-weight:700; }
  .top-actions{ display:flex; gap:10px; align-items:center; }
</style>
</head>
<body>
<header>भारतीय जनता पार्टी — मंदसौर (Face Search)</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Camera + form -->
    <div class="panel">
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
        <div>
          <label>नाम (अनिवार्य)</label>
          <input id="name" type="text" placeholder="अपना नाम" autocomplete="name"/>
        </div>
        <div>
          <label>मोबाइल नंबर (अनिवार्य)</label>
          <input id="mobile" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="10 अंकों का मोबाइल" />
        </div>
      </div>

      <div style="margin-top:12px">
        <label>सेल्फ़ी कैमरा</label>
        <div class="videoBox">
          <video id="video" autoplay playsinline muted></video>
        </div>
        <div class="controls">
          <button id="btnSnap" class="btn" type="button" onclick="takeSelfie()">सेल्फ़ी लें</button>
          <button id="btnSearch" class="btn" type="button" onclick="doSearch()">Search</button>
        </div>
        <div class="hint">PNG/WebP → JPEG auto. * मोबाइल पर कैमरा अपने-आप खुलेगा (Allow दें)। फ़ाइल अपलोड की ज़रूरत नहीं।</div>
        <div id="msg" class="msg" style="display:none"></div>
      </div>
    </div>

    <!-- RIGHT: file + live result -->
    <div class="panel">
      <label>या फ़ाइल चुनें</label>
      <input id="file" type="file" accept="image/*" capture="user" />
      <div class="hint">अगर कैमरा उपलब्ध नहीं हो तो यहाँ से सेल्फ़ी चुनें।</div>

      <div class="results" id="results"></div>
    </div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const API_BASE = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2'; // <-- अपना API स्टेज यहाँ दें
const DEFAULT_SIM = 70;

/* ========= STATE ========= */
let stream = null;
let lastImageBase64 = null;

/* ========= UTIL ========= */
const $ = sel => document.querySelector(sel);
function msg(text,type='info'){
  const el = $('#msg'); if(!el) return;
  el.className = 'msg ' + (type||'');
  el.textContent = text;
  el.style.display = text ? 'block':'none';
}
function clearMsg(){ msg('', ''); }
function toBase64FromArrayBuffer(buf){
  const b = new Uint8Array(buf);
  let bin=''; for(let i=0;i<b.length;i++) bin += String.fromCharCode(b[i]);
  return btoa(bin);
}
function byId(id){ return document.getElementById(id); }

/* ========= CAMERA ========= */
async function startCam(){
  try{
    if(stream) return;
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio:false });
    const v = byId('video');
    v.srcObject = stream;
    await v.play().catch(()=>{});
  }catch(e){
    console.warn('camera error', e);
    msg('कैमरा नहीं खुला। फ़ाइल से भी खोज सकते हैं।', 'info');
  }
}
function stopCam(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  const v = byId('video'); v.removeAttribute('srcObject');
}
function canvasFromVideo(){
  const v = byId('video');
  const vw = v.videoWidth||720, vh = v.videoHeight||720;
  const c = document.createElement('canvas');
  c.width = 720; c.height = Math.round(720*vh/vw);
  c.getContext('2d').drawImage(v,0,0,c.width,c.height);
  return c;
}
async function takeSelfie(){
  try{
    if(!stream) await startCam();
    const c = canvasFromVideo();
    const blob = await new Promise(res => c.toBlob(b => res(b), 'image/jpeg', 0.9));
    const buf = await blob.arrayBuffer();
    lastImageBase64 = toBase64FromArrayBuffer(buf);
    msg('सेल्फ़ी तैयार ✅','ok');
  }catch(e){
    console.error(e);
    msg('सेल्फ़ी लेने में दिक्कत।', 'err');
  }
}

/* ========= SEARCH ========= */
async function doSearch(){
  clearMsg();

  const name = byId('name').value.trim();
  const mobile = byId('mobile').value.trim();

  if(!name){ msg('कृपया नाम भरें।','err'); return; }
  if(!/^\d{10}$/.test(mobile)){ msg('कृपया 10 अंकों का मोबाइल भरें।','err'); return; }

  // prefer selfie memory -> file -> live snap
  let imageBase64 = lastImageBase64 || null;
  const f = byId('file').files?.[0];
  if(!imageBase64 && f){
    const buf = await f.arrayBuffer();
    imageBase64 = toBase64FromArrayBuffer(buf);
  }
  if(!imageBase64 && stream){
    const c = canvasFromVideo();
    const blob = await new Promise(res => c.toBlob(b=>res(b),'image/jpeg',0.9));
    const buf = await blob.arrayBuffer();
    imageBase64 = toBase64FromArrayBuffer(buf);
  }

  byId('btnSearch').disabled = true;
  msg('खोज चल रही है…', 'info');

  try{
    const payload = {
      name, mobile,
      sim: DEFAULT_SIM
    };
    if(imageBase64) payload.imageBase64 = imageBase64;

    const resp = await fetch(API_BASE + '/search', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(payload)
    });

    if(!resp.ok){
      const txt = await resp.text().catch(()=> '');
      throw Object.assign(new Error('API '+resp.status), {status:resp.status, body:txt});
    }

    const data = await resp.json().catch(()=> ({}));
    const results = Array.isArray(data.results) ? data.results : (Array.isArray(data) ? data : []);

    renderResults(results);
    msg(`मिले ${results.length} फोटो।`, 'ok');
  }
  catch(err){
    console.error('search error', err);
    let detail = err.body ? `\nडिटेल्स: ${err.body}` : '';
    msg(`सर्व में दिक्कत: API ${err.status||'error'}${detail}`, 'err');
  }
  finally{
    byId('btnSearch').disabled = false;
  }
}

/* ========= RENDER RESULTS ========= */
function getKey(r){
  // flexible field mapping (backend variations safe)
  return r.s3Key || r.key || r.s3key || r.path || r.urlKey || '';
}
function getId(r){
  return r.photoId || r.id || r.imageId || '';
}
function getScore(r){
  return Math.round((r.similarity || r.score || r.confidence || 0) * 100) / 100;
}
function cardHTML(r){
  const s3Key = getKey(r);
  const photoId = getId(r);
  const sim = getScore(r);
  const imgURL = s3Key ? (API_BASE + '/download?key=' + encodeURIComponent(s3Key)) : '';
  return `
    <div class="card">
      ${ imgURL
        ? `<img class="thumb" loading="lazy" alt="${photoId||'photo'}" src="${imgURL}">`
        : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:#888">No preview</div>`
      }
      <div class="meta">
        ${photoId ? `<div><b>ID:</b> ${photoId}</div>`:''}
        ${sim ? `<div><b>~${sim}%</b> match</div>`:''}
        ${s3Key ? `<div style="word-break:break-all;opacity:.7">${s3Key}</div>`:''}
      </div>
    </div>`;
}
function renderResults(items){
  const box = byId('results');
  if(!items || !items.length){
    box.innerHTML = `<div class="msg">कोई फोटो नहीं मिला।</div>`;
    return;
  }
  box.innerHTML = items.map(cardHTML).join('');
}

/* ========= BOOT ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  // ensure handlers also bound (inline onclick is already present)
  byId('btnSnap')?.addEventListener('click', takeSelfie);
  byId('btnSearch')?.addEventListener('click', doSearch);

  // try auto camera on mobile/desktop
  startCam();
});
window.addEventListener('beforeunload', stopCam);
</script>
</body>
</html>

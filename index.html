<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>भारतीय जनता पार्टी — मंदसौर (Face Search)</title>
  <style>
    :root{ --brand:#ff8500; --brand-dark:#e67300; --muted:#f8efe6; --danger:#e74c3c; --ok:#1e9f54; --ink:#222 }
    html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff7f0;color:var(--ink)}
    header{background:var(--brand);color:#111;padding:12px 16px;font-weight:700}
    .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .field label{display:block;font-size:14px;margin-bottom:6px}
    .field input{width:100%;font-size:16px;padding:12px 14px;border:1px solid #ddd;border-radius:10px;background:#fff}
    .hint{font-size:13px;color:#666}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    video{width:100%;aspect-ratio:4/3;background:#000;border-radius:12px}
    canvas{display:none}
    .btn{appearance:none;border:0;border-radius:12px;background:var(--brand);color:#111;font-weight:700;padding:12px 18px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.secondary{background:#111;color:#fff}
    .status{margin-top:10px;padding:10px 12px;border-radius:10px;background:var(--muted);border:1px dashed #f1d3bc;color:#5a473a}
    .status.error{background:#fff0ef;border-color:#f3b7b0;color:#7c2d25}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#ecfff4;color:#0c6b3b;font-size:13px;border:1px solid #b6e9cc}
    .footer-note{margin-top:10px;font-size:13px;color:#666}
    .hidden{display:none !important}
    .center{display:flex;align-items:center;justify-content:center}
    details summary{cursor:pointer;font-weight:600}
    pre{white-space:pre-wrap}
    @media (max-width:768px){ .file-block{display:none} .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>भारतीय जनता पार्टी — मंदसौर (Face Search)</header>

  <main class="wrap">
    <section class="card">
      <div class="grid">
        <!-- Left: Camera/Selfie -->
        <div>
          <div class="field">
            <label>नाम <small>(अनिवार्य)</small></label>
            <input id="name" type="text" placeholder="अपना नाम" autocomplete="name" required />
          </div>
          <div style="height:10px"></div>
          <div class="field">
            <label>सेल्फ़ी कैमरा</label>
            <video id="video" playsinline muted></video>
            <canvas id="canvas" width="1280" height="960"></canvas>
          </div>
          <div class="row" style="margin-top:12px">
            <button id="btnTake" type="button" class="btn">सेल्फ़ी लें</button>
            <button id="btnRetake" type="button" class="btn secondary">दोबारा लें</button>
            <span id="selfieOk" class="pill hidden">सेल्फ़ी तैयार ✓</span>
          </div>
          <div id="camMsg" class="status" style="display:none"></div>
        </div>

        <!-- Right: Form + Search -->
        <div>
          <div class="field">
            <label>मोबाइल नंबर <small>(अनिवार्य)</small></label>
            <input id="mobile" type="tel" inputmode="numeric" pattern="[0-9]{10}" maxlength="10" placeholder="10 अंकों का मोबाइल" autocomplete="tel" required />
          </div>

          <div class="field file-block" style="margin-top:12px">
            <label>या फ़ाइल चुनें</label>
            <input id="file" type="file" accept="image/*" />
            <p class="hint">PNG/WebP → JPEG auto. * मोबाइल पर कैमरा अपने-आप खुलेगा (Allow दें)। फ़ाइल अपलोड की ज़रूरत नहीं।</p>
          </div>

          <div style="height:14px"></div>
          <button id="btnSearch" type="button" class="btn" style="width:100%"><span class="label">Search</span><span class="hidden" id="spnBusy" aria-hidden="true" style="margin-left:8px">…</span></button>

          <div id="msg" class="status" style="display:none"></div>
          <div id="hardErr" class="status error" style="display:none"></div>
          <details id="errDetails" class="hidden"><summary>एरर डीटेल्स</summary><pre id="errDump"></pre></details>
          <p class="footer-note">सर्च परिणाम नए टैब में खुलेंगे।</p>
        </div>
      </div>
    </section>

    <!-- Dev quick-tests (open with #test) -->
    <pre id="tests" class="status hidden"></pre>
  </main>

  <script>
  // ======= Config =======
  const API_BASE = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
  const OPEN_IN_NEW_TAB = true;
  const REQUEST_TIMEOUT_MS = 25000; // 25s

  // ======= State =======
  let stream = null;      // MediaStream
  let selfieFile = null;  // File captured / chosen
  let searching = false;

  // ======= Helpers =======
  const $ = sel => document.querySelector(sel);
  const show = (el, txt='') => { el.style.display='block'; if (txt!==undefined) el.textContent = txt; };
  const hide = el => { el.style.display='none'; };

  function isValidMobile(ms){ return /^[0-9]{10}$/.test(String(ms||'').trim()); }

  function toast(msg, kind='info'){
    const b = $('#msg');
    b.classList.toggle('error', kind==='error');
    show(b, msg);
    clearTimeout(b._t);
    b._t = setTimeout(()=>hide(b), 4000);
  }

  async function fileToBase64(file){
    const dataUrl = await new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = () => rej(new Error('file-read-failed'));
      r.readAsDataURL(file);
    });
    // Return *both*: plain base64 and dataURL (some backends expect prefix)
    const parts = String(dataUrl).split(',');
    return { base64: parts[1], dataUrl: String(dataUrl) };
  }

  function enableSearchIfReady(){
    const ok = ($('#name').value.trim().length>0) && isValidMobile($('#mobile').value) && !!selfieFile && !searching;
    $('#btnSearch').disabled = !ok;
  }

  function setBusy(b){
    searching = b; enableSearchIfReady();
    $('#spnBusy').classList.toggle('hidden', !b);
  }

  // ======= Camera =======
  async function openCamera(){
    try{
      if(stream){return}
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user' }, audio:false });
      const video = $('#video');
      video.srcObject = stream;
      await video.play().catch(()=>{}); // mobile Safari often throws AbortError; safe to ignore
      hide($('#camMsg'));
    }catch(err){
      console.warn('camera error', err);
      show($('#camMsg'), 'कैमरा परमिशन नहीं मिली। कृपया Allow दें या फ़ाइल चुनें।');
    }
  }

  function captureSelfie(){
    const video = $('#video');
    const canvas = $('#canvas');
    const ctx = canvas.getContext('2d');
    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 960;
    canvas.width = w; canvas.height = h;
    ctx.drawImage(video, 0, 0, w, h);
    const dataURL = canvas.toDataURL('image/jpeg', 0.9);
    const bin = atob(dataURL.split(',')[1]);
    const arr = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
    selfieFile = new File([arr], 'selfie.jpg', { type:'image/jpeg' });
    $('#selfieOk').classList.remove('hidden');
    enableSearchIfReady();
  }

  function clearSelfie(){
    selfieFile = null;
    $('#selfieOk').classList.add('hidden');
    enableSearchIfReady();
  }

  // ======= Robust fetch helpers =======
  const jsonTry = txt => { try{ return JSON.parse(txt); }catch{ return null; } };

  async function readBodySmart(resp){
    let text = '';
    try{ text = await resp.text(); }catch{ text = ''; }
    const asJson = jsonTry(text);
    return asJson!==null ? asJson : text;
  }

  function httpErrorMessage(err){
    if (err.name === 'AbortError') return 'रिक्वेस्ट का समय खत्म हो गया। थोड़ी देर बाद पुनः प्रयास करें।';
    if (String(err).includes('Failed to fetch')) return 'नेटवर्क/ब्राउज़र समस्या। बाद में फिर प्रयास करें।';
    return err.message || String(err);
  }

  async function fetchSmart(url, opts){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), REQUEST_TIMEOUT_MS);
    try{
      const r = await fetch(url, { mode:'cors', ...opts, signal: ctrl.signal });
      const body = await readBodySmart(r);
      if(!r.ok){
        const detail = typeof body === 'string' ? body.slice(0,400) : body;
        const e = new Error(`API ${r.status}`);
        e.status = r.status; e.body = detail; e.url = url; throw e;
      }
      return body;
    } finally { clearTimeout(t); }
  }

  // ======= API (JSON only; retry with dataURL if backend rejects) =======
  async function callSearch(name, mobile, file){
    const { base64, dataUrl } = await fileToBase64(file);

    const common = { method:'POST', headers:{ 'accept':'application/json', 'content-type':'application/json' } };

    // Attempt 1: send plain base64 (preferred)
    try{
      return await fetchSmart(API_BASE + '/search', {
        ...common,
        body: JSON.stringify({ name, mobile, image: base64 })
      });
    }catch(err){
      // Some backends expect full dataURL string inside JSON.
      const msg = (err && (err.body?.message || err.message)) || '';
      const looksLikeParseErr = /Unexpected token|JSON at position/i.test(String(msg)) || err.status>=400;
      if(!looksLikeParseErr) throw err;
      console.warn('Retrying search with dataURL image…', msg);
      return await fetchSmart(API_BASE + '/search', {
        ...common,
        body: JSON.stringify({ name, mobile, image: dataUrl })
      });
    }
  }

  function renderResultsNewTab(resp){
    const w = window.open('', '_blank');
    if(!w){ toast('पॉप‑अप ब्लॉक हुआ। ब्राउज़र में pop-up allow करें।','error'); return; }
    const photos = Array.isArray(resp?.photos) ? resp.photos : [];
    w.document.write(`<!doctype html><html lang="hi"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Search Results</title>
      <style>body{font-family:system-ui;padding:16px;background:#fff} .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px} img{width:100%;height:220px;object-fit:cover;border-radius:10px;background:#eee} .meta{font:12px/1.3 system-ui;color:#555;margin-top:4px} a.dl{display:inline-block;margin-top:6px;font-weight:600}</style>
    </head><body>`);
    w.document.write(`<h2>मिले फोटो: ${photos.length}</h2>`);
    if(!photos.length){ w.document.write('<p>कोई फोटो नहीं मिला।</p>'); }
    w.document.write('<div class="grid">');
    photos.forEach(p=>{
      const t = p?.thumbUrl || p?.thumb || p?.url || '';
      const o = p?.downloadUrl || p?.url || '';
      w.document.write(`<div><img loading="lazy" src="${t}" alt=""/><div class="meta">${p?.photoId||''}</div><a class="dl" href="${o}" download>Download</a></div>`);
    });
    w.document.write('</div></body></html>');
    w.document.close();
  }

  function showErrorDetails(err){
    try{
      const det = $('#errDetails');
      const dump = $('#errDump');
      const obj = {message: err.message, status: err.status, url: err.url, body: err.body};
      dump.textContent = JSON.stringify(obj, null, 2);
      det.classList.remove('hidden');
    }catch{ /* noop */ }
  }

  async function doSearch(){
    const name = $('#name').value.trim();
    const mobile = $('#mobile').value.trim();

    if(!name){ toast('कृपया नाम भरें','error'); $('#name').focus(); return; }
    if(!isValidMobile(mobile)){ toast('कृपया 10 अंकों का मोबाइल भरें','error'); $('#mobile').focus(); return; }
    if(!selfieFile && $('#file').files[0]) selfieFile = $('#file').files[0];
    if(!selfieFile){ toast('पहले सेल्फ़ी लें या फ़ाइल चुनें','error'); return; }

    setBusy(true); hide($('#hardErr')); $('#errDetails').classList.add('hidden');
    try{
      const resp = await callSearch(name, mobile, selfieFile);
      console.log('search resp', resp);

      if(typeof resp !== 'object' || resp === null){
        throw new Error('Invalid response (non‑JSON) प्राप्त हुआ');
      }
      if(resp.error){
        const e = new Error(resp.message || resp.error);
        e.body = resp; throw e;
      }

      toast('सर्च सफल, नये टैब में खुल रहा है…');
      if(OPEN_IN_NEW_TAB) renderResultsNewTab(resp);
    }catch(err){
      console.error('search error', err);
      const msg = httpErrorMessage(err).replace(/</g,'&lt;').slice(0,400);
      show($('#hardErr'), 'सर्व में दिक्कत: ' + msg);
      showErrorDetails(err);
    }finally{ setBusy(false); }
  }

  // ======= Wire-up =======
  document.addEventListener('DOMContentLoaded', () => {
    // camera on load + on focus
    if(navigator.mediaDevices?.getUserMedia){
      openCamera();
      window.addEventListener('focus', ()=>{ if(!stream) openCamera(); });
    } else {
      show($('#camMsg'), 'यह ब्राउज़र कैमरा सपोर्ट नहीं करता।');
    }

    $('#btnTake').addEventListener('click', (e)=>{ e.preventDefault(); captureSelfie(); });
    $('#btnRetake').addEventListener('click', (e)=>{ e.preventDefault(); clearSelfie(); captureSelfie(); });
    $('#file').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f){ selfieFile=f; $('#selfieOk').classList.remove('hidden'); } else { clearSelfie(); } enableSearchIfReady(); });

    $('#name').addEventListener('input', enableSearchIfReady);
    $('#mobile').addEventListener('input', enableSearchIfReady);

    const btn = $('#btnSearch');
    btn.disabled = true; // until ready
    btn.addEventListener('click', (e)=>{ e.preventDefault(); doSearch(); });

    // ===== Dev tiny tests =====
    if(location.hash==="#test"){
      const out = [];
      out.push('— Running UI tests —');
      out.push('isValidMobile("9893074891"): ' + isValidMobile('9893074891'));
      out.push('isValidMobile("12345"): ' + isValidMobile('12345'));
      out.push('jsonTry ok: ' + JSON.stringify(jsonTry('{"ok":1}')));
      out.push('jsonTry bad: ' + jsonTry('Lambda html'));
      const box = $('#tests'); box.classList.remove('hidden'); box.textContent = out.join('\n');
    }
  });
  </script>
</body>
</html>

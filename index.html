<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>भारतीय जनता पार्टी — मंदसौर | WedMatch Selfie Search</title>

  <!-- ZIP libs -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --brand:#ff8a00; --brand-d:#f27700; --ink:#0f1720; --muted:#667085;
      --bg:#fff9f2; --card:#fff; --bd:#f1e4d4; --sel:#2563eb; --ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 system-ui,Segoe UI,Roboto,Arial}
    header{background:var(--brand);color:#111;padding:14px 18px;font-weight:800;letter-spacing:.2px}
    main{max-width:1100px;margin:0 auto;padding:14px}

    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:10px 0}
    label{display:block;font-weight:600;margin:6px 0 4px}
    input,select,button{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:10px;background:#fff}
    input:focus,select:focus{outline:2px solid #ffd7a6;border-color:#ffd7a6}

    .row{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    .muted{color:var(--muted);font-size:12px}

    /* Buttons */
    .btn{background:var(--brand);border:none;border-radius:10px;color:#111;font-weight:700;cursor:pointer;padding:10px 14px}
    .btn:hover{background:var(--brand-d)}
    .btn.secondary{background:#0f1720;color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--bd);color:var(--ink)}
    .btn.block{width:100%}

    /* Camera */
    #video{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;border:1px solid var(--bd)}

    /* Thumbs grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .thumb{position:relative;background:#fff;border:1px solid var(--bd);border-radius:12px;overflow:hidden;cursor:pointer}
    .thumb img{width:100%;height:140px;object-fit:cover;display:block}
    .thumb .cap{padding:8px;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .thumb input[type="checkbox"]{position:absolute;top:8px;left:8px;width:18px;height:18px}
    .thumb.sel{box-shadow:0 0 0 3px rgba(37,99,235,.4);}

    .toolbar{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .badge{display:inline-block;padding:5px 10px;border-radius:999px;background:#111;color:#fff;font-size:12px}
    .badge.ok{background:var(--ok);}

    /* Mobile tuning */
    @media (max-width:820px){
      .grid-2{grid-template-columns:1fr}
      .toolbar{grid-template-columns:1fr}
      .btn{padding:12px 14px;font-size:16px}
    }
  </style>
</head>
<body>
<header>भारतीय जनता पार्टी — मंदसौर</header>
<main>

  <!-- Search form -->
  <section class="card">
    <div class="row grid-2">
      <div>
        <label>नाम</label>
        <input id="name" placeholder="आपका नाम (optional)">
      </div>
      <div>
        <label>मोबाइल नंबर</label>
        <input id="phone" placeholder="मोबाइल (optional)">
      </div>
    </div>

    <div class="row grid-2" style="margin-top:10px">
      <div>
        <label>सेल्फी कैमरा</label>
        <video id="video" autoplay muted playsinline></video>
        <div class="row" style="grid-template-columns:1fr 1fr 1fr;margin-top:8px">
          <button class="btn" id="camOn">कैमरा चालू करें</button>
          <button class="btn ghost" id="snap">फोटो कैप्चर</button>
          <button class="btn secondary" id="camOff">कैमरा बंद</button>
        </div>
      </div>
      <div>
        <label>या फ़ाइल चुनें</label>
        <input id="file" type="file" accept="image/*">
        <div class="muted" style="margin-top:6px">PNG/WebP → JPEG auto.</div>
        <div style="margin-top:12px">
          <button class="btn block" id="doSearch">Search</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Results / selection -->
  <section class="card">
    <div style="display:flex;gap:10px;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="badge" id="multiState">Multiple select: ON</span>
        <span class="badge" id="selCount">Selected: 0</span>
      </div>
      <div class="muted" id="msg">रिज़ल्ट यहां दिखेंगे…</div>
    </div>

    <div class="toolbar" style="margin-bottom:10px">
      <button class="btn ghost" id="btnSelectAll">Select All</button>
      <button class="btn ghost" id="btnClear">Clear</button>
      <button class="btn" id="btnDownload">Download Selected</button>
    </div>

    <div id="grid" class="grid"></div>
  </section>

</main>

<script>
  /********************** CONFIG **********************/
 // Set API base URL for the application
(function() {
  const apiBaseUrl = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
  localStorage.setItem('apiBase', apiBaseUrl);
  console.log(`API base set to: ${apiBaseUrl}`);
  location.reload();
})();


  /********************** CAMERA **********************/
  const video = document.getElementById('video');
  let stream;

  document.getElementById('camOn').onclick = async () => {
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      video.srcObject = stream;
    }catch(e){ alert('कैमरा उपलब्ध नहीं: '+e.message); }
  };
  document.getElementById('camOff').onclick = () => {
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; }
  };
  document.getElementById('snap').onclick = () => {
    if(!video.srcObject){ alert('पहले कैमरा चालू करें'); return; }
    const c=document.createElement('canvas'); c.width=video.videoWidth||1280; c.height=video.videoHeight||720;
    c.getContext('2d').drawImage(video,0,0,c.width,c.height);
    c.toBlob(b=>{
      const f=new File([b],'selfie.jpg',{type:'image/jpeg'});
      runSearch(f);                          // कैप्चर के बाद search ऑटो
    },'image/jpeg',0.92);
  };

  /********************** UI HELPERS **********************/
  const grid = document.getElementById('grid');
  const selected = new Set();
  const msgEl = document.getElementById('msg');

  function setMsg(t, ok=false){
    msgEl.textContent = t;
    msgEl.className = ok ? 'badge ok' : 'muted';
  }
  function clearGrid(){
    grid.innerHTML=''; selected.clear(); updateSelCount();
  }
  function updateSelCount(){
    document.getElementById('selCount').textContent=`Selected: ${selected.size}`;
  }
  function safeFileName(s){
    return (s||'photo').replace(/[^\w\-]+/g,'_').replace(/_+/g,'_');
  }

  /********************** SEARCH **********************/
  document.getElementById('doSearch').onclick = () => {
    const f = document.getElementById('file').files?.[0];
    if(!f){ alert('कृपया selfie upload करें या कैमरा से कैप्चर करें'); return; }
    runSearch(f);
  };

  async function runSearch(file){
    if(!API_BASE){ alert('API base सेट नहीं है'); return; }
    setMsg('Searching...');
    clearGrid();

    // PNG/WebP → JPEG normalize
    const jpeg = await toJpeg(file);

    const url = API_BASE + '/search';
    const fd = new FormData();
    fd.append('name', document.getElementById('name').value||'');
    fd.append('phone', document.getElementById('phone').value||'');
    fd.append('file', jpeg, 'selfie.jpg');

    let res, txt, data;
    try{
      res = await fetch(url, { method:'POST', body:fd });
      txt = await res.text();
      try{ data = JSON.parse(txt); } catch{ data = { _raw: txt }; }
    }catch(e){
      setMsg('नेटवर्क त्रुटि'); return;
    }
    if(!res.ok){
      console.warn('search fail', data);
      setMsg('Search failed'); return;
    }

    const matches = Array.isArray(data.matches) ? data.matches : [];
    if(!matches.length){ setMsg('कोई मैच नहीं मिला'); return; }

    fillGrid(matches);
    setMsg(`मिले: ${matches.length}`, true);       // काउंट साफ दिखाएँ
  }

  async function toJpeg(file,maxDim=1600,quality=0.92){
    if (/jpe?g$/i.test(file.name) && /jpe?g/i.test(file.type)) return file;
    const img = await blobToImage(file);
    const w=img.width,h=img.height; let nw=w,nh=h;
    if(Math.max(w,h)>maxDim){const k=maxDim/Math.max(w,h); nw=Math.round(w*k); nh=Math.round(h*k);}
    const c=document.createElement('canvas'); c.width=nw; c.height=nh;
    c.getContext('2d').drawImage(img,0,0,nw,nh);
    const b=await new Promise(r=>c.toBlob(r,'image/jpeg',quality));
    return new File([b],file.name.replace(/\.\w+$/,'.jpg'),{type:'image/jpeg'});
  }
  function blobToImage(file){
    return new Promise((res,rej)=>{
      const u=URL.createObjectURL(file), i=new Image();
      i.onload=()=>{URL.revokeObjectURL(u);res(i)}; i.onerror=e=>{URL.revokeObjectURL(u);rej(e)}; i.src=u;
    });
  }

  /********************** GRID / SELECT **********************/
  function fillGrid(matches){
    grid.innerHTML='';
    matches.forEach((m,idx)=>{
      const key = m.s3Key || m.photoId || (m.url||'').split('/').pop() || `photo_${idx}`;
      const showUrl = s3DownloadUrl(key);     // same endpoint for thumb + download
      const card = document.createElement('div');
      card.className='thumb';
      card.dataset.key = key;
      card.dataset.dl = showUrl;
      card.innerHTML = `
        <input type="checkbox" data-id="${idx}">
        <img loading="lazy" src="${showUrl}">
        <div class="cap" title="${key}">${(key.split('/').pop() || 'photo')}</div>
      `;
      // click पूरे कार्ड पर selection toggle
      card.addEventListener('click',(e)=>{
        if(e.target.tagName.toLowerCase()==='input') return;
        const cb = card.querySelector('input');
        cb.checked = !cb.checked;
        cb.dispatchEvent(new Event('change'));
      });
      const cb = card.querySelector('input');
      cb.addEventListener('change',()=>{
        if(cb.checked){ selected.add(idx); card.classList.add('sel'); }
        else{ selected.delete(idx); card.classList.remove('sel'); }
        updateSelCount();
      });
      grid.appendChild(card);
    });
  }

  // Select/Clear
  document.getElementById('btnSelectAll').onclick = ()=>{
    [...grid.querySelectorAll('input[type="checkbox"]')].forEach(cb=>{
      if(!cb.checked){ cb.checked=true; cb.dispatchEvent(new Event('change')); }
    });
  };
  document.getElementById('btnClear').onclick = ()=>{
    [...grid.querySelectorAll('input[type="checkbox"]')].forEach(cb=>{
      if(cb.checked){ cb.checked=false; cb.dispatchEvent(new Event('change')); }
    });
  };

  /********************** DOWNLOAD SELECTED (single JPEG format) **********************/
  document.getElementById('btnDownload').onclick = async ()=>{
    if(!grid.children.length){ alert('पहले सर्च करें'); return; }
    const picks = [...grid.querySelectorAll('.thumb')].filter(t=>t.querySelector('input').checked);
    if(!picks.length){ alert('कोई फ़ोटो select नहीं है'); return; }

    setMsg('Preparing ZIP…');

    const zip = new JSZip();
    let done = 0;

    for(const t of picks){
      const key = t.dataset.key;
      const url = t.dataset.dl; // /download?key=...

      try{
        // हमेशा blob fetch करें — server JPEG दे रहा होगा
        const resp = await fetch(url,{mode:'cors'});
        const blob = await resp.blob();

        // सुनिश्चित करें .jpg एक्सटेंशन
        const base = safeFileName((key.split('/').pop() || 'photo').replace(/\.\w+$/,''));
        const fname = base + '.jpg';

        zip.file(fname, blob);
        done++;
        setMsg(`Added ${done}/${picks.length}`);
      }catch(e){
        console.warn('download fail', key, e);
      }
    }

    const out = await zip.generateAsync({type:'blob'});
    saveAs(out, `wedmatch_${new Date().toISOString().slice(0,10)}.zip`);
    setMsg(`ZIP ready (${done} files)`, true);
  };
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WedMatch — Selfie Search</title>
  <style>
    :root{--brand:#ff8a00;--bg:#fff7ef;--border:#e9d7c3;--ink:#222}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink)}
    header{background:var(--brand);padding:14px 18px;font-weight:700}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:14px}
    label{font-weight:600;margin:6px 0 4px;display:block}
    input,select,button,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    button{background:var(--brand);border:none;font-weight:700;cursor:pointer}
    .row{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .muted{font-size:12px;color:#666}
    .results{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .photo{position:relative;border:1px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer;background:#fff}
    .photo img{display:block;width:100%;aspect-ratio:1;object-fit:cover}
    .photo .check{position:absolute;right:8px;top:8px;width:22px;height:22px;border-radius:50%;background:#fff;border:2px solid #888;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;color:#fff;opacity:.0;transition:all .15s}
    .photo.selected{outline:3px solid #1e90ff}
    .photo.selected .check{opacity:1;background:#1e90ff;border-color:#1e90ff}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{padding:8px 10px;border-radius:999px;background:#111;color:#fff;font-weight:700}
  </style>
</head>
<body>
  <header>WedMatch — Selfie Search</header>
  <main>

    <!-- API + Event -->
    <section class="card">
      <div class="row grid-2">
        <div>
          <label for="apiBase">API Base URL</label>
          <input id="apiBase" placeholder="https://<api-id>.execute-api.ap-south-1.amazonaws.com/PROD2" />
          <div style="margin-top:8px"><button id="saveApi">Save API URL</button></div>
          <div class="muted" style="margin-top:6px">Tip: यह आपका API Gateway stage URL है।</div>
        </div>
        <div>
          <label for="eventId">इवेंट चुनें</label>
          <select id="eventId"></select>
        </div>
      </div>
    </section>

    <!-- Capture/Upload -->
    <section class="card">
      <h3 style="margin:0 0 6px">अपनी फोटो ढूँढें (Selfie Search)</h3>
      <div class="row grid-3" style="align-items:end">
        <div>
          <label for="name">नाम (optional)</label>
          <input id="name" placeholder="नाम" />
        </div>
        <div>
          <label for="phone">मोबाइल नंबर (optional)</label>
          <input id="phone" placeholder="98xxxxxx" />
        </div>
        <div>
          <button id="searchBtn">Search</button>
        </div>
      </div>

      <div class="row grid-2" style="margin-top:10px">
        <div>
          <label>सेल्फी कैमरा</label>
          <video id="cam" playsinline autoplay muted style="width:100%;max-height:260px;border-radius:10px;border:1px solid var(--border);background:#000"></video>
          <div style="display:flex;gap:10px;margin-top:8px">
            <button id="startCam">कैमरा चालू करें</button>
            <button id="snap">फोटो कैप्चर</button>
            <button id="stopCam" class="muted">कैमरा बंद</button>
          </div>
          <canvas id="shot" style="display:none"></canvas>
        </div>
        <div>
          <label>या फाइल चुनें</label>
          <input id="file" type="file" accept="image/*" />
          <div class="muted" style="margin-top:6px">PNG/WebP → JPEG auto.</div>
        </div>
      </div>
    </section>

    <!-- Results + Selection -->
    <section class="card">
      <div class="toolbar" style="margin-bottom:8px">
        <span id="msToggle" class="pill" style="background:#1e293b">Multiple select: <b id="msState">ON</b></span>
        <span class="pill" id="selCount">Selected: 0</span>
        <button id="selAll">Select All</button>
        <button id="selClear">Clear</button>
        <button id="downloadSel">Download Selected</button>
      </div>
      <div id="results" class="results"></div>
      <div id="status" class="muted" style="margin-top:8px">कोई मैच नहीं मिला</div>
    </section>

  </main>

  <script>
    const $=(id)=>document.getElementById(id);
    const state={ apiBase:'', multiple:true, selected:new Set(), results:[] };

    const safeJson=async (r)=>{ const t=await r.text(); try{return JSON.parse(t)}catch{return{_raw:t}}; };
    const safeFetch=async(u,o={})=>fetch(u,o);

    function build(base){ return {
      events: base+'/admin/events',
      search: base+'/search',
      download: base+'/download'
    };}

    function toast(x){ console.log(x); }

    function renderEvents(items){
      const sel=$('eventId');
      sel.innerHTML = items.length
        ? items.map(e=>`<option value="${e.eventId||e}">${e.eventName||e}</option>`).join('')
        : `<option value="">(no events)</option>`;
    }

    async function loadEvents(){
      if(!state.apiBase) return;
      const r=await safeFetch(build(state.apiBase).events);
      if(!r.ok) return;
      const d=await safeJson(r);
      const items=Array.isArray(d?.items)?d.items:(Array.isArray(d)?d:[]);
      renderEvents(items);
    }

    function updateSelUI(){
      $('selCount').textContent=`Selected: ${state.selected.size}`;
    }

    function imgCard(obj){
      const url = obj.url || obj.imageUrl || obj.image || '';
      const d = document.createElement('div');
      d.className='photo';
      d.dataset.u = url;
      d.innerHTML = `<img loading="lazy" src="${url}"><div class="check">✓</div>`;
      // click/tap toggle
      d.addEventListener('click', ()=>{
        if(!state.multiple && state.selected.size) state.selected.clear();
        if(d.classList.toggle('selected')) state.selected.add(url);
        else state.selected.delete(url);
        updateSelUI();
      });
      return d;
    }

    function renderResults(list){
      const host=$('results'); host.innerHTML='';
      list.forEach(x=>host.appendChild(imgCard(x)));
      $('status').textContent=list.length?`मिले: ${list.length}`:'कोई मैच नहीं मिला';
    }

    async function jpegFromCanvas(canvas, q=0.92){
      return new Promise(res=>canvas.toBlob(b=>res(new File([b],'selfie.jpg',{type:'image/jpeg'})),'image/jpeg',q));
    }

    // camera
    let stream;
    $('startCam').onclick=async ()=>{
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
        $('cam').srcObject=stream;
      }catch(e){ toast('camera error'); }
    };
    $('stopCam').onclick=()=>{
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; $('cam').srcObject=null; }
    };
    $('snap').onclick=()=>{
      if(!stream){ toast('camera off'); return; }
      const v=$('cam'), c=$('shot');
      c.width=v.videoWidth; c.height=v.videoHeight;
      c.getContext('2d').drawImage(v,0,0,c.width,c.height);
      c.style.display='block';
    };

    // SEARCH
    async function doSearch(){
      if(!state.apiBase){ toast('सेव API URL'); return; }
      const base=build(state.apiBase);
      const ev=$('eventId').value;
      let imgB64='';

      // prefer canvas if snapped
      const c=$('shot');
      if(c.style.display==='block'){
        const f=await jpegFromCanvas(c,0.9);
        imgB64=await fileToBase64(f);
      }else if($('file').files[0]){
        const f=$('file').files[0];
        imgB64=await fileToBase64(f);
      }else{
        toast('कृपया फोटो दें'); return;
      }

      const body={ eventId:ev, imageBase64:imgB64, name:$('name').value.trim(), phone:$('phone').value.trim() };
      const r=await safeFetch(base.search,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const j=await safeJson(r);
      const items = j?.matches || j?.results || j || [];
      state.results = Array.isArray(items) ? items : [];
      state.selected.clear();
      renderResults(state.results);
      updateSelUI();
    }

    async function fileToBase64(f){ const b=await f.arrayBuffer(); const u=new Uint8Array(b); let s=''; for (let i=0;i<u.length;i++) s+=String.fromCharCode(u[i]); return 'data:'+f.type+';base64,'+btoa(s); }

    // multi select toggle
    $('msToggle').onclick=()=>{
      state.multiple = !state.multiple;
      $('msState').textContent = state.multiple?'ON':'OFF';
      if(!state.multiple && state.selected.size>1){
        // keep only one
        const first=[...state.selected][0]; state.selected=new Set([first]);
        // update DOM
        document.querySelectorAll('.photo').forEach(p=>{
          p.classList.toggle('selected', p.dataset.u===first);
        });
        updateSelUI();
      }
    };

    $('selAll').onclick=()=>{
      document.querySelectorAll('.photo').forEach(p=>{ p.classList.add('selected'); state.selected.add(p.dataset.u); });
      updateSelUI();
    };
    $('selClear').onclick=()=>{
      document.querySelectorAll('.photo').forEach(p=>p.classList.remove('selected'));
      state.selected.clear(); updateSelUI();
    };

    // download
    $('downloadSel').onclick=()=>{
      if(!state.selected.size){ toast('कुछ select करें'); return; }
      [...state.selected].forEach(u=>{
        const a=document.createElement('a'); a.href=u; a.download='photo.jpg'; document.body.appendChild(a); a.click(); a.remove();
      });
    };

    // base URL & events
    $('saveApi').onclick=()=>{
      const v=$('apiBase').value.trim();
      if(!/^https?:\/\//i.test(v) || !v.includes('execute-api')){ toast('सही stage URL दें'); return; }
      state.apiBase=v; localStorage.setItem('apiBase',v); loadEvents();
    };

    $('searchBtn').onclick=doSearch;

    // boot
    (function init(){
      state.apiBase = localStorage.getItem('apiBase')||'';
      $('apiBase').value = state.apiBase;
      if(state.apiBase) loadEvents();
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WedMatch — Selfie Search</title>

  <!-- ZIP download libs -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --brand:#ff8a00; --brand-d:#f27700; --ink:#0f1720; --muted:#667085;
      --bg:#fff9f2; --card:#fff; --bd:#f1e4d4; --sel:#1f2937; --ok:#16a34a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 system-ui,Segoe UI,Roboto,Arial}
    header{background:var(--brand);color:#111;padding:14px 18px;font-weight:700}
    main{max-width:1100px;margin:0 auto;padding:16px}

    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;margin-bottom:14px}
    label{display:block;font-weight:600;margin:6px 0 4px}
    input,select,button{width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:10px;background:#fff}
    input:focus,select:focus{outline:2px solid #ffd7a6;border-color:#ffd7a6}
    .row{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:12px}

    /* Buttons small & clean */
    .btn{background:var(--brand);border:none;border-radius:10px;color:#111;font-weight:700;cursor:pointer;padding:10px 14px}
    .btn:hover{background:var(--brand-d)}
    .btn.secondary{background:#111;color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--bd);color:var(--ink)}
    .btn.block{width:100%}

    /* Camera */
    #video{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;border:1px solid var(--bd)}

    /* Thumbs grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .thumb{position:relative;background:#fff;border:1px solid var(--bd);border-radius:12px;overflow:hidden}
    .thumb img{width:100%;height:140px;object-fit:cover;display:block}
    .thumb .cap{padding:8px;font-size:12px;color:var(--muted)}
    .thumb input[type="checkbox"]{position:absolute;top:8px;left:8px;width:18px;height:18px}
    .thumb.sel{outline:2px solid var(--sel);}

    .toolbar{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#111;color:#fff;font-size:12px}

    @media (max-width:720px){
      .grid-2{grid-template-columns:1fr}
      .toolbar{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<header>WedMatch — Selfie Search</header>
<main>

  <!-- Search form -->
  <section class="card">
    <div class="row grid-2">
      <div>
        <label>नाम</label>
        <input id="name" placeholder="आपका नाम (optional)">
      </div>
      <div>
        <label>मोबाइल नंबर</label>
        <input id="phone" placeholder="मोबाइल (optional)">
      </div>
    </div>

    <div class="row grid-2" style="margin-top:10px">
      <div>
        <label>सेल्फी कैमरा</label>
        <video id="video" autoplay muted playsinline></video>
        <div class="actions" style="margin-top:8px">
          <button class="btn" id="camOn">कैमरा चालू करें</button>
          <button class="btn ghost" id="snap">फोटो कैप्चर</button>
          <button class="btn secondary" id="camOff">कैमरा बंद</button>
        </div>
      </div>
      <div>
        <label>या फ़ाइल चुनें</label>
        <input id="file" type="file" accept="image/*">
        <div class="muted" style="margin-top:6px">PNG/WebP → JPEG auto.</div>

        <div class="actions" style="margin-top:12px">
          <button class="btn block" id="doSearch">Search</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Results / selection -->
  <section class="card">
    <div class="actions" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <div>
        <span class="badge" id="multiState">Multiple select: ON</span>
        <span class="badge" id="selCount">Selected: 0</span>
      </div>
      <div class="muted" id="msg">कोई मै‍च नहीं मिला</div>
    </div>

    <div class="toolbar" style="margin-bottom:10px">
      <button class="btn ghost" id="btnSelectAll">Select All</button>
      <button class="btn ghost" id="btnClear">Clear</button>
      <button class="btn" id="btnDownload">Download Selected</button>
    </div>

    <div id="grid" class="grid"></div>
  </section>

</main>

<script>
  // =============== CONFIG ===============
  // अपने API Gateway वाले base को यहां भरें या localStorage से सेट करें।
  const API_BASE = localStorage.getItem('apiBase') || 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';

  // डाउनलोड fallback: यदि imageUrl सीधे नहीं खुलता तो /download?key=.. पर जाएँ
  const DOWNLOAD_FALLBACK = true;

  // =============== CAMERA ===============
  const video = document.getElementById('video');
  let stream;

  document.getElementById('camOn').onclick = async () => {
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      video.srcObject = stream;
    }catch(e){ alert('कैमरा उपलब्ध नहीं: '+e.message); }
  };
  document.getElementById('camOff').onclick = () => {
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; }
  };
  document.getElementById('snap').onclick = () => {
    if(!video.srcObject){ alert('पहले कैमरा चालू करें'); return; }
    const c=document.createElement('canvas'); c.width=video.videoWidth; c.height=video.videoHeight;
    c.getContext('2d').drawImage(video,0,0);
    c.toBlob(b=>{
      const f=new File([b],'selfie.jpg',{type:'image/jpeg'});
      runSearch(f);
    },'image/jpeg',0.92);
  };

  // =============== SEARCH ===============
  document.getElementById('doSearch').onclick = () => {
    const f = document.getElementById('file').files?.[0];
    if(!f){ alert('कृपया selfie upload करें या कैमरा से कैप्चर करें'); return; }
    runSearch(f);
  };

  async function runSearch(file){
    setMsg('Searching...');
    clearGrid();

    // PNG/WebP → JPEG
    const jpeg = await toJpeg(file);

    // formdata → /search
    const url = API_BASE + '/search';
    const fd = new FormData();
    fd.append('name', document.getElementById('name').value||'');
    fd.append('phone', document.getElementById('phone').value||'');
    fd.append('file', jpeg, 'selfie.jpg');

    let res;
    try{
      res = await fetch(url, { method:'POST', body:fd });
    }catch(e){
      setMsg('नेटवर्क त्रुटि');
      return;
    }

    const txt = await res.text();
    let data; try{ data=JSON.parse(txt); }catch{ data={_raw:txt}; }
    if(!res.ok){ setMsg('Search failed'); console.log(data); return; }

    const matches = data.matches || [];
    if(!matches.length){ setMsg('कोई मैच नहीं मिला'); return; }

    fillGrid(matches);
    setMsg(`मिले: ${matches.length}`);
  }

  function setMsg(t){ document.getElementById('msg').textContent=t; }

  async function toJpeg(file,maxDim=1600,quality=0.9){
    if(/jpe?g$/i.test(file.name) && /jpe?g/i.test(file.type)) return file;
    const img = await blobToImage(file);
    const w=img.width,h=img.height; let nw=w,nh=h;
    if(Math.max(w,h)>maxDim){const k=maxDim/Math.max(w,h); nw=Math.round(w*k); nh=Math.round(h*k);}
    const c=document.createElement('canvas'); c.width=nw; c.height=nh;
    c.getContext('2d').drawImage(img,0,0,nw,nh);
    const b=await new Promise(r=>c.toBlob(r,'image/jpeg',quality));
    return new File([b],file.name.replace(/\.\w+$/,'.jpg'),{type:'image/jpeg'});
  }
  function blobToImage(file){
    return new Promise((res,rej)=>{
      const u=URL.createObjectURL(file), i=new Image();
      i.onload=()=>{URL.revokeObjectURL(u);res(i)}; i.onerror=e=>{URL.revokeObjectURL(u);rej(e)}; i.src=u;
    });
  }

  // =============== GRID / SELECT ===============
  const grid = document.getElementById('grid');
  const selected = new Set();

  function clearGrid(){
    grid.innerHTML=''; selected.clear(); updateSelCount();
  }
  function updateSelCount(){
    document.getElementById('selCount').textContent=`Selected: ${selected.size}`;
  }

  function fillGrid(matches){
    grid.innerHTML='';
    matches.forEach((m,idx)=>{
      // m.imageUrl या m.signedUrl या s3Key
      const key = m.s3Key || m.photoId || '';
      const baseUrl = m.imageUrl || m.signedUrl || (DOWNLOAD_FALLBACK ? `${API_BASE}/download?key=${encodeURIComponent(key)}` : '');
      const card = document.createElement('div');
      card.className='thumb';
      card.innerHTML = `
        <input type="checkbox" data-id="${idx}">
        <img loading="lazy" src="${baseUrl}">
        <div class="cap">${key.split('/').pop() || 'photo'}</div>
      `;
      const cb = card.querySelector('input');
      cb.addEventListener('change',()=>{
        if(cb.checked){ selected.add(idx); card.classList.add('sel'); }
        else{ selected.delete(idx); card.classList.remove('sel'); }
        updateSelCount();
      });
      grid.appendChild(card);
    });
  }

  // Select/Clear
  document.getElementById('btnSelectAll').onclick = ()=>{
    [...grid.querySelectorAll('input[type="checkbox"]')].forEach(cb=>{ cb.checked=true; cb.dispatchEvent(new Event('change')); });
  };
  document.getElementById('btnClear').onclick = ()=>{
    [...grid.querySelectorAll('input[type="checkbox"]')].forEach(cb=>{ cb.checked=false; cb.dispatchEvent(new Event('change')); });
  };

  // =============== DOWNLOAD SELECTED (ZIP) ===============
  document.getElementById('btnDownload').onclick = async ()=>{
    if(!grid.children.length){ alert('पहले सर्च करें'); return; }
    const picks = [...grid.querySelectorAll('.thumb')].filter(t=>t.querySelector('input').checked);
    if(!picks.length){ alert('कोई फ़ोटो select नहीं है'); return; }

    setMsg('Preparing ZIP…');

    const zip = new JSZip();
    let done = 0;

    for(const t of picks){
      const img = t.querySelector('img');
      const name = (t.querySelector('.cap')?.textContent?.trim() || `photo_${Date.now()}`).replace(/\s+/g,'_');
      try{
        const u = img.src;
        const b = await fetch(u,{mode:'cors'}).then(r=>r.blob());
        zip.file(name, b);
        done++;
        setMsg(`Added ${done}/${picks.length}`);
      }catch(e){
        console.warn('download fail', e);
      }
    }

    const blob = await zip.generateAsync({type:'blob'});
    saveAs(blob, `wedmatch_${new Date().toISOString().slice(0,10)}.zip`);
    setMsg(`ZIP ready (${done} files)`);
  };
</script>
</body>
</html>

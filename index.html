<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WedMatch — Selfie Search</title>

  <!-- ZIP download libs -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    :root{
      --brand:#ff8a00; --brand-d:#ef7a00; --ink:#0f1720; --muted:#667085;
      --bg:#fff9f2; --card:#fff; --bd:#efe0cf; --sel:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 system-ui,Segoe UI,Roboto,Arial}
    header{background:var(--brand);color:#111;padding:14px 18px;font-weight:700}
    main{max-width:1150px;margin:0 auto;padding:16px}

    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:16px;margin-bottom:14px}
    label{display:block;font-weight:600;margin:6px 0 4px}
    input,select,button{width:100%;padding:11px 12px;border:1px solid var(--bd);border-radius:10px;background:#fff}
    input:focus{outline:2px solid #ffd7a6;border-color:#ffd7a6}
    .row{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}
    .muted{color:var(--muted);font-size:12px}
    .btn{background:var(--brand);border:none;border-radius:10px;color:#111;font-weight:700;cursor:pointer;padding:11px 14px}
    .btn:hover{background:var(--brand-d)}
    .btn.secondary{background:#111;color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--bd);color:var(--ink)}
    .btn.block{width:100%}

    /* Camera */
    #video{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;border:1px solid var(--bd)}

    /* Toolbar */
    .toolbar{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:6px 0 2px}

    /* Results grid */
    #count{font-size:12px;color:#6b7280}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .tile{position:relative;border:1px solid var(--bd);border-radius:12px;background:#fff;overflow:hidden}
    .tile img{width:100%;height:180px;object-fit:cover;display:block;background:#faf7f2}
    .tile .cap{padding:8px 10px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#475569}
    .tile input[type="checkbox"]{position:absolute;top:8px;left:8px;width:18px;height:18px}
    .tile.sel{outline:2px solid var(--sel)}
    .badimg{display:flex;align-items:center;justify-content:center;height:180px;color:#999;font-size:12px;background:#f8f8f8}

    .tag{display:inline-block;background:#111;color:#fff;border-radius:999px;padding:4px 10px;font-size:12px;margin-right:6px}

    @media (max-width:820px){
      .grid-2{grid-template-columns:1fr}
      .toolbar{grid-template-columns:1fr}
      .grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
      .tile img{height:150px}
    }
  </style>
</head>
<body>
<header>WedMatch — Selfie Search</header>
<main>

  <!-- Form -->
  <section class="card">
    <div class="row grid-2">
      <div>
        <label>नाम</label>
        <input id="name" placeholder="आपका नाम (optional)" />
      </div>
      <div>
        <label>मोबाइल नंबर</label>
        <input id="phone" placeholder="मोबाइल (optional)" />
      </div>
    </div>

    <div class="row grid-2" style="margin-top:12px">
      <div>
        <label>सेल्फी कैमरा</label>
        <video id="video" autoplay muted playsinline></video>
        <div class="row" style="grid-template-columns:1fr 1fr 1fr;margin-top:8px">
          <button class="btn" id="camOn">कैमरा चालू करें</button>
          <button class="btn ghost" id="snap">फोटो कैप्चर</button>
          <button class="btn secondary" id="camOff">कैमरा बंद</button>
        </div>
      </div>
      <div>
        <label>या फ़ाइल चुनें</label>
        <input id="file" type="file" accept="image/*" />
        <div class="muted" style="margin-top:6px">PNG/WebP → JPEG auto.</div>
        <button class="btn block" style="margin-top:12px" id="doSearch">Search</button>
      </div>
    </div>
  </section>

  <!-- Results -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div>
        <span class="tag" id="multi">Multiple select: ON</span>
        <span class="tag" id="selCount">Selected: 0</span>
      </div>
      <div id="msg" class="muted">—</div>
    </div>

    <div class="toolbar">
      <button class="btn ghost" id="btnSelectAll">Select All</button>
      <button class="btn ghost" id="btnClear">Clear</button>
      <button class="btn" id="btnDownload">Download Selected</button>
    </div>

    <div style="text-align:right;margin:6px 2px 10px 0" id="count"></div>
    <div id="grid" class="grid"></div>
  </section>

</main>

<script>
/* ---------------- CONFIG ----------------- */
// अपने API Gateway वाले base को चाहे तो localStorage में सेव रखें।
const API_BASE = localStorage.getItem('apiBase') ||
                  'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';

// fallback download हमेशा रखें — S3/CORS fail होने पर इमेज फिर भी दिखे
const buildDownload = (key) =>
  `${API_BASE}/download?key=${encodeURIComponent(key||'')}`;

/* ---------------- CAMERA ----------------- */
const video = document.getElementById('video');
let stream;

document.getElementById('camOn').onclick = async () => {
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'user'} });
    video.srcObject = stream;
  }catch(e){ alert('कैमरा उपलब्ध नहीं: '+e.message); }
};
document.getElementById('camOff').onclick = () => {
  if(stream){ stream.getTracks().forEach(t=>t.stop()); }
  stream = null; video.srcObject = null;
};
document.getElementById('snap').onclick = () => {
  if(!video.srcObject){ alert('पहले कैमरा चालू करें'); return; }
  const c=document.createElement('canvas'); c.width=video.videoWidth; c.height=video.videoHeight;
  c.getContext('2d').drawImage(video,0,0);
  c.toBlob(b=>{
    const f=new File([b],'selfie.jpg',{type:'image/jpeg'});
    runSearch(f);
  },'image/jpeg',0.9);
};

/* ---------------- SEARCH ----------------- */
const msg = (t)=> document.getElementById('msg').textContent = t;

document.getElementById('doSearch').onclick = () => {
  const f = document.getElementById('file').files?.[0];
  if(!f && !video.srcObject){ alert('कृपया फ़ाइल चुनें या कैमरा से फोटो लें'); return; }
  if(f) runSearch(f);
  else document.getElementById('snap').click();
};

async function runSearch(file){
  msg('Searching…'); clearGrid();

  const jpeg = await toJpeg(file);
  const url = API_BASE + '/search';
  const fd = new FormData();
  fd.append('name',  document.getElementById('name').value||'');
  fd.append('phone', document.getElementById('phone').value||'');
  fd.append('file',  jpeg, 'selfie.jpg');

  let res;
  try{ res = await fetch(url,{method:'POST',body:fd}); }
  catch(e){ msg('नेटवर्क त्रुटि'); return; }

  const txt = await res.text(); let data;
  try{ data = JSON.parse(txt); }catch{ data={_raw:txt}; }

  if(!res.ok){ console.warn('search fail',data); msg('Search failed'); return; }

  const matches = Array.isArray(data.matches)? data.matches : [];
  if(!matches.length){ msg('कोई मैच नहीं मिला'); setCount(0); return; }
  fillGrid(matches);
  setCount(matches.length);
  msg('मिले: ' + matches.length);
}

function setCount(n){ document.getElementById('count').textContent = 'मिले: '+n; }

/* ---------- Image helpers (PNG/WebP→JPEG) --------- */
async function toJpeg(file,maxDim=1600,quality=0.92){
  if(/jpe?g$/i.test(file.name) && /jpe?g/i.test(file.type)) return file;
  const img = await blobToImage(file);
  let [w,h]=[img.width,img.height]; let [nw,nh]=[w,h];
  if(Math.max(w,h)>maxDim){ const k=maxDim/Math.max(w,h); nw=Math.round(w*k); nh=Math.round(h*k); }
  const c=document.createElement('canvas'); c.width=nw; c.height=nh;
  c.getContext('2d').drawImage(img,0,0,nw,nh);
  const b=await new Promise(r=>c.toBlob(r,'image/jpeg',quality));
  return new File([b], file.name.replace(/\.\w+$/,'.jpg'), {type:'image/jpeg'});
}
function blobToImage(file){
  return new Promise((res,rej)=>{
    const u=URL.createObjectURL(file), i=new Image();
    i.onload=()=>{URL.revokeObjectURL(u);res(i)}; i.onerror=e=>{URL.revokeObjectURL(u);rej(e)}; i.src=u;
  });
}

/* ---------------- GRID / SELECT ----------------- */
const grid = document.getElementById('grid');
const selected = new Set();

function clearGrid(){ grid.innerHTML=''; selected.clear(); updSel(); }
function updSel(){ document.getElementById('selCount').textContent = 'Selected: '+selected.size; }

function primaryImageSrc(m){
  // backend अलग-अलग फ़ील्ड दे सकता है
  return m.thumbUrl || m.imageUrl || m.url || m.signedUrl || '';
}
function keyFrom(m){
  return m.s3Key || m.key || m.photoId || m.id || '';
}
function nameFrom(m){
  const k = keyFrom(m);
  return (k && k.split('/').pop()) || m.filename || 'photo';
}

function imgFallback(ev){
  const img = ev.target;
  if(img.dataset.fallbackDone === '1'){ // दूसरे भी फेल हुए तो placeholder
    img.replaceWith(Object.assign(document.createElement('div'),{className:'badimg',textContent:'preview unavailable'}));
    return;
  }
  img.dataset.fallbackDone = '1';
  const k = img.dataset.key || '';
  img.crossOrigin = 'anonymous';
  img.src = buildDownload(k); // Lambda /download
}

function fillGrid(matches){
  grid.innerHTML='';
  matches.forEach((m,idx)=>{
    const key  = keyFrom(m);
    const name = nameFrom(m);
    const first = primaryImageSrc(m);
    const fallback = buildDownload(key);

    const card = document.createElement('div');
    card.className='tile';
    card.innerHTML = `
      <input type="checkbox" data-idx="${idx}">
      <img loading="lazy" crossorigin="anonymous" data-key="${key}">
      <div class="cap" title="${name}">${name}</div>
    `;
    const cb  = card.querySelector('input');
    const img = card.querySelector('img');

    // src set + onerror fallback
    img.onerror = imgFallback;
    img.dataset.key = key;
    img.src = first || fallback;

    cb.addEventListener('change',()=>{
      if(cb.checked){ selected.add(idx); card.classList.add('sel'); }
      else{ selected.delete(idx); card.classList.remove('sel'); }
      updSel();
    });

    grid.appendChild(card);
  });
}

/* Select/Clear */
document.getElementById('btnSelectAll').onclick = ()=>{
  [...grid.querySelectorAll('input[type="checkbox"]')].forEach(cb=>{
    cb.checked = true; cb.dispatchEvent(new Event('change'));
  });
};
document.getElementById('btnClear').onclick = ()=>{
  [...grid.querySelectorAll('input[type="checkbox"]')].forEach(cb=>{
    cb.checked = false; cb.dispatchEvent(new Event('change'));
  });
};

/* --------------- DOWNLOAD (ZIP) ----------------- */
document.getElementById('btnDownload').onclick = async ()=>{
  const picks = [...grid.querySelectorAll('.tile')].filter(t=>t.querySelector('input').checked);
  if(!picks.length){ alert('कोई फ़ोटो select नहीं है'); return; }
  msg('Preparing ZIP…');

  const zip = new JSZip(); let ok=0;
  for(const t of picks){
    const img = t.querySelector('img');
    const name = (t.querySelector('.cap').textContent || ('photo_'+Date.now())).replace(/\s+/g,'_');
    try{
      const b = await fetch(img.src,{mode:'cors'}).then(r=>r.blob());
      zip.file(name, b); ok++;
      msg(`Added ${ok}/${picks.length}`);
    }catch(e){
      // primary url fail हो तो fallback से लें
      try{
        const fb = buildDownload(img.dataset.key||'');
        const b = await fetch(fb,{mode:'cors'}).then(r=>r.blob());
        zip.file(name, b); ok++;
      }catch(_){}
    }
  }
  const blob = await zip.generateAsync({type:'blob'});
  saveAs(blob, `wedmatch_${new Date().toISOString().slice(0,10)}.zip`);
  msg(`ZIP ready (${ok} files)`);
};
</script>
</body>
</html>

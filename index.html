<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>भारतीय जनता पार्टी — मंदसौर (Face Search)</title>
  <style>
    :root{
      --brand:#ff8700;
      --dark:#1a1a1a;
      --soft:#fff4e9;
      --border:#eee;
      --danger:#fbe3e3;
      --danger-text:#8a1f1f;
      --ok:#0a7f2e;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;margin:0;background:#fff6ef}
    header{background:var(--brand);color:#111;font-weight:700;padding:10px 16px}
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.04);padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:820px){ .grid{grid-template-columns:1fr} }
    label{font-size:13px;color:#555;margin:4px 0;display:block}
    input[type=text],input[type=tel]{width:100%;box-sizing:border-box;padding:12px 12px;border:1px solid #ddd;border-radius:10px;font-size:16px;background:#fff}
    input:invalid{outline:0}
    .row{margin-bottom:14px}
    .btn{background:var(--brand);color:#111;font-weight:700;border:0;border-radius:12px;padding:14px 18px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.secondary{background:#111;color:#fff}
    .btn.ghost{background:#f3f3f3;color:#111}
    .note{font-size:13px;color:#555;margin-top:6px}
    .danger{background:var(--danger);border:1px solid #f7cdcd;color:var(--danger-text);padding:10px 12px;border-radius:10px}
    .ok{color:var(--ok);font-weight:600}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .videoShell{position:relative;background:#000;border-radius:12px;overflow:hidden}
    video{width:100%;height:auto;display:block;background:#000}
    canvas{display:none}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .thumb{border:1px solid #eee;border-radius:10px;overflow:hidden;background:#fff}
    .thumb img{width:100%;height:160px;object-fit:cover;display:block;background:#fafafa}
    .thumb .meta{padding:8px 10px;font-size:12px;color:#444;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .pill{padding:2px 8px;border-radius:999px;background:#f2f2f2;font-size:11px}
    .footbar{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
    .hidden{display:none!important}

    /* मोबाइल पर फाइल इनपुट छुपाएँ */
    @media (max-width:640px){
      .fileRow{display:none}
    }

    /* प्रोग्रेस */
    .spinner{width:18px;height:18px;border:3px solid #fff;border-right-color:transparent;border-radius:50%;display:inline-block;animation:spin 0.8s linear infinite;vertical-align:-3px;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    footer{opacity:.6;font-size:12px;margin:20px 0 8px;text-align:center}
  </style>
</head>
<body>
<header>भारतीय जनता पार्टी — मंदसौर (Face Search)</header>

<div class="wrap">
  <div class="card">
    <div class="grid">
      <!-- Left: Camera -->
      <div>
        <div class="row">
          <label for="name">नाम (अनिवार्य)</label>
          <input id="name" type="text" placeholder="आपका नाम" required />
        </div>

        <div class="row">
          <label for="mobile">मोबाइल नंबर (अनिवार्य)</label>
          <input id="mobile" type="tel" inputmode="numeric" pattern="[0-9]{10}" maxlength="10" placeholder="10 अंकों का मोबाइल" required />
        </div>

        <div class="row videoShell">
          <video id="video" playsinline muted autoplay></video>
          <canvas id="canvas"></canvas>
        </div>

        <div class="bar" style="margin-top:10px">
          <button id="btnSnap" class="btn">सेल्फी लें</button>
          <button id="btnRetake" class="btn ghost">दोबारा लें</button>
          <span id="selfieState" class="note"></span>
        </div>
      </div>

      <!-- Right: Search + Results -->
      <div>
        <div class="row fileRow">
          <label for="file">या फ़ाइल चुनें</label>
          <input id="file" type="file" accept="image/*" capture="user" />
          <div class="note">PNG/WebP → JPEG auto.</div>
        </div>

        <div class="row">
          <button id="btnSearch" class="btn" style="width:100%">
            <span class="btnLabel">Search</span>
          </button>
          <div id="help" class="note">* मोबाइल पर कैमरा अपने-आप खुलेगा (Allow दें)। फ़ाइल अपलोड की ज़रूरत नहीं।</div>
        </div>

        <div id="alert" class="danger hidden"></div>

        <div id="results" class="row hidden">
          <div class="ok" id="resultTitle" style="margin:6px 0 10px"></div>
          <div class="thumbs" id="thumbs"></div>
          <div class="footbar">
            <div id="countNote" class="note"></div>
            <button id="btnNext" class="btn ghost hidden">Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>Made for field use • Camera opens only with your permission</footer>
</div>

<script>
/*** ====== CONFIG ====== ***/
const API_BASE = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
const SEARCH_URL   = API_BASE + '/search';
const DOWNLOAD_URL = API_BASE + '/download';

/*** ====== DOM ====== ***/
const el = id => document.getElementById(id);
const video = el('video');
const canvas = el('canvas');
const file   = el('file');
const nameInp = el('name');
const mobileInp = el('mobile');
const alertBox = el('alert');
const btnSnap = el('btnSnap');
const btnRetake = el('btnRetake');
const btnSearch = el('btnSearch');
const btnNext = el('btnNext');
const thumbs = el('thumbs');
const resultsWrap = el('results');
const resultTitle = el('resultTitle');
const countNote = el('countNote');
const selfieState = el('selfieState');

let stream;
let lastSelfieDataURL = null;
let nextCursor = null;

/*** ====== Utils ====== ***/
function showAlert(msg){
  alertBox.textContent = msg;
  alertBox.classList.remove('hidden');
}
function clearAlert(){
  alertBox.classList.add('hidden');
  alertBox.textContent = '';
}
const sleep = ms => new Promise(r => setTimeout(r, ms));

async function fetchJSON(url, opts={}, timeout=20000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort('timeout'), timeout);
  try{
    const res = await fetch(url, {...opts, signal: ctrl.signal});
    const isJSON = (res.headers.get('content-type') || '').includes('application/json');
    const data = isJSON ? await res.json().catch(()=>({})) : await res.text();
    return { ok: res.ok, status: res.status, data };
  }catch(err){
    return { ok:false, status:0, data:{ error: String(err && err.message || err) } };
  }finally{ clearTimeout(t); }
}

/*** ====== Camera ====== ***/
async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: {ideal:1280}, height: {ideal:720} },
      audio: false
    });
    video.srcObject = stream;
    selfieState.textContent = '';
  }catch(err){
    console.error('camera error', err);
    showAlert('कैमरा नहीं खुला। कृपया परमिशन दें या फ़ाइल चुनें।');
  }
}
function stopCamera(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
}
function takeSelfie(){
  const vw = video.videoWidth || 1280;
  const vh = video.videoHeight || 720;
  const maxW = 960;              // compress for upload
  const scale = Math.min(1, maxW / vw);
  canvas.width = Math.round(vw * scale);
  canvas.height = Math.round(vh * scale);
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataURL = canvas.toDataURL('image/jpeg', 0.92);
  lastSelfieDataURL = dataURL;
  const bytes = Math.round((dataURL.length * 3/4) / 1024);
  selfieState.innerHTML = `<span class="ok">सेल्फी तैयार ✔</span> <span class="note">(~ ${bytes} KB)</span>`;
  return dataURL;
}

/*** ====== Results Render ====== ***/
function normalizeItems(items){
  // Allow various shapes: {s3Key} or {key} or string
  return (items||[]).map(it=>{
    if(typeof it === 'string') return { key: it, photoId: it.split('/').pop() };
    const key = it.s3Key || it.key || it.s3key || it.s3_path || it.s3 || '';
    const id  = it.photoId || it.photod || it.id || (key ? key.split('/').pop() : '');
    return { key, photoId: id, ...it };
  });
}
function render(items, total){
  thumbs.innerHTML = '';
  const list = normalizeItems(items);
  for(const p of list){
    if(!p.key) continue;
    const url = `${DOWNLOAD_URL}?key=${encodeURIComponent(p.key)}`;
    const div = document.createElement('div');
    div.className = 'thumb';
    div.innerHTML = `
      <img loading="lazy" src="${url}" alt="${p.photoId||''}">
      <div class="meta">
        <span class="pill">${p.photoId || 'photo'}</span>
        <a class="btn small" href="${url}" download target="_blank" style="text-decoration:none;padding:6px 10px;border-radius:8px;background:#111;color:#fff">Download</a>
      </div>`;
    thumbs.appendChild(div);
  }
  resultTitle.textContent = `मिले फ़ोटो`;
  countNote.textContent = total ? `कुल ~ ${total}` : '';
  resultsWrap.classList.remove('hidden');
  btnNext.classList.toggle('hidden', !nextCursor);
}

/*** ====== Search ====== ***/
async function doSearch(cursor=null){
  clearAlert();

  const name = (nameInp.value||'').trim();
  const mobile = (mobileInp.value||'').trim();

  if(!name){ showAlert('कृपया नाम भरें।'); return; }
  if(!/^\d{10}$/.test(mobile)){ showAlert('कृपया 10 अंकों का मोबाइल भरें।'); return; }

  // Prefer selfie, else file input
  let dataURL = lastSelfieDataURL;
  if(!dataURL && file.files && file.files[0]){
    const blob = file.files[0];
    dataURL = await new Promise(res=>{
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.readAsDataURL(blob);
    });
  }
  if(!dataURL){ showAlert('कृपया पहले सेल्फी लें (या फ़ाइल चुनें)।'); return; }

  // UI state
  const label = btnSearch.querySelector('.btnLabel');
  const oldText = label.textContent;
  label.innerHTML = `<span class="spinner"></span>Searching…`;
  btnSearch.disabled = true;

  const b64 = toBase64(dataURL);  // "data:..." से सिर्फ़ base64 हिस्सा
const payload = {
  name, mobile,
  image: b64,                   // ✅ अब सिर्फ base64 जाएगा
  eventId: eventId || undefined,
  cursor: cursor || null,
  pageSize: 12
};


    const res = await fetchJSON(SEARCH_URL, {
      method:'POST',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(payload)
    }, 25000);

   if(!res.ok){
  console.error('search error', res);
  const msg = (res.data && (res.data.message || res.data.error ||
             (typeof res.data==='string' ? res.data : JSON.stringify(res.data)))) || 'Bad Request';
  showAlert(`API ${res.status}: ${msg}`);
  label.textContent=old; btnSearch.disabled=false;
  return;
}


    // Expected generic shape. We try to be flexible.
    const data = res.data || {};
    const items = data.items || data.photos || data.results || [];
    nextCursor = data.nextCursor || data.next || data.cursor || data.LastEvaluatedKey || null;
    const total = data.total || data.count || items.length;

    render(items, total);

  }catch(err){
    console.error(err);
    showAlert('सर्वर/नेटवर्क में समस्या आई।');
  }finally{
    label.textContent = oldText;
    btnSearch.disabled = false;
  }
}

/*** ====== Events ====== ***/
btnSnap.addEventListener('click', () => {
  takeSelfie();
});
btnRetake.addEventListener('click', async () => {
  lastSelfieDataURL = null;
  selfieState.textContent = '';
  await startCamera();
});
btnSearch.addEventListener('click', () => doSearch());
btnNext.addEventListener('click', () => doSearch(nextCursor));

// जैसे ही पेज फोकस में आए और वीडियो रुका हो, कैमरा फिर से कोशिश करे (मोबाइल iOS fix)
window.addEventListener('focus', async ()=>{
  if(!video.srcObject && !lastSelfieDataURL){
    await startCamera();
  }
});

// ऑटो-स्टार्ट कैमरा
(async function init(){
  // मोबाइल पर फाइल-इनपुट छुपा है; फिर भी fallback रहेगा
  await startCamera();
})();
</script>
</body>
</html>

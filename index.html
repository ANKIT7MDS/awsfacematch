<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WedMatch — Upload & Search</title>
  <style>
    :root { --bg:#0b1020; --card:#141a2f; --muted:#90a0c0; --text:#eaf0ff; --accent:#6aa1ff; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial}
    header{padding:18px 16px;border-bottom:1px solid #202a4a;background:#0f1528;position:sticky;top:0;z-index:2}
    header h1{margin:0;font-size:18px}
    .container{max-width:1000px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid #202a4a;border-radius:14px;padding:16px;box-shadow:0 1px 0 #000}
    h2{margin:0 0 10px;font-size:16px}
    label{display:block;margin:8px 0 4px;color:var(--muted)}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a355e;background:#0f1528;color:var(--text)}
    input[type=file]{padding:8px}
    button{cursor:pointer;background:linear-gradient(180deg,#3b67ff,#3155d8);border:0}
    button.secondary{background:#1b2342}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .muted{color:var(--muted)}
    .pill{display:inline-block;background:#1b2342;border:1px solid #2a355e;border-radius:999px;padding:4px 10px;font-size:12px}
    .results{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
    .result{background:#0f1528;border:1px solid #263159;border-radius:12px;overflow:hidden}
    .result .meta{padding:10px;border-top:1px solid #263159}
    code{background:#0e1324;border:1px solid #1e294e;color:#cde; padding:2px 4px;border-radius:6px}
    .tiny{font-size:12px}
    .ok{color:#7ef293}
    .err{color:#ff8a8a}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid #2a355e;border-top-color:#6aa1ff;border-radius:50%;animation:spin .9s linear infinite;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}
    a.btn{display:inline-block;text-decoration:none;color:#fff;background:#2b4dd8;padding:8px 10px;border-radius:10px}
    .sep{height:1px;background:#202a4a;margin:14px 0}
  </style>
</head>
<body>
<header>
  <h1>WedMatch — Upload & Search</h1>
</header>
<div class="container">

  <!-- CONFIG -->
  <div class="card">
    <h2>Config</h2>
    <div class="row">
      <div>
        <label>API: /upload-url</label>
        <input id="cfgUpload" placeholder="https://<api-id>.execute-api.ap-south-1.amazonaws.com/PROD2/upload-url" />
      </div>
      <div>
        <label>API: /search</label>
        <input id="cfgSearch" placeholder="https://<api-id>.execute-api.ap-south-1.amazonaws.com/PROD2/search" />
      </div>
      <div>
        <label>API: /download</label>
        <input id="cfgDownload" placeholder="https://<api-id>.execute-api.ap-south-1.amazonaws.com/PROD2/download" />
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>S3 Bucket</label>
        <input id="cfgBucket" placeholder="wedmatch-photos" />
      </div>
      <div>
        <label>Default Event (optional)</label>
        <input id="cfgDefaultEvent" placeholder="demo-2025-01" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnSaveCfg">Save Config</button>
      </div>
    </div>
    <div class="tiny muted" style="margin-top:6px">Tip: URL में <code>?event=EVENT123</code> देने से Event auto-fill हो जाएगा.</div>
  </div>

  <div class="grid">
    <!-- UPLOAD -->
    <div class="card">
      <h2>1) Upload to an Event</h2>
      <label>Event ID</label>
      <input id="eventId" placeholder="event-2025-08" />
      <div class="row">
        <div>
          <label>Choose Photo</label>
          <input id="file" type="file" accept="image/*" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="btnUpload">Generate Link & Upload</button>
        </div>
      </div>
      <div id="upStatus" class="tiny muted" style="margin-top:8px"></div>
      <div id="lastKey" class="tiny" style="margin-top:6px"></div>
      <div class="sep"></div>
      <div class="tiny muted">Uploaded files land under <code>events/&lt;eventId&gt;/incoming/</code> with metadata <code>x-amz-meta-eventid</code>.</div>
    </div>

    <!-- SEARCH -->
    <div class="card">
      <h2>2) Search Matches</h2>
      <div class="row">
        <div>
          <label>Use Local Image</label>
          <input id="srchFile" type="file" accept="image/*" />
        </div>
        <div>
          <label>…or S3 Key</label>
          <input id="srchKey" placeholder="events/demo-2025-01/originals/xxx.jpg" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnSearch">Search</button>
        <button class="secondary" id="btnClear">Clear</button>
      </div>
      <div id="srchStatus" class="tiny muted" style="margin-top:8px"></div>
      <div class="results" id="results"></div>
    </div>
  </div>

  <div class="card">
    <h2>How it works</h2>
    <div class="tiny muted">1) Frontend calls <code>/upload-url</code> to get a presigned POST; 2) Browser uploads file directly to S3; 3) You can trigger a background indexer (optional); 4) Search via <code>/search</code>, then presign downloads via <code>/download</code>.</div>
  </div>
</div>

<script>
(function(){
  const q = new URL(location.href).searchParams;
  const $ = (id) => document.getElementById(id);
  const state = {
    uploadApi: localStorage.getItem('wm.uploadApi') || '',
    searchApi: localStorage.getItem('wm.searchApi') || '',
    downloadApi: localStorage.getItem('wm.downloadApi') || '',
    bucket: localStorage.getItem('wm.bucket') || 'wedmatch-photos',
    defaultEvent: q.get('event') || localStorage.getItem('wm.defaultEvent') || ''
  };
  function renderCfg(){
    $('cfgUpload').value = state.uploadApi;
    $('cfgSearch').value = state.searchApi;
    $('cfgDownload').value = state.downloadApi;
    $('cfgBucket').value = state.bucket;
    $('cfgDefaultEvent').value = state.defaultEvent;
    if (state.defaultEvent) $('eventId').value = state.defaultEvent;
  }
  renderCfg();
  $('btnSaveCfg').onclick = () => {
    state.uploadApi = $('cfgUpload').value.trim();
    state.searchApi = $('cfgSearch').value.trim();
    state.downloadApi = $('cfgDownload').value.trim();
    state.bucket = $('cfgBucket').value.trim();
    state.defaultEvent = $('cfgDefaultEvent').value.trim();
    localStorage.setItem('wm.uploadApi', state.uploadApi);
    localStorage.setItem('wm.searchApi', state.searchApi);
    localStorage.setItem('wm.downloadApi', state.downloadApi);
    localStorage.setItem('wm.bucket', state.bucket);
    localStorage.setItem('wm.defaultEvent', state.defaultEvent);
    toast('Saved config');
  };

  function toast(msg, ok){
    const el = document.createElement('div');
    el.className = 'tiny ' + (ok?'ok':'');
    el.textContent = msg;
    $('upStatus').innerHTML = '';
    $('upStatus').appendChild(el);
  }

  async function getUploadUrl(eventId, file){
    const res = await fetch(state.uploadApi, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ eventId, fileName: file.name, contentType: file.type })
    });
    if(!res.ok){ const e = await res.json().catch(()=>({})); throw new Error(e.message || e.error || res.statusText); }
    return res.json();
  }

  async function postToS3(url, fields, file){
    const fd = new FormData(); Object.entries(fields).forEach(([k,v])=>fd.append(k,v)); fd.append('file', file);
    const res = await fetch(url, { method:'POST', body: fd });
    if(!res.ok) throw new Error('S3 upload failed ' + res.status);
    return true;
  }

  $('btnUpload').onclick = async () => {
    const ev = $('eventId').value.trim(); const f = $('file').files[0];
    if(!state.uploadApi) return toast('Set /upload-url API in Config');
    if(!ev) return toast('Enter Event ID');
    if(!f) return toast('Pick a file');
    $('upStatus').innerHTML = '<span class="spinner"></span> Preparing link…';
    try {
      const { url, fields, key } = await getUploadUrl(ev, f);
      $('upStatus').innerHTML = '<span class="spinner"></span> Uploading…';
      await postToS3(url, fields, f);
      $('upStatus').innerHTML = '✅ Uploaded!';
      $('lastKey').innerHTML = 'S3 Key: <code>'+key+'</code>';
      // convenience: copy to search box
      $('srchKey').value = key;
    } catch(e){ $('upStatus').innerHTML = '<span class="err">❌ '+e.message+'</span>'; }
  };

  $('btnSearch').onclick = async () => {
    const file = $('srchFile').files[0];
    const s3Key = $('srchKey').value.trim();
    if(!state.searchApi) return $('srchStatus').textContent = 'Set /search API in Config';
    if(!file && !s3Key) return $('srchStatus').textContent = 'Pick a file or provide S3 key';

    $('srchStatus').innerHTML = '<span class="spinner"></span> Searching…';
    try {
      let payload = {};
      if(file){
        const b64 = await fileToBase64(file);
        payload.imageBase64 = stripDataUrl(b64);
      } else {
        payload.s3Bucket = state.bucket;
        payload.s3Key = s3Key;
      }
      const res = await fetch(state.searchApi, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const json = await res.json();
      if(!res.ok) throw new Error(json.message || json.error || res.statusText);
      $('srchStatus').innerHTML = 'Found '+(json.matches?.length||0)+' matches';
      renderResults(json.matches||[]);
    } catch(e){ $('srchStatus').innerHTML = '<span class="err">❌ '+e.message+'</span>'; $('results').innerHTML=''; }
  };

  $('btnClear').onclick = ()=>{ $('srchFile').value=''; $('srchKey').value=''; $('results').innerHTML=''; $('srchStatus').textContent=''; };

  async function renderResults(arr){
    const box = $('results'); box.innerHTML='';
    for(const m of arr){
      const card = document.createElement('div'); card.className='result';
      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `Similarity: <b>${m.similarity||0}%</b><br>`+
        `<span class="tiny muted">eventId:</span> <code>${m.eventId||'-'}</code> · `+
        `<span class="tiny muted">photoId:</span> <code>${m.photoId||'-'}</code><br>`+
        `<span class="tiny muted">s3Key:</span> <code>${m.s3Key||'-'}</code><br>`+
        `<div class="row" style="margin-top:6px">${downloadButtonHtml(m.s3Key)}</div>`;
      card.appendChild(meta);
      box.appendChild(card);
    }
  }

  function downloadButtonHtml(key){
    if(!key) return '<span class="tiny muted">No key</span>';
    return `<a class="btn" href="#" onclick="return presignAndOpen('${encodeURIComponent(key)}')">Open</a>`;
  }

  window.presignAndOpen = async function(keyEnc){
    const key = decodeURIComponent(keyEnc);
    if(!state.downloadApi) { alert('Set /download API in Config'); return false; }
    try{
      const res = await fetch(state.downloadApi, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ bucket: state.bucket, s3Key: key }) });
      const json = await res.json(); if(!res.ok) throw new Error(json.message || json.error || res.statusText);
      window.open(json.url, '_blank');
    }catch(e){ alert('Presign failed: '+e.message); }
    return false;
  }

  function fileToBase64(file){
    return new Promise((resolve,reject)=>{ const r = new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file); });
  }
  function stripDataUrl(s){ const i=s.indexOf(','); return i>=0?s.slice(i+1):s; }
})();
</script>
</body>
</html>

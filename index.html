<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Selfie Search — WedMatch</title>
  <style>
    :root{
      --brand:#ff9800; --brand-dark:#0f1a2b; --bg:#fde7c3; --card:#f6efe6; --accent:#efb768;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#fff, var(--bg)); color:#1b1b1b}
    header{background:var(--brand);color:#111;padding:14px 16px;font-weight:700}
    .wrap{max-width:1080px;margin:18px auto;padding:0 14px}
    .panel{background:#fff;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px;margin-bottom:16px;border:1px solid #f1d4ad}
    .row{display:grid;grid-template-columns:1fr 320px;gap:16px}
    label{font-size:13px;margin-bottom:6px;display:block;color:#333}
    input[type=text]{width:100%;padding:12px 10px;border-radius:12px;border:1px solid #d7c2a3}
    .btn{display:inline-block;background:var(--brand);border:0;color:#111;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn.dark{background:var(--brand-dark);color:#fff}
    .btn.alt{background:#fff;border:1px solid #e2c79a}
    .stack>*{margin-bottom:10px}
    .camera{background:#000;border-radius:14px;border:2px dashed #f0c483;overflow:hidden;display:flex;align-items:center;justify-content:center;min-height:240px}
    video,canvas{max-width:100%;display:block}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px}
    .card{background:var(--card);border-radius:14px;border:2px solid #efc27d;overflow:hidden;display:flex;align-items:center;justify-content:center;min-height:150px;position:relative}
    .card img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{display:flex;align-items:center;gap:12px}
    .note{font-size:13px;color:#666}
    .pill{display:inline-block;background:var(--brand-dark);color:#fff;border-radius:20px;padding:6px 10px;font-size:12px}
    .footer{margin-top:8px;display:flex;justify-content:space-between;align-items:center}
    .error{color:#b00020;font-weight:600}
  </style>
</head>
<body>
  <header>भारतीय जनता पार्टी — मंदसौर</header>
  <main class="wrap">
    <section class="panel">
      <h2 style="margin:0 0 8px 0">अपनी फोटो ढूँढें (Selfie Search)</h2>
      <div class="row">
        <div>
          <div class="camera" id="camBox">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas" style="display:none"></canvas>
          </div>
        </div>
        <div class="stack">
          <div>
            <label for="name">नाम</label>
            <input id="name" type="text" placeholder="अपना नाम" autocomplete="name" />
          </div>
          <div>
            <label for="phone">मोबाइल नंबर</label>
            <input id="phone" type="text" placeholder="मोबाइल" inputmode="numeric" autocomplete="tel" />
          </div>
          <div class="meta">
            <button class="btn" id="startCam">कैमरा चालू करें</button>
            <button class="btn alt" id="capture">फोटो कैप्चर</button>
            <button class="btn dark" id="stopCam">कैमरा बंद</button>
          </div>
          <div>
            <label for="file">या फाइल चुनें</label>
            <input id="file" type="file" accept="image/*" />
          </div>
          <div class="meta">
            <button class="btn" id="searchBtn">Search</button>
            <span class="note">मिले: <b id="count">0</b></span>
          </div>
          <div id="msg" class="note"></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="footer">
        <span class="pill" id="multiToggle">Multiple select: OFF</span>
        <div>
          <button class="btn alt" id="clearBtn">साफ़ करें</button>
          <button class="btn" id="downloadBtn">Download Selected (ZIP)</button>
        </div>
      </div>
      <div class="thumbs" id="resultsGrid">
        <!-- thumbnails injected here -->
      </div>
    </section>
  </main>

<script>
// ====== CONFIG ======
const API_BASE = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2'; // your API stage
const SEARCH_URL = API_BASE + '/search';
const MAX_WIDTH = 1280; // client resize max

// ====== CAMERA ======
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const startBtn = document.getElementById('startCam');
const stopBtn = document.getElementById('stopCam');
const capBtn = document.getElementById('capture');
const fileInput = document.getElementById('file');
const searchBtn = document.getElementById('searchBtn');
const msg = document.getElementById('msg');
const countEl = document.getElementById('count');
const grid = document.getElementById('resultsGrid');
const multi = document.getElementById('multiToggle');
const clearBtn = document.getElementById('clearBtn');
const downloadBtn = document.getElementById('downloadBtn');

let stream = null;
let lastImageB64 = null;
let multiSelect = false;

startBtn.onclick = async () => {
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user' }, audio:false });
    video.srcObject = stream;
    msg.textContent = '';
  }catch(e){ msg.textContent = 'कैमरा अनुमति नहीं मिली'; }
};

stopBtn.onclick = () => {
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  video.srcObject = null;
};

capBtn.onclick = () => {
  if(!video.videoWidth){ msg.textContent = 'कैमरा ऑन करें'; return; }
  const {dataUrl} = drawAndResize(video);
  lastImageB64 = dataUrl;
  msg.textContent = 'फोटो कैप्चर हो गई';
};

fileInput.onchange = async e => {
  const file = e.target.files[0]; if(!file) return;
  const img = await readFileToImg(file);
  const {dataUrl} = drawAndResize(img);
  lastImageB64 = dataUrl;
  msg.textContent = 'फाइल लोड हो गई';
};

function drawAndResize(source){
  const iw = source.videoWidth || source.naturalWidth; const ih = source.videoHeight || source.naturalHeight;
  const scale = Math.min(1, MAX_WIDTH/Math.max(iw, ih));
  const w = Math.round(iw*scale), h = Math.round(ih*scale);
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(source, 0, 0, w, h);
  const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
  return {dataUrl,w,h};
}

function readFileToImg(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = () => { const img = new Image(); img.onload=()=>res(img); img.src = fr.result; };
    fr.onerror = rej; fr.readAsDataURL(file);
  });
}

// ====== SEARCH ======
searchBtn.onclick = async () => {
  try{
    msg.textContent = '';
    if(!lastImageB64){
      // if camera is on, capture instant frame
      if(video.srcObject){ capBtn.click(); } else { msg.textContent='कृपया फोटो चुनें या कैमरा से कैप्चर करें'; return; }
    }
    const payload = { imageBase64: lastImageB64 };
    const res = await fetch(SEARCH_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    const data = await res.json();
    window.__lastSearchResponse = data;

    const items = normalize(data);
    render(items);
    countEl.textContent = items.length;
    if(!items.length) msg.textContent = 'कोई मैच नहीं मिला';
  }catch(err){
    console.error(err); msg.innerHTML = '<span class="error">Internal Server Error</span>';
  }
};

function normalize(data){
  // prefer "results" then fallback to "matches"
  let arr = [];
  if(Array.isArray(data.results) && data.results.length){ arr = data.results; }
  else if(Array.isArray(data.matches) && data.matches.length){
    arr = data.matches.map(m=>({
      imageUrl: m.imageUrl || m.url,
      url: m.url || m.imageUrl,
      photoId: m.photoId, eventId: m.eventId, similarity: m.similarity
    }));
  }
  // filter items that actually have a url
  arr = arr.filter(x => (x && (x.imageUrl || x.url)));
  return arr;
}

function render(items){
  grid.innerHTML = '';
  items.forEach((it,idx)=>{
    const url = it.imageUrl || it.url;
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.loading='lazy'; img.decoding='async'; img.alt= it.photoId || ('match-'+idx);
    img.src = url;
    card.appendChild(img);
    // selection
    card.onclick = () => card.classList.toggle('sel');
    grid.appendChild(card);
  });
}

// ====== UI helpers ======
multi.onclick = () => { multiSelect = !multiSelect; multi.textContent = `Multiple select: ${multiSelect? 'ON':'OFF'}`; };
clearBtn.onclick = () => { grid.innerHTML=''; countEl.textContent='0'; msg.textContent=''; };

// basic ZIP (on-demand) — to keep light, trigger downloads one by one if multi selected
// (You can wire JSZip if needed later.)
downloadBtn.onclick = () => {
  const imgs = grid.querySelectorAll('.card.sel img');
  if(!imgs.length){ msg.textContent='पहले इमेज चुनें'; return; }
  imgs.forEach((img,i)=>{ const a=document.createElement('a'); a.href=img.src; a.download = (img.alt||`photo-${i+1}`)+'.jpg'; document.body.appendChild(a); a.click(); a.remove(); });
};
</script>
</body>
</html>

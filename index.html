<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>भारतीय जनता पार्टी — मंदसौर (Face Search)</title>
  <style>
    :root{
      --brand:#ff8800; --ink:#222; --muted:#6b7280; --bg:#fff7ed; --card:#fffaf5; --err:#fee2e2; --ok:#dcfce7;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
    body{margin:0;background:#fff}<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Face Search</title>
  <style>
    :root{ --brand:#ff8a00; --ink:#111; --muted:#777; --bg:#fff7ef; }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#fff; color:var(--ink); }
    header{ background:var(--brand); color:#fff; padding:.75rem 1rem; font-weight:700; }
    .wrap{ max-width:980px; margin:0 auto; padding:1rem; }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr; } }

    .card{ background:#fff; border:1px solid #eee; border-radius:10px; padding:12px; }
    label{ display:block; font-size:.9rem; color:var(--muted); margin-bottom:6px; }
    input[type=text],input[type=tel]{ width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:1rem; }
    input[type=file]{ width:100%; }
    .btn{ display:inline-block; background:var(--brand); color:#fff; border:0; padding:14px 18px; border-radius:10px; font-weight:700; cursor:pointer; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .hint{ font-size:.9rem; color:#666; margin-top:8px; }

    .videoBox{ position:relative; background:#000; border-radius:10px; overflow:hidden; }
    video{ width:100%; height:auto; display:block; background:#000; }
    .ghost{ display:none !important; }

    .msg{ margin-top:10px; }
    .ok{ background:#eafff2; border:1px solid #a6f0bf; padding:.75rem; border-radius:10px; }
    .warn{ background:#fff7e6; border:1px solid #ffd18a; padding:.75rem; border-radius:10px; }
    .err{ background:#fde4e4; border:1px solid #f6b3b3; padding:.75rem; border-radius:10px; }

    .thumbs{ display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; margin-top:12px; }
    .thumb{ border:1px solid #eee; border-radius:8px; overflow:hidden; background:#fafafa; }
    .thumb img{ width:100%; display:block; }
    .meta{ padding:6px 8px; font-size:.85rem; color:#555; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .grow{ flex:1 1 auto; }

    /* मोबाइल पर file input छुपाने के लिए */
    @media (max-width:640px){
      .fileRow[data-hide-mobile="1"]{ display:none; }
    }
  </style>
</head>
<body>
<header>Face Search</header>

<main class="wrap">
  <div class="grid">
    <!-- Left: camera -->
    <section class="card">
      <div class="row">
        <div class="grow">
          <label>नाम (अनिवार्य)</label>
          <input id="name" type="text" placeholder="आपका नाम" autocomplete="name" />
        </div>
        <div class="grow">
          <label>मोबाइल नंबर (अनिवार्य)</label>
          <input id="mobile" type="tel" inputmode="numeric" placeholder="10 अंकों का मोबाइल" autocomplete="tel" />
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="videoBox">
        <video id="video" playsinline muted></video>
      </div>
      <div class="row" style="margin-top:10px;gap:8px">
        <button id="btnStartCam" class="btn" style="background:#444">कैमरा चालू करें</button>
        <button id="btnSearch" class="btn grow">Search</button>
      </div>

      <div id="msg" class="msg"></div>

      <div class="hint">
        PNG/WebP → JPEG auto. * मोबाइल पर कैमरा अपने-आप खुलेगा (Allow दें)। फ़ाइल अपलोड की ज़रूरत नहीं।
      </div>
    </section>

    <!-- Right: file upload (fallback / desktop) -->
    <section class="card">
      <div class="fileRow" id="fileRow" data-hide-mobile="1">
        <label>या फ़ाइल चुनें</label>
        <input id="fileInput" type="file" accept="image/*" capture="user" />
      </div>

      <div class="hint" style="margin-top:10px">
        अगर कैमरा उपलब्ध नहीं है तो यहाँ से सेल्फ़ी चुनें। <br/>
        URL पैरामीटर्स: <code>?e=eventId&sim=70&newtab=1&debug=1</code>
      </div>

      <div id="results" class="thumbs"></div>
    </section>
  </div>
</main>

<!-- hidden canvas for capture -->
<canvas id="canvas" class="ghost"></canvas>

<script>
/* ===========================
   CONFIG
=========================== */
const API_BASE   = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
const SEARCH_URL = API_BASE + '/search';
const DOWNLOAD_URL = API_BASE + '/download'; // /download?key=<s3Key>

const urlParams = new URLSearchParams(location.search);
const EVENT_ID  = (urlParams.get('e') || '').trim();
const MIN_SIM   = Number(urlParams.get('sim') || 70);
const NEWTAB    = urlParams.get('newtab') === '1';
const DEBUG     = urlParams.get('debug') === '1';

function log(...a){ if(DEBUG) console.log('[WM]', ...a); }

/* ===========================
   DOM
=========================== */
const $ = (s)=>document.querySelector(s);
const nameEl = $('#name');
const mobileEl = $('#mobile');
const video = $('#video');
const canvas = $('#canvas');
const fileInput = $('#fileInput');
const btnSearch = $('#btnSearch');
const btnStartCam = $('#btnStartCam');
const msgBox = $('#msg');
const resultsBox = $('#results');

/* ===========================
   Camera
=========================== */
let currentStream = null;

async function startCamera(){
  try{
    if(currentStream){ return; }
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:'user', width:{ideal:1280}, height:{ideal:720} },
      audio:false
    });
    video.srcObject = stream;
    currentStream = stream;
    await video.play().catch(()=>{});
    btnStartCam.style.display = 'none';
    log('camera started');
  }catch(e){
    console.warn('camera error', e);
    btnStartCam.style.display = 'inline-block';
    if(msgBox) msgBox.innerHTML = `<div class="warn">कैमरा नहीं खुला। ऊपर “कैमरा चालू करें” दबाएँ या फ़ाइल से चुनें।</div>`;
  }
}

function stopCamera(){
  if(currentStream){
    currentStream.getTracks().forEach(t=>t.stop());
    currentStream = null;
  }
  video.srcObject = null;
}

document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState==='visible'){ startCamera(); }
  else { /* बैकग्राउंड में resources बचाएँ */
    // stopCamera(); // चाहें तो रोक दें
  }
});
btnStartCam.addEventListener('click', startCamera);

/* ===========================
   Helpers
=========================== */
function validateForm(){
  const n = (nameEl.value||'').trim();
  const m = (mobileEl.value||'').replace(/\D/g,'').trim();
  if(n.length < 2){
    showMsg('कृपया नाम भरें।','err'); return false;
  }
  if(m.length !== 10){
    showMsg('कृपया 10 अंकों का मोबाइल भरें।','err'); return false;
  }
  return { name:n, mobile:m };
}
function showMsg(html, cls='ok'){ msgBox.innerHTML = `<div class="${cls}">${html}</div>`; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function fileToBase64(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onerror = ()=>rej(fr.error||new Error('file read error'));
    fr.onload = ()=>res(String(fr.result||'')); fr.readAsDataURL(file);
  });
}
function canvasToJpegDataURL(c,q=0.9){ return c.toDataURL('image/jpeg', q); }
function stripBase64(d){ return d.replace(/^data:image\/\w+;base64,/, ''); }

/* Robust fetch + parse */
async function fetchSmart(url, opts={}, retries=2){
  try{
    const r = await fetch(url, opts);
    if(r.ok) return r;
    if((r.status>=500 || r.status===429) && retries>0){
      await new Promise(rz=>setTimeout(rz,(3-retries)*400));
      return fetchSmart(url, opts, retries-1);
    }
    return r;
  }catch(e){
    if(retries>0){
      await new Promise(rz=>setTimeout(rz,(3-retries)*400));
      return fetchSmart(url, opts, retries-1);
    }
    throw e;
  }
}
async function safeJson(resp){
  const text = await resp.text();
  try{ return { ok:true, json:JSON.parse(text), text }; }
  catch{ return { ok:false, json:null, text }; }
}

/* ===========================
   SEARCH
=========================== */
async function callSearch({ imageBase64, s3Bucket, s3Key, eventId, minSimilarity=MIN_SIM, maxResults=12 }){
  const payload = { maxResults, minSimilarity };
  if(eventId) payload.eventId = eventId;
  if(imageBase64) payload.imageBase64 = imageBase64;
  if(s3Bucket && s3Key){ payload.s3Bucket=s3Bucket; payload.s3Key=s3Key; }

  log('payload', { ...payload, imageBase64:imageBase64?('len:'+imageBase64.length):undefined });

  const resp = await fetchSmart(SEARCH_URL, {
    method:'POST',
    headers:{ 'content-type':'application/json' },
    body: JSON.stringify(payload)
  });
  const parsed = await safeJson(resp);

  if(!resp.ok){
    log('search non-ok', resp.status, parsed.text);
    const err = new Error(`API ${resp.status}`);
    err.status = resp.status; err.body = parsed.text;
    throw err;
  }
  if(!parsed.ok){
    log('bad json', parsed.text);
    const err = new Error('Bad JSON from API'); err.status=200; err.body=parsed.text; throw err;
  }
  return parsed.json; // { matches: [...] }
}

async function doSearch(flow){
  // image source
  let imageBase64;
  if(flow.canvas){
    imageBase64 = stripBase64(canvasToJpegDataURL(flow.canvas, 0.9));
  }else if(fileInput.files?.[0]){
    const b64 = await fileToBase64(fileInput.files[0]);
    imageBase64 = stripBase64(b64);
  }else{
    throw new Error('No image found');
  }

  // 1st: with event (if provided)
  const withEvent = !!EVENT_ID;
  try{
    const r1 = await callSearch({ imageBase64, eventId: withEvent?EVENT_ID:undefined });
    if(Array.isArray(r1.matches) && r1.matches.length>0){
      return renderResults(r1.matches, { usedEvent: withEvent?EVENT_ID:undefined });
    }
    // Auto-retry without event (debug assist)
    log('Retrying search without event… Provide imageBase64 or (s3Bucket + s3Key)');
    const r2 = await callSearch({ imageBase64, eventId: undefined });
    return renderResults(r2.matches||[], { usedEvent: undefined, retryNote: withEvent?`शायद URL में e=${EVENT_ID} गलत है?` : '' });
  }catch(e){
    renderError(e);
  }
}

/* ===========================
   RENDER
=========================== */
function getImageUrl(item){
  // प्रायोरिटी: thumbUrl > s3Key via /download
  if(item.thumbUrl) return item.thumbUrl;
  const key = item.s3Key || item.key || '';
  if(key) return `${DOWNLOAD_URL}?key=${encodeURIComponent(key)}`;
  return '';
}
function renderError(err){
  console.error('search error', err);
  showMsg(
    `<b>सर्विस में दिक्कत:</b> ${escapeHtml(err.message||err)}
     ${err.status?`<div>HTTP: ${err.status}</div>`:''}
     ${err.body?`<details style="margin-top:.5rem"><summary>एरर डीटेल्स</summary><pre style="white-space:pre-wrap">${escapeHtml(err.body)}</pre></details>`:''}`,
    'err'
  );
}
function renderResults(items, meta){
  const n = (items||[]).length;
  if(n===0){
    showMsg(`Search Results (0) ${meta?.usedEvent?`(event: ${meta.usedEvent})`:''}${meta?.retryNote?`<div>${meta.retryNote}</div>`:''}`,'warn');
    resultsBox.innerHTML = '';
    return;
  }
  showMsg(`मिले ${n} फोटो ${meta?.usedEvent?`(event: ${meta.usedEvent})`:''}.`, 'ok');

  // open in new tab if asked
  if(NEWTAB){
    const ids = items.map(x=>encodeURIComponent(x.s3Key||x.key||x.photoId||'')).filter(Boolean).join(',');
    const url = `/results.html?items=${ids}`;
    window.open(url, '_blank', 'noopener');
    return;
  }

  // inline thumbnails
  const html = items.map(it=>{
    const u = getImageUrl(it);
    const cap = [
      it.photoId ? `ID: ${escapeHtml(it.photoId)}` : '',
      it.similarity!=null ? `~${Math.round(Number(it.similarity))}%` : ''
    ].filter(Boolean).join(' • ');
    const dl = u ? `<a href="${u}" target="_blank" rel="noopener" style="text-decoration:none">डाउनलोड ⤓</a>` : '';
    return `<div class="thumb">
      ${u?`<img loading="lazy" src="${u}" alt="">`:`<div style="padding:40px;text-align:center;color:#888">No preview</div>`}
      <div class="meta">${cap} ${dl?` &nbsp; ${dl}`:''}</div>
    </div>`;
  }).join('');
  resultsBox.innerHTML = html;
}

/* ===========================
   Wire-up
=========================== */
btnSearch.addEventListener('click', async ()=>{
  const ok = validateForm(); if(!ok) return;
  try{
    // capture current video frame to canvas (if playing)
    if(video && video.srcObject){
      const w = video.videoWidth || 640, h = video.videoHeight || 480;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(video, 0, 0, w, h);
    }
    showMsg('खोज रहे हैं…','ok');
    await doSearch({ canvas });
  }catch(e){ renderError(e); }
});

// Try camera on load
document.addEventListener('DOMContentLoaded', ()=>{
  // मोबाइल पर कैमरा auto-start; iOS Safari में gesture की जरूरत पड़ सकती—fallback बटन रहेगा
  startCamera();
});
</script>
</body>
</html>

    header{background:var(--brand);color:#000;font-weight:700;padding:10px 16px}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:14px;color:#111;font-weight:700}
    input[type=text]{width:100%;padding:14px 12px;border:1px solid #e5e7eb;border-radius:12px;font-size:16px}
    input:focus{outline:3px solid #ffe5cc;border-color:#ffcb8a}
    .note{color:#6b7280;font-size:13px}
    .panel{background:var(--card);border:1px solid #fde7d3;border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    video,canvas{width:100%;max-height:380px;background:#000;border-radius:12px}
    .btn{appearance:none;border:0;border-radius:12px;background:var(--brand);color:#000;padding:14px 18px;font-weight:800;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.outline{background:#111;color:#fff}
    .btn.ghost{background:#111;color:#fff;opacity:.85}
    .msg{margin-top:12px;border-radius:12px;padding:12px 14px}
    .msg.err{background:var(--err);border:1px solid #fca5a5;color:#7f1d1d}
    .msg.ok{background:var(--ok);border:1px solid #86efac;color:#14532d}
    details{margin-top:6px}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;background:#f3f4f6;color:#111;font-size:13px}
    .footer{text-align:center;color:#6b7280;font-size:12px;margin:26px 0}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>भारतीय जनता पार्टी — मंदसौर (Face Search)</header>
  <div class="wrap">
    <div class="grid">
      <div class="field">
        <label for="name">नाम (अनिवार्य)</label>
        <input id="name" type="text" placeholder="आपका नाम" autocomplete="name" />
      </div>
      <div class="field">
        <label for="mobile">मोबाइल नंबर (अनिवार्य)</label>
        <input id="mobile" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="10" placeholder="10 अंकों का मोबाइल" />
      </div>
    </div>

    <div class="grid" style="margin-top:14px">
      <div>
        <div class="field">
          <label>सेल्फ़ी कैमरा</label>
          <video id="video" playsinline autoplay muted></video>
          <canvas id="canvas" hidden></canvas>
        </div>
        <div class="actions">
          <button id="btnStart" class="btn">कैमरा चालू करें</button>
          <button id="btnSnap" class="btn outline" disabled>सेल्फ़ी लें</button>
          <button id="btnRetake" class="btn ghost" disabled>दोबारा लें</button>
        </div>
      </div>
      <div>
        <div class="field">
          <label for="file">या फ़ाइल चुनें</label>
          <input id="file" type="file" accept="image/*" />
        </div>
        <div class="field">
          <button id="btnSearch" class="btn" style="width:100%">Search</button>
          <div class="note">PNG/WebP → JPEG auto. * मोबाइल पर कैमरा अपने-आप खुलेगा (Allow दें)। फ़ाइल अपलोड की ज़रूरत नहीं।</div>
          <div id="status" class="msg" hidden></div>
          <details id="errBox" hidden>
            <summary>एरर डिटेल्स</summary>
            <pre id="errJson" style="white-space:pre-wrap"></pre>
          </details>
          <div class="note">सर्च परिणाम नए टैब में खुलेंगे।</div>
          <div class="note">स्टेज: <span id="stage" class="pill">PROD2</span></div>
        </div>
      </div>
    </div>

    <div class="footer">© 2025</div>
  </div>

<script>
(function(){
  const SEARCH_API = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2/search';
  const DOWNLOAD_API = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2/download';

  const $ = sel => document.querySelector(sel);
  const video = $('#video');
  const canvas = $('#canvas');
  const file = $('#file');
  const btnStart = $('#btnStart');
  const btnSnap = $('#btnSnap');
  const btnRetake = $('#btnRetake');
  const btnSearch = $('#btnSearch');
  const statusEl = $('#status');
  const errBox = $('#errBox');
  const errJson = $('#errJson');

  let stream = null;
  let capturedDataURL = '';

  function getQuery(name){
    const q = new URLSearchParams(location.search);
    return q.get(name);
  }
  function getEventId(){
    return getQuery('e') || getQuery('event') || 'demo-2025-01';
  }

  function setStatus(msg, type='err'){
    statusEl.hidden = false; statusEl.textContent = msg; statusEl.className = 'msg ' + (type==='ok'?'ok':'err');
  }
  function clearStatus(){ statusEl.hidden = true; errBox.hidden = true; }

  async function startCamera(){
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
      video.srcObject = stream; await video.play();
      btnSnap.disabled = false; btnRetake.disabled = true; $('#btnStart').disabled = true;
    }catch(err){
      console.warn('camera error', err);
      setStatus('कैमरा एरर: अनुमति दें या किसी और ब्राउज़र में खोलें।');
    }
  }
  function stopCamera(){
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  }

  function dataURLFromVideo(){
    const w = video.videoWidth || 640, h = video.videoHeight || 480;
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video,0,0,w,h);
    const url = canvas.toDataURL('image/jpeg', 0.9);
    return url;
  }

  function fileToDataURL(f){
    return new Promise((res,rej)=>{ const rd = new FileReader(); rd.onerror=rej; rd.onload=()=>res(rd.result); rd.readAsDataURL(f); });
  }

  function toBase64(dataURL){
    if(!dataURL) return '';
    const i = dataURL.indexOf(',');
    return i>-1?dataURL.slice(i+1):dataURL;
  }

  async function fetchSmart(url, {body, headers={}}){
    const resp = await fetch(url, {method:'POST', headers:{'content-type':'application/json', ...headers}, body: JSON.stringify(body)});
    const txt = await resp.text();
    let json; try{ json = JSON.parse(txt); }catch{ json = null; }
    if(!resp.ok){
      const err = new Error('API '+resp.status);
      err.status = resp.status; err.url = url; err.bodyText = txt; err.headers = Object.fromEntries(resp.headers.entries()); err.json = json;
      throw err;
    }
    return json ?? { ok:true, data:txt };
  }

  function normalizeResults(data){
    // Accept several shapes and return [{thumb, download, name}]
    const out=[];
    if(!data) return out;
    const push = (thumb, download, name='')=> out.push({thumb, download, name});

    if(Array.isArray(data.photos)){
      data.photos.forEach(p=> push(p.thumbUrl||p.thumbnail||p.url, p.downloadUrl||p.url||p.href, p.photoId||p.id||''));
    }
    const items = data.items || data.results || data.matches || data.keys || [];
    if(Array.isArray(items)){
      items.forEach(it=>{
        const key = typeof it==='string'? it : (it.s3Key||it.key||it.path);
        if(key){
          const dl = `${DOWNLOAD_API}?key=${encodeURIComponent(key)}`;
          push(dl, dl, (it.photoId||it.id||key));
        }
      });
    }
    return out;
  }

  function openResultsTab(list){
    const html = `<!doctype html><meta charset="utf-8"><title>Results</title>
      <style>body{font-family:system-ui;margin:0;background:#fff} .wrap{max-width:1024px;margin:0 auto;padding:12px}
      .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
      .card{border:1px solid #eee;border-radius:12px;overflow:hidden}
      img{display:block;width:100%;height:220px;object-fit:cover}
      .row{display:flex;justify-content:space-between;align-items:center;padding:8px}
      a.btn{background:#111;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none}
      </style>
      <div class="wrap"><h2>Search Results (${list.length})</h2>
      <div class="grid">${list.map(x=> `<div class="card"><img loading="lazy" src="${x.thumb}"/><div class="row"><div>${x.name||''}</div><a class="btn" href="${x.download}" target="_blank" rel="noopener">Download</a></div></div>`).join('')}</div></div>`;
    const w = window.open('about:blank','_blank');
    if(w){ w.document.write(html); w.document.close(); }
  }

  async function callSearch(imageDataURL){
    const name = $('#name').value.trim();
    const mobile = $('#mobile').value.trim();
    const eventId = getEventId();

    const base64 = toBase64(imageDataURL||'');
    const payload = {
      eventId,
      phone: mobile,
      name,
      imageBase64: base64,
      image: base64,           // alias for some backends
      contentType: 'image/jpeg'
    };

    // Basic validations
    if(!/^[0-9]{10}$/.test(mobile)) throw new Error('मोबाइल 10 अंकों का भरें');
    if(!base64 || base64.length < 5000) throw new Error('सेल्फ़ी कैप्चर करें या फ़ाइल चुनें');

    // Hit API
    const data = await fetchSmart(SEARCH_API, {body: payload});
    return data;
  }

  async function doSearch(){
    clearStatus();
    btnSearch.disabled = true; const spinTxt = btnSearch.textContent; btnSearch.textContent = 'Searching…';
    try{
      let dataURL = capturedDataURL;
      if(file.files[0]) dataURL = await fileToDataURL(file.files[0]);
      if(!dataURL && stream) dataURL = dataURLFromVideo();

      const data = await callSearch(dataURL);
      const list = normalizeResults(data);
      setStatus('सर्च सफल। '+list.length+' फोटो मिले।', 'ok');
      openResultsTab(list);
    }catch(err){
      console.error('search error', err);
      setStatus('सर्व में दिक्कत: '+ (err.status? ('API '+err.status) : err.message));
      errBox.hidden = false; errJson.textContent = JSON.stringify({
        message: err.message,
        status: err.status||null,
        url: err.url||null,
        headers: err.headers||null,
        body: err.bodyText||null,
        json: err.json||null
      }, null, 2);
    }finally{
      btnSearch.disabled = false; btnSearch.textContent = spinTxt;
    }
  }

  // UI events
  btnStart.addEventListener('click', startCamera);
  btnSnap.addEventListener('click', ()=>{
    capturedDataURL = dataURLFromVideo();
    btnRetake.disabled = false; btnSnap.disabled = true; setStatus('सेल्फ़ी सेव हो गई। Search दबाएँ।', 'ok');
  });
  btnRetake.addEventListener('click', ()=>{ capturedDataURL=''; setStatus(''); clearStatus(); btnSnap.disabled=false; btnRetake.disabled=true; });
  btnSearch.addEventListener('click', ()=> doSearch());

  // Try auto camera on mobile
  if(navigator.mediaDevices && location.protocol==='https:'){
    // iOS needs a user gesture; on desktop we try once.
    if(!/iPhone|iPad|iPod/i.test(navigator.userAgent)) startCamera();
  }

  // --- Dev tests (open with #test) ---
  if(location.hash==="#test"){
    console.log('Running basic tests…');
    const b64 = toBase64('data:image/jpeg;base64,QUJDRA==');
    console.assert(b64==='QUJDRA==','base64 extraction');
    const n = normalizeResults({keys:['events/demo-2025-01/originals/IMG_0001.jpg']});
    console.assert(n.length===1 && n[0].download.includes('/download?key='),'normalize keys');
  }
})();
</script>
</body>
</html>

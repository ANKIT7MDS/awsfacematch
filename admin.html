<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WedMatch — Admin Panel</title>
  <style>
    :root{
      --brand:#ff8a00;--bg:#fff7ef;--card:#fff;--muted:#6b6b6b;--border:#ead9c6;--danger:#cc2f2f;--ok:#1a7f37
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{background:var(--brand);color:#111;padding:14px 18px;font-weight:800}
    main{max-width:1100px;margin:0 auto;padding:18px}
    .row{display:grid;gap:14px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    label{font-weight:650;margin:6px 0 4px;display:block}
    input,select,button,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    button{background:var(--brand);border:none;font-weight:700;cursor:pointer}
    button.secondary{background:#111;color:#fff}
    button.ghost{background:#fff;border:1px dashed var(--border)}
    .muted{color:var(--muted);font-size:12px}
    .drop{border:2px dashed var(--border);border-radius:12px;background:#fffaf1;padding:18px;text-align:center}
    .drop.drag{background:#fff0dc;border-color:#f2b56c}
    .progress{height:8px;background:#ffe0b6;border-radius:99px;overflow:hidden;margin-top:8px}
    .progress>i{display:block;height:100%;background:var(--brand);width:0%}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:10px}
    .thumb{background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px;display:flex;flex-direction:column;gap:6px}
    .thumb img{width:100%;aspect-ratio:1;object-fit:cover;border-radius:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
    th{background:#fff2e0}
    .debug{white-space:pre-wrap;background:#0e1116;color:#d6deeb;border-radius:12px;padding:12px;overflow:auto;max-height:220px}
    .toast{position:fixed;right:14px;bottom:14px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:.95;z-index:9999}
    .msg{font-size:13px;margin-top:6px}
    .msg.ok{color:var(--ok)}
    .msg.error{color:var(--danger)}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hr{height:1px;background:var(--border);margin:12px 0}
  </style>
</head>
<body>
  <header>WedMatch — Admin Panel</header>
  <main>

    <!-- API SETUP -->
    <section class="card">
      <div class="row grid-2">
        <div>
          <label for="apiBase">API Base URL</label>
          <input id="apiBase" placeholder="https://<api-id>.execute-api.ap-south-1.amazonaws.com/PROD2" />
          <div class="inline" style="margin-top:8px">
            <button id="saveApi">Save API URL</button>
            <button id="diag" class="secondary">Run API Diagnostics</button>
          </div>
          <div class="muted" style="margin-top:6px">Tip: यह आपका <b>API Gateway Stage URL</b> होना चाहिए (Netlify domain नहीं)।</div>
          <div id="apiMsg" class="msg"></div>
        </div>
        <div>
          <label for="bucket">S3 Bucket</label>
          <select id="bucket">
            <option value="wedmatch-photos">wedmatch-photos</option>
          </select>
          <div class="hr"></div>
          <label for="eventId">इवेंट चुनें</label>
          <div class="inline">
            <select id="eventId" style="flex:1 1 auto"></select>
            <button id="newEventBtn" class="ghost" style="width:160px">+ New Event</button>
          </div>
          <div id="evMsg" class="msg"></div>
        </div>
      </div>
    </section>

    <!-- NEW EVENT (inline form hidden by default) -->
    <section class="card" id="newEventCard" style="display:none">
      <h3 style="margin:0 0 8px">Create New Event</h3>
      <div class="row grid-3">
        <div>
          <label for="evId">Event ID (unique, a-z0-9-)</label>
          <input id="evId" placeholder="bjp" />
        </div>
        <div>
          <label for="evName">Event Name</label>
          <input id="evName" placeholder="BJP Mandsaur" />
        </div>
        <div>
          <label for="evDate">Date (optional)</label>
          <input id="evDate" type="date" />
        </div>
      </div>
      <div class="inline" style="margin-top:10px">
        <button id="createEvent">Create Event</button>
        <button id="cancelNew" class="ghost">Cancel</button>
      </div>
      <div id="newEvMsg" class="msg"></div>
    </section>

    <!-- UPLOAD -->
    <section class="card">
      <h3 style="margin:0 0 6px">Upload Photos</h3>
      <div class="muted">इमेज ड्रैग-ड्रॉप करें या फाइल चुनें। Client-side resize → JPEG, फिर <code>/upload-url</code> से S3 में अपलोड।</div>

      <div id="drop" class="drop" style="margin-top:10px">
        <b>इमेज यहाँ ड्रॉप करें</b> या
        <input id="file" type="file" accept="image/*" multiple style="max-width:320px;margin-left:6px">
      </div>

      <div class="row grid-2" style="margin-top:10px">
        <div>
          <label for="maxDim">Max dimension (px)</label>
          <input id="maxDim" type="number" value="3000">
        </div>
        <div>
          <label for="jpegQ">JPEG quality</label>
          <input id="jpegQ" type="number" step="0.01" value="0.88">
        </div>
      </div>

      <div class="progress" aria-label="upload progress" style="margin-top:10px"><i id="bar"></i></div>
      <div id="upMsg" class="msg">Ready.</div>
      <div id="thumbs" class="thumbs"></div>
    </section>

    <!-- LOGS -->
    <section class="card">
      <h3 style="margin:0 0 6px">Search Logs</h3>
      <div class="inline">
        <label for="fromTs" style="margin:0">From (epoch ms)</label>
        <input id="fromTs" type="number" placeholder="(optional)" style="max-width:260px">
        <button id="loadLogs">लोड करें</button>
      </div>
      <div style="overflow:auto;margin-top:10px">
        <table id="logsTbl">
          <thead><tr><th>TS</th><th>Event</th><th>Name</th><th>Phone</th><th>Note</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="logsMsg" class="msg"></div>
    </section>

    <!-- DEBUG -->
    <section class="card">
      <h3 style="margin:0 0 6px">Debug</h3>
      <div id="dbg" class="debug">ready</div>
    </section>

  </main>

  <script>
    /************* UTILITIES *************/
    const $ = (id)=>document.getElementById(id);
    const state = { apiBase:"" };
    const sel = ()=>$('eventId');
    const bucketEl = ()=>$('bucket');

    function toast(msg, ms=2800){
      const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
      document.body.appendChild(t); setTimeout(()=>t.remove(), ms);
    }
    function log(...a){
      console.log(...a);
      const el=$('dbg'); if(!el) return;
      const s = a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' | ');
      el.textContent = new Date().toLocaleTimeString() + '  ' + s;
    }
    const delay = (ms)=>new Promise(r=>setTimeout(r,ms));

    async function safeJson(res){
      const txt = await res.text();
      try{ return JSON.parse(txt); } catch{ return { _raw: txt }; }
    }
    async function safeFetch(url, opts={}, timeoutMs=20000){
      const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),timeoutMs);
      try{ return await fetch(url,{...opts,signal:ctrl.signal}); }
      finally{ clearTimeout(t); }
    }
    function endpoints(){
      const base = state.apiBase.replace(/\/$/, '');
      return {
        URL_EVENTS: base + '/admin/events',
        URL_LOGS:   base + '/admin/logs',
        URL_UPLOAD: base + '/upload-url'
      };
    }

    function setMsg(id, text, cls){ const el=$(id); if(!el) return; el.className='msg'+(cls?(' '+cls):''); el.textContent=text; }
    function setProgress(pct){ $('bar').style.width=Math.max(0,Math.min(100,pct))+'%'; }

    /************* IMAGE -> JPEG *************/
    async function toJpeg(file, maxDim=3000, quality=0.88){
      const img = await new Promise((res,rej)=>{ const u=URL.createObjectURL(file), i=new Image(); i.onload=()=>{URL.revokeObjectURL(u);res(i)}; i.onerror=e=>{URL.revokeObjectURL(u);rej(e)}; i.src=u; });
      const w=img.width,h=img.height; let nw=w,nh=h; if(Math.max(w,h)>maxDim){ const k=maxDim/Math.max(w,h); nw=Math.round(w*k); nh=Math.round(h*k); }
      const c=document.createElement('canvas'); c.width=nw; c.height=nh; c.getContext('2d').drawImage(img,0,0,nw,nh);
      const blob=await new Promise(r=>c.toBlob(r,'image/jpeg',quality));
      return new File([blob], file.name.replace(/\.(png|webp|heic|heif|bmp|jpeg|jpg)$/i,'.jpg'), {type:'image/jpeg'});
    }

    /************* API CALLS *************/
    async function ensureApi(){ if(!state.apiBase){ toast('पहले API Base URL सेव करें'); throw new Error('apiBase not set'); } }

    async function loadEvents(){
      await ensureApi(); const { URL_EVENTS } = endpoints();
      const r = await safeFetch(URL_EVENTS);
      if(!r.ok){ setMsg('evMsg',`Events HTTP ${r.status}`,'error'); return; }
      const data = await safeJson(r);
      const items = Array.isArray(data.items)?data.items:(data.events||data||[]);
      const s = sel(); s.innerHTML='';
      items.forEach(e=>{ const o=document.createElement('option'); o.value = e.eventId||e.EventID||e.id; o.textContent = e.eventName||e.name||o.value; s.appendChild(o); });
      const saved = localStorage.getItem('ADMIN_EVENT_ID');
      if(saved && s.querySelector(`option[value="${CSS.escape(saved)}"]`)) s.value=saved; else if(s.options.length) s.selectedIndex=0;
      s.dispatchEvent(new Event('change'));
      setMsg('evMsg',`Loaded ${items.length} events`,'ok');
    }

    async function createEvent(){
      await ensureApi(); const { URL_EVENTS } = endpoints();
      const id = $('evId').value.trim(); const name=$('evName').value.trim(); const date=$('evDate').value||undefined;
      if(!id || !/^[a-z0-9-]{2,}$/i.test(id)){ setMsg('newEvMsg','Valid event id चाहिए (a-z0-9-)','error'); return; }
      const body = { eventId:id, eventName:(name||id), date };
      const r = await safeFetch(URL_EVENTS,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const j = await safeJson(r);
      if(!r.ok){ setMsg('newEvMsg',`Create failed ${r.status}: ${j.message||j._raw||''}`,'error'); return; }
      setMsg('newEvMsg','Event created','ok');
      // refresh list and select new
      await loadEvents(); const s=sel(); if(s) { s.value=id; localStorage.setItem('ADMIN_EVENT_ID', id); }
      toggleNew(false);
    }

    async function loadLogs(){
      await ensureApi(); const { URL_LOGS } = endpoints();
      const from = $('fromTs').value ? `?from=${encodeURIComponent($('fromTs').value)}` : '';
      const r = await safeFetch(URL_LOGS + from);
      const tb=$('logsTbl').querySelector('tbody'); tb.innerHTML='';
      if(!r.ok){ setMsg('logsMsg',`Logs HTTP ${r.status}`,'error'); return; }
      const rows = (await safeJson(r)).items || [];
      rows.forEach(row=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${row.ts??''}</td><td>${row.event||row.eventId||''}</td><td>${row.name??''}</td><td>${row.phone??''}</td><td>${row.note??''}</td>`; tb.appendChild(tr); });
      setMsg('logsMsg',`Loaded ${rows.length} logs`,'ok');
    }

    async function getUploadUrl(eventId, filename, contentType){
      await ensureApi(); const { URL_UPLOAD } = endpoints();
      const body = { eventId, filename, contentType };
      const b = (bucketEl()?.value||'').trim(); if(b) body.bucket=b;
      const r = await safeFetch(URL_UPLOAD,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const info = await safeJson(r);
      if(!r.ok) throw new Error(`UploadUrl HTTP ${r.status}: ${info.message||info._raw||''}`);
      return info; // can be PUT {uploadUrl,key} or POST {url,fields,key}
    }

    async function s3Put(url, file){ const r=await safeFetch(url,{method:'PUT',headers:{'Content-Type':file.type},body:file},60000); if(!r.ok) throw new Error(`S3 PUT ${r.status}`); }
    async function s3Post(url, fields, file){ const fd=new FormData(); Object.entries(fields).forEach(([k,v])=>fd.append(k,v)); fd.append('Content-Type', file.type); fd.append('file', file); const r=await safeFetch(url,{method:'POST',body:fd},60000); if(!r.ok) throw new Error(`S3 POST ${r.status}`); }

    /************* UPLOAD *************/
    async function handleFiles(list){
      const s = sel(); let eventId = s ? s.value : '';
      if(!eventId && s && s.options.length){ s.selectedIndex=0; eventId=s.value; }
      if(!eventId){ setMsg('upMsg','पहले Event चुनें','error'); return; }
      const files=[...list].filter(f=>/image/i.test(f.type)); if(!files.length){ toast('No images'); return; }
      const maxDim=+$('maxDim').value||3000; const q=+$('jpegQ').value||0.88; const thumbs=$('thumbs'); thumbs.innerHTML='';
      let done=0; setProgress(0); setMsg('upMsg','Uploading...');
      for(const f of files){
        try{
          const jpg=await toJpeg(f,maxDim,q);
          const info=await getUploadUrl(eventId, jpg.name, jpg.type);
          if(info.uploadUrl) await s3Put(info.uploadUrl, jpg);
          else if(info.url && info.fields) await s3Post(info.url, info.fields, jpg);
          else if(info._raw) throw new Error(info._raw);
          else throw new Error('Unknown upload-url shape');
          const imgUrl=(info.uploadUrl||info.url||'').split('?')[0] || `https://${(bucketEl()?.value||'wedmatch-photos')}.s3.ap-south-1.amazonaws.com/${encodeURIComponent(info.key||info.s3Key||jpg.name)}`;
          const card=document.createElement('div'); card.className='thumb'; card.innerHTML=`<img alt="" loading="lazy"><div class="muted">${jpg.name}</div>`; card.querySelector('img').src=imgUrl; thumbs.prepend(card);
          done++; setProgress((done/files.length)*100); setMsg('upMsg',`Done: ${done}/${files.length}`,'ok');
        }catch(e){ console.error(e); setMsg('upMsg',`Upload error: ${e.message}`,'error'); toast(`Upload error: ${e.message}`,3500); }
        await delay(60);
      }
    }

    /************* UI HOOKS *************/
    function toggleNew(show){ $('newEventCard').style.display = show?'block':'none'; }

    document.addEventListener('DOMContentLoaded', ()=>{
      // restore apiBase
      state.apiBase = localStorage.getItem('apiBase') || '';
      $('apiBase').value = state.apiBase;

      $('saveApi').addEventListener('click', ()=>{
        const val=$('apiBase').value.trim();
        if(!/^https?:\/\//i.test(val) || !val.includes('execute-api')){ setMsg('apiMsg','कृपया execute-api…/PROD2 URL डालें','error'); return; }
        localStorage.setItem('apiBase', val); state.apiBase=val; setMsg('apiMsg','Saved','ok'); log('apiBase', val); loadEvents();
      });

      $('diag').addEventListener('click', async ()=>{
        if(!state.apiBase){ toast('Set API Base first'); return; }
        const {URL_EVENTS,URL_LOGS,URL_UPLOAD}=endpoints(); log('diag base', state.apiBase);
        try{ const r1=await safeFetch(URL_EVENTS); log('diag /admin/events', r1.status); }catch{ log('diag /admin/events', 'net'); }
        try{ const r2=await safeFetch(URL_LOGS);   log('diag /admin/logs', r2.status); }catch{ log('diag /admin/logs', 'net'); }
        try{ const r3=await safeFetch(URL_UPLOAD,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId:'_diag_',filename:'test.jpg',contentType:'image/jpeg'})}); log('diag /upload-url', r3.status); }catch{ log('diag /upload-url', 'net'); }
        toast('Diagnostics done');
      });

      // new event UI
      $('newEventBtn').addEventListener('click', ()=> toggleNew(true));
      $('cancelNew').addEventListener('click', ()=> toggleNew(false));
      $('createEvent').addEventListener('click', createEvent);

      // event change → save
      sel().addEventListener('change', ()=>{ localStorage.setItem('ADMIN_EVENT_ID', sel().value||''); });

      // drag & drop
      const drop=$('drop'); const file=$('file');
      ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('drag')}));
      ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('drag')}));
      drop.addEventListener('drop', e=> handleFiles(e.dataTransfer.files));
      file.addEventListener('change', e=> handleFiles(e.target.files));

      $('loadLogs').addEventListener('click', loadLogs);

      // auto-load if API saved
      if(state.apiBase) loadEvents();
    });
  </script>
</body>
</html>

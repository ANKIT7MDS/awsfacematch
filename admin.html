<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WedMatch — Admin</title>
  <style>
    :root{ --bg:#fff7ed; --card:#fff1e0; --muted:#6b6b6b; --text:#222; --line:#ffd7aa; --accent:#ff7a00; --accent2:#ffb347; --ok:#15803d; --err:#e11d48 }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#fff7ed,#ffe9cc);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{padding:18px 14px;background:linear-gradient(90deg,#ffae42,#ff8a00);border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:0 12px}
    h1{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    label{display:block;margin:.5rem 0 .3rem;color:var(--muted)}
    input,button,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #f7c27c;background:#fff;color:#111}
    input::placeholder{color:#9b9b9b}
    button{cursor:pointer;background:linear-gradient(180deg,var(--accent),#ff9b2f);border:0;color:#2a1200;font-weight:700}
    button.secondary{background:#182141;color:#cfe}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f5d2a8;font-size:13px}
    .tiny{font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)} .err{color:var(--err)}
  </style>
</head>
<body>
  <header><div class="wrap"><h1>WedMatch — Admin Panel</h1></div></header>
  <div class="wrap" style="margin:16px auto">

    <div class="grid">
      <!-- EVENTS -->
      <section class="card">
        <h2>Events</h2>
        <label>Event ID</label>
        <input id="evId" placeholder="demo-2025-01"/>
        <label>Name</label>
        <input id="evName" placeholder="उदाहरण: भाजपा कार्यालय कार्यक्रम"/>
        <label>PIN (optional)</label>
        <input id="evPin" placeholder="1234"/>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnSaveEvent">Save</button>
          <button class="secondary" id="btnListEvents">Refresh</button>
        </div>
        <div class="tiny" id="evMsg"></div>
        <div style="max-height:200px;overflow:auto;margin-top:8px">
          <table id="evTbl"><thead><tr><th>eventId</th><th>name</th><th>pin</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- USERS -->
      <section class="card">
        <h2>Users</h2>
        <label>Name</label>
        <input id="uName" placeholder="अंकित"/>
        <label>Phone</label>
        <input id="uPhone" placeholder="98xxxxxx10"/>
        <label>Event ID</label>
        <input id="uEvent" placeholder="demo-2025-01"/>
        <label>Role</label>
        <select id="uRole"><option value="user">user</option><option value="admin">admin</option></select>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnAddUser">Add</button>
          <button class="secondary" id="btnListUsers">Refresh</button>
        </div>
        <div class="tiny" id="uMsg"></div>
        <div style="max-height:220px;overflow:auto;margin-top:8px">
          <table id="uTbl"><thead><tr><th>userId</th><th>name</th><th>phone</th><th>eventId</th><th>role</th></tr></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- UPLOAD -->
      <section class="card">
        <h2>Upload photos to an Event</h2>
        <label>Event ID</label>
        <input id="upEvent" placeholder="demo-2025-01"/>
        <label>Choose files (multiple)</label>
        <input id="upFiles" type="file" multiple accept="image/*"/>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnGenUpload">Generate Links & Upload</button>
        </div>
        <div class="tiny" id="upMsg"></div>
        <div id="upList" class="tiny" style="max-height:220px;overflow:auto;margin-top:8px"></div>
      </section>

      <!-- LOGS -->
      <section class="card">
        <h2>Search Logs</h2>
        <label>Event ID ("*" for global)</label>
        <input id="logEvent" value="*"/>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnLoadLogs">Load</button>
        </div>
        <div style="max-height:260px;overflow:auto;margin-top:8px">
          <table id="logTbl"><thead><tr><th>time</th><th>name</th><th>phone</th><th>matches</th><th>ip</th></tr></thead><tbody></tbody></table>
        </div>
      </section>
    </div>
  </div>

<script>
(async function(){
  const $=id=>document.getElementById(id);
  const BASE='https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
  const CFG={ events: BASE+'/admin/events', users: BASE+'/admin/users', logs: BASE+'/admin/logs', upload: BASE+'/upload-url', bucket:'wedmatch-photos' };

  // ===== Events =====
  $('btnSaveEvent').onclick=async()=>{
    const body={ eventId: $('evId').value.trim(), name:$('evName').value.trim(), pin:$('evPin').value.trim() };
    if(!body.eventId) return msg('evMsg','eventId आवश्यक',true);
    try{ await api('POST',CFG.events,body); msg('evMsg','Saved',false); loadEvents(); }catch(e){ msg('evMsg',e.message,true); }
  };
  $('btnListEvents').onclick=()=>loadEvents();
  async function loadEvents(){ const j=await api('GET',CFG.events); const tb=$('evTbl').querySelector('tbody'); tb.innerHTML=''; (j.items||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.eventId}</td><td>${r.name||''}</td><td>${r.pin||''}</td>`; tb.appendChild(tr); }); }

  // ===== Users =====
  $('btnAddUser').onclick=async()=>{
    const body={ name:$('uName').value.trim(), phone:$('uPhone').value.trim(), eventId:$('uEvent').value.trim(), role:$('uRole').value };
    if(!body.name||!body.phone||!body.eventId) return msg('uMsg','name/phone/eventId आवश्यक',true);
    try{ await api('POST',CFG.users,body); msg('uMsg','Added',false); loadUsers(); }catch(e){ msg('uMsg',e.message,true); }
  };
  $('btnListUsers').onclick=()=>loadUsers();
  async function loadUsers(){ const j=await api('GET',CFG.users); const tb=$('uTbl').querySelector('tbody'); tb.innerHTML=''; (j.items||[]).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.userId}</td><td>${r.name||''}</td><td>${r.phone||''}</td><td>${r.eventId||''}</td><td>${r.role||''}</td>`; tb.appendChild(tr); }); }

  // ===== Upload (multi) =====
  $('btnGenUpload').onclick=async()=>{
    const ev=$('upEvent').value.trim(); const files=[...$('upFiles').files]; if(!ev) return msg('upMsg','eventId आवश्यक',true); if(!files.length) return msg('upMsg','Choose images',true);
    $('upMsg').textContent='Uploading…'; $('upList').innerHTML='';
    let done=0; for(const f of files){ try{ const key=`events/${ev}/incoming/${cryptoRand()}.jpg`; const link=await presignUpload(key,'image/jpeg'); const jf=await fileToJpeg(f); await browserUpload(link, jf, { 'x-amz-meta-eventid': ev, 'x-amz-meta-filename': f.name }); addLine(`${++done}/${files.length} ${key}`); }catch(e){ addLine('ERR '+e.message); } }
    $('upMsg').textContent='Completed';
  };

  // ===== Logs =====
  $('btnLoadLogs').onclick=async()=>{ const ev=$('logEvent').value.trim()||'*'; const j=await api('GET',CFG.logs+`?eventId=${encodeURIComponent(ev)}&limit=100`); const tb=$('logTbl').querySelector('tbody'); tb.innerHTML=''; (j.items||[]).forEach(r=>{ const d=new Date(r.ts||0); const tr=document.createElement('tr'); tr.innerHTML=`<td>${d.toLocaleString()}</td><td>${r.name}</td><td>${r.phone}</td><td>${r.matches}</td><td>${r.ip}</td>`; tb.appendChild(tr); }); };

  // ===== helpers =====
  function msg(id,text,err){ const el=$(id); el.textContent=text; el.className='tiny '+(err?'err':'ok'); }
  async function api(method,url,body){ const r=await fetch(url,{ method, headers:{'Content-Type':'application/json'}, body: method==='GET'?null:JSON.stringify(body||{}) }); const j=await r.json(); if(!r.ok) throw new Error(j.message||j.error||r.statusText); return j; }
  function addLine(s){ const p=document.createElement('div'); p.textContent=s; $('upList').appendChild(p); }

  // Upload helpers
  async function fileToJpeg(file){ if(file.type==='image/jpeg') return file; const url=URL.createObjectURL(file); const img=new Image(); img.src=url; await img.decode(); const c=document.createElement('canvas'); c.width=img.naturalWidth; c.height=img.naturalHeight; c.getContext('2d').drawImage(img,0,0); URL.revokeObjectURL(url); const blob=await new Promise(r=>c.toBlob(r,'image/jpeg',0.9)); return new File([blob], file.name.replace(/\.[^.]+$/i,'.jpg'), {type:'image/jpeg'}); }
  async function presignUpload(key, contentType){ const r=await fetch(CFG.upload,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ eventId: $('upEvent').value.trim(), fileName: key.split('/').pop(), contentType }) }); const j=await r.json(); if(!j.url) throw new Error(j.message||j.error||'no url'); return j; }
  async function browserUpload(link, file, meta){ const fd=new FormData(); Object.entries(link.fields).forEach(([k,v])=>fd.append(k,v)); if(meta) Object.entries(meta).forEach(([k,v])=>fd.append(k,v)); fd.append('file', file); const r=await fetch(link.url,{ method:'POST', body:fd }); if(!r.ok) throw new Error('S3 upload failed'); }
  function cryptoRand(){ return (crypto.getRandomValues(new Uint32Array(1))[0]).toString(16)+Date.now().toString(16); }

  // initial loads
  await loadEvents(); await loadUsers();
})();
</script>
</body>
</html>

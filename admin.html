<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WedMatch — Admin Panel</title>
  <style>
    :root{--brand:#ff8a00;--bg:#fff7ef;--card:#fff;--muted:#7a7a7a;--border:#e9d7c3}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{background:var(--brand);color:#111;padding:14px 18px;font-weight:700}
    main{max-width:1100px;margin:0 auto;padding:18px}
    .row{display:grid;gap:14px}
    .grid-2{grid-template-columns:1fr 1fr}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    label{font-weight:600;margin:6px 0 4px;display:block}
    input,select,button{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    button{background:var(--brand);border:none;font-weight:700;cursor:pointer}
    button.secondary{background:#111;color:#fff}
    .muted{color:var(--muted);font-size:12px}
    .drop{border:2px dashed var(--border);border-radius:12px;background:#fffaf1;padding:18px;text-align:center}
    .drop.drag{background:#fff0dc;border-color:#f2b56c}
    .progress{height:8px;background:#ffe0b6;border-radius:99px;overflow:hidden;margin-top:8px}
    .progress>i{display:block;height:100%;background:var(--brand);width:0%}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:10px}
    .thumb{background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px;display:flex;flex-direction:column;gap:6px}
    .thumb img{width:100%;aspect-ratio:1;object-fit:cover;border-radius:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
    th{background:#fff2e0}
    .debug{white-space:pre-wrap;background:#0e1116;color:#d6deeb;border-radius:12px;padding:12px;overflow:auto;max-height:220px}
    .toast{position:fixed;right:14px;bottom:14px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:.95;z-index:9999}
    .inline{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <header>WedMatch — Admin Panel</header>
  <main>

    <!-- API SETUP -->
    <section class="card">
      <div class="row grid-2">
        <div>
          <label for="apiBase">API Base URL</label>
          <input id="apiBase" placeholder="https://<api-id>.execute-api.ap-south-1.amazonaws.com/PROD2" />
          <div class="inline" style="margin-top:8px">
            <button id="saveApi">Save API URL</button>
            <button id="diag" class="secondary">Run API Diagnostics</button>
          </div>
          <div class="muted" style="margin-top:6px">Tip: Netlify डोमेन नहीं, अपना API Gateway Stage URL डालें।</div>
        </div>
        <div>
          <div class="inline">
            <div style="flex:1">
              <label for="eventId">इवेंट चुनें</label>
              <select id="eventId"></select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="addEventBtn" class="secondary" title="Add new event">+ New Event</button>
            </div>
          </div>

          <label for="bucket" style="margin-top:8px">S3 Bucket</label>
          <select id="bucket">
            <option value="wedmatch-photos">wedmatch-photos</option>
          </select>
        </div>
      </div>
    </section>

    <!-- UPLOAD -->
    <section class="card">
      <h3 style="margin:0 0 6px">Upload Photos</h3>
      <div class="muted">इमेज ड्रैग-ड्रॉप करें या फाइल चुनें। Client-side resize → JPEG, फिर <code>/upload-url</code> से S3 में अपलोड।</div>

      <div id="drop" class="drop" style="margin-top:10px">
        <b>इमेज यहाँ ड्रॉप करें</b> या
        <input id="file" type="file" accept="image/*" multiple style="max-width:320px;margin-left:6px">
      </div>

      <div class="row grid-2" style="margin-top:10px">
        <div>
          <label for="maxDim">Max dimension (px)</label>
          <input id="maxDim" type="number" value="3000">
        </div>
        <div>
          <label for="jpegQ">JPEG quality</label>
          <input id="jpegQ" type="number" step="0.01" value="0.88">
        </div>
      </div>

      <div class="progress" aria-label="upload progress" style="margin-top:10px"><i id="bar"></i></div>
      <div id="upMsg" class="muted" style="margin-top:8px">Ready.</div>
      <div id="thumbs" class="thumbs"></div>
    </section>

    <!-- LOGS -->
    <section class="card">
      <h3 style="margin:0 0 6px">Search Logs</h3>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <label for="fromTs" style="margin:0">From (epoch ms)</label>
        <input id="fromTs" type="number" placeholder="(optional)" style="max-width:260px">
        <button id="loadLogs">लोड करें</button>
      </div>
      <div style="overflow:auto;margin-top:10px">
        <table id="logsTbl">
          <thead><tr><th>TS</th><th>Event</th><th>Name</th><th>Phone</th><th>Note</th></tr></thead>
          <tbody></tbody></table>
      </div>
    </section>

    <!-- DEBUG -->
    <section class="card">
      <h3 style="margin:0 0 6px">Debug</h3>
      <div id="dbg" class="debug">ready</div>
    </section>

  </main>

  <script>
    /************* UTILITIES *************/
    const $ = (id)=>document.getElementById(id);
    const state = { apiBase:"" };

    function toast(msg, ms=2800){
      const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
      document.body.appendChild(t); setTimeout(()=>t.remove(), ms);
    }
    function log(...a){
      console.log(...a);
      const el=$('dbg'); if(!el) return;
      const s = a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' | ');
      el.textContent = new Date().toLocaleTimeString() + '  ' + s;
    }
    const delay = (ms)=>new Promise(r=>setTimeout(r,ms));

    // JSON-safe (server कभी-कभी text दे दे)
    async function safeJson(res){
      const txt = await res.text();
      try{ return JSON.parse(txt); } catch{ return { _raw: txt }; }
    }

    // fetch with timeout
    async function safeFetch(url, opts={}, timeoutMs=20000){
      const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),timeoutMs);
      try{ return await fetch(url,{...opts,signal:ctrl.signal}); }
      finally{ clearTimeout(t); }
    }

    // normalize endpoints from base
    function build(base){
      return {
        events   : base + '/admin/events',
        logs     : base + '/admin/logs',
        upload   : base + '/upload-url',
        download : base + '/download' // for thumbnail fallback
      };
    }

    // image → JPEG (client-side)
    async function toJpeg(file, maxDim=3000, quality=0.88){
      const img = await new Promise((res,rej)=>{
        const u=URL.createObjectURL(file), i=new Image();
        i.onload=()=>{URL.revokeObjectURL(u);res(i)}; i.onerror=e=>{URL.revokeObjectURL(u);rej(e)}; i.src=u;
      });
      const w=img.width,h=img.height; let nw=w,nh=h;
      if(Math.max(w,h)>maxDim){ const k=maxDim/Math.max(w,h); nw=Math.round(w*k); nh=Math.round(h*k); }
      const c=document.createElement('canvas'); c.width=nw; c.height=nh;
      c.getContext('2d').drawImage(img,0,0,nw,nh);
      const blob=await new Promise(r=>c.toBlob(r,'image/jpeg',quality));
      return new File([blob], file.name.replace(/\.(png|webp|heic|heif|bmp)$/i,'.jpg'), {type:'image/jpeg'});
    }

    function setProgress(pct){ $('bar').style.width=Math.max(0,Math.min(100,pct))+'%'; }

    /************* API CALLS *************/
    async function ensureApi(){
      if(!state.apiBase){ toast('पहले API Base URL सेव करें'); throw new Error('apiBase not set'); }
      if(!/^https?:\/\//i.test(state.apiBase)) { toast('API Base invalid'); throw new Error('bad apiBase'); }
    }

    async function loadEvents(){
      await ensureApi();
      const URL = build(state.apiBase).events;
      const r = await safeFetch(URL);
      if(!r.ok) throw new Error(`Events HTTP ${r.status}`);
      const data = await safeJson(r);
      const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);
      const sel = $('eventId');
      if(items.length){
        sel.innerHTML = items.map(e=>{
          const id = e.eventId || e; const name = e.eventName || id; return `<option value="${id}">${name}</option>`;
        }).join('');
      }else{
        sel.innerHTML = `<option value="">(no events)</option>`;
      }
      log('events', items);
    }

    async function addEvent(){
      await ensureApi();
      const id = prompt('New eventId? (e.g. demo-2025-01)');
      if(!id) return;
      const body = { eventId:id.trim(), eventName:id.trim() };
      const r = await safeFetch(build(state.apiBase).events, {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
      });
      const j=await safeJson(r);
      if(!r.ok){ toast('Failed: '+(j.message||r.status)); return; }
      toast('Event created'); await loadEvents();
      const sel=$('eventId'); sel.value=id; // select new
    }

    async function loadLogs(){
      await ensureApi();
      const base=build(state.apiBase);
      const from = $('fromTs').value ? `?from=${encodeURIComponent($('fromTs').value)}` : '';
      const r = await safeFetch(base.logs + from);
      if(!r.ok) throw new Error(`Logs HTTP ${r.status}`);
      const payload = await safeJson(r);
      const rows = payload?.items || payload || [];
      const tb=$('logsTbl').querySelector('tbody'); tb.innerHTML='';
      rows.forEach(row=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${row.ts??''}</td><td>${row.event??''}</td><td>${row.name??''}</td><td>${row.phone??''}</td><td>${row.note??''}</td>`;
        tb.appendChild(tr);
      });
      log('logs count', rows.length);
    }

    async function getUploadUrl(filename, contentType){
      await ensureApi();
      const base=build(state.apiBase);
      const body={
        eventId : $('eventId').value || $('eventId').options[0]?.value || '',
        bucket  : $('bucket').value,
        filename, contentType
      };
      const r = await safeFetch(base.upload,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const info = await safeJson(r);
      if(!r.ok) throw new Error(`UploadUrl HTTP ${r.status}: ${JSON.stringify(info)}`);
      // Support PUT and POST presign shapes:
      if(info.uploadUrl) return {mode:'PUT', url:info.uploadUrl, key:info.key||info.s3Key};
      if(info.url && info.fields) return {mode:'POST', url:info.url, fields:info.fields, key:info.key||info.s3Key};
      if(info._raw) throw new Error(`Upload URL missing: ${info._raw}`);
      throw new Error('Upload URL missing');
    }

    async function s3Put(url, file){
      const r=await safeFetch(url,{method:'PUT',headers:{'Content-Type':file.type},body:file},60000);
      if(!r.ok) throw new Error(`S3 PUT ${r.status}`);
    }
    async function s3Post(url, fields, file){
      const fd=new FormData(); Object.entries(fields).forEach(([k,v])=>fd.append(k,v));
      fd.append('Content-Type', file.type); fd.append('file', file);
      const r=await safeFetch(url,{method:'POST',body:fd},60000);
      if(!r.ok) throw new Error(`S3 POST ${r.status}`);
    }

    /************* UPLOAD FLOW *************/
    async function handleFiles(list){
      const files=[...list].filter(f=>/image/i.test(f.type));
      if(!files.length){ toast('No images found'); return; }
      if(!$('eventId').value && !$('eventId').options.length){ toast('पहले Events लोड करें'); return; }

      const maxDim=+$('maxDim').value||3000;
      const q=+$('jpegQ').value||0.88;
      const thumbs=$('thumbs'); thumbs.innerHTML='';

      let done=0;
      for(const f of files){
        try{
          const jpg=await toJpeg(f,maxDim,q);
          const info=await getUploadUrl(jpg.name,jpg.type);
          if(info.mode==='PUT') await s3Put(info.url, jpg); else await s3Post(info.url,info.fields,jpg);

          // ✅ Build view URL (PUT vs POST दोनों)
          let viewUrl='';
          if(info.mode==='PUT'){
            viewUrl=(info.url||'').split('?')[0];
          }else{
            const baseHost=(info.url||'').replace(/\?.*$/, '').replace(/\/$/, '');
            const key=info.fields?.key || info.key || '';
            const encKey=encodeURIComponent(key).replace(/%2F/g,'/');
            viewUrl=`${baseHost}/${encKey}`;
          }

          const card=document.createElement('div'); card.className='thumb';
          card.innerHTML=`<img alt=""><div class="muted">${jpg.name}</div>`;
          const imgEl=card.querySelector('img'); imgEl.alt=jpg.name; imgEl.src=viewUrl;

          // 🔁 private bucket fallback: /download से signed GET URL
          try{
            fetch(viewUrl,{method:'HEAD'}).then(r=>{ if(!r.ok) throw new Error('head_fail'); }).catch(async()=>{
              const body={ bucket:$('bucket').value, key: info.fields?.key || info.key };
              const res=await safeFetch(build(state.apiBase).download,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
              const j=await safeJson(res); if(res.ok && (j.url||j.downloadUrl)) imgEl.src=j.url||j.downloadUrl;
            });
          }catch{ /* ignore */ }

          thumbs.prepend(card);
          done++; setProgress((done/files.length)*100);
          $('upMsg').textContent=`Done: ${done}/${files.length}`;
          log('uploaded', {name:jpg.name, key:info.key||''});
        }catch(e){
          console.error(e);
          $('upMsg').textContent=`Error: ${e.message}`;
          toast(`Upload error: ${e.message}`, 3500);
          log('upload error', e?.message||e);
        }
        await delay(60);
      }
    }

    /************* BOOT *************/
    document.addEventListener('DOMContentLoaded', ()=>{
      // restore apiBase
      state.apiBase = localStorage.getItem('apiBase') || '';
      $('apiBase').value = state.apiBase;

      $('saveApi').addEventListener('click', ()=>{
        const val=$('apiBase').value.trim();
        if(!/^https?:\/\//i.test(val) || !val.includes('execute-api')){ toast('कृपया अपना API Gateway Stage URL डालें (execute-api…/PROD2)'); return; }
        localStorage.setItem('apiBase', val); state.apiBase=val;
        toast('API URL saved'); log('apiBase', val);
        loadEvents().catch(err=>{toast('Events load failed'); log('events error', err?.message||err);});
      });

      $('diag').addEventListener('click', async ()=>{
        if(!state.apiBase){ toast('Set API Base first'); return; }
        const base=build(state.apiBase); log('diag base', state.apiBase);
        try{
          const r1=await safeFetch(base.events); log('diag /admin/events', r1.status);
          const r2=await safeFetch(base.logs);   log('diag /admin/logs', r2.status);
          const r3=await safeFetch(base.upload,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({eventId:'_diag_',bucket:'wedmatch-photos',filename:'test.jpg',contentType:'image/jpeg'})});
          log('diag /upload-url', r3.status);
          toast('Diagnostics complete');
        }catch(e){ toast('Diagnostics failed'); log('diag error', e?.message||e); }
      });

      $('loadLogs').addEventListener('click', ()=>{
        loadLogs().catch(e=>{toast('Logs failed'); log('logs error', e?.message||e);});
      });

      $('addEventBtn').addEventListener('click', ()=>{
        addEvent().catch(e=>{toast('Create failed'); log('create error', e?.message||e);});
      });

      // drop/choose handlers
      $('file').addEventListener('change', e=>handleFiles(e.target.files));
      const dz=$('drop');
      ;['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev, e=>{e.preventDefault();dz.classList.add('drag');}));
      ;['dragleave','drop'].forEach(ev=>dz.addEventListener(ev, e=>{e.preventDefault();dz.classList.remove('drag');}));
      dz.addEventListener('drop', e=>handleFiles(e.dataTransfer.files));

      // अगर पहले से base है तो events ऑटो-लोड
      if(state.apiBase) loadEvents().catch(()=>{});
    });
  </script>
</body>
</html>

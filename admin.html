<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — WedMatch</title>
  <style>
    :root{--brand:#ff9800;--ink:#0f1a2b;--bg:#fff5e7;--card:#fff;--line:#f0d7b6}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#fff,var(--bg));color:#222}
    header{background:var(--brand);color:#111;padding:12px 16px;font-weight:800}
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:14px}
    h3{margin:0 0 10px 0}
    label{font-size:13px;color:#444;margin-bottom:6px;display:block}
    select,input,button{font:inherit}
    select,input[type=text]{width:100%;padding:10px;border:1px solid var(--line);border-radius:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{background:var(--brand);border:0;color:#111;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn.subtle{background:#fff;border:1px solid var(--line)}
    .pill{display:inline-block;background:var(--ink);color:#fff;border-radius:20px;padding:6px 10px;font-size:12px}
    .muted{color:#666;font-size:12px}
    .drop{border:2px dashed var(--line);border-radius:14px;padding:18px;text-align:center;background:#fff7ec}
    .bar{height:8px;background:#ffe0b3;border-radius:6px;overflow:hidden}
    .bar>i{display:block;height:100%;width:0;background:#ff9800;transition:width .3s}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:14px}
    th{background:#fff7ec}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .card-img{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#faf6ef;display:flex;align-items:center;justify-content:center;min-height:120px}
    .card-img img{width:100%;height:100%;object-fit:cover}
  </style>
</head>
<body>
  <header>WedMatch — Admin Panel</header>
  <main class="wrap">
    <div class="grid">
      <!-- Events & Settings -->
      <section class="card">
        <h3>इवेंट चुनें</h3>
        <div class="row">
          <div>
            <label for="eventSel">Event</label>
            <select id="eventSel"></select>
          </div>
          <div>
            <label for="bucket">S3 Bucket</label>
            <input id="bucket" type="text" />
          </div>
        </div>
        <p class="muted">नीचे ड्रैग-ड्रॉप या फाइल चुनें। JPEG में client-side resize होगा, फिर <code>/upload-url</code> से प्रीसाइन URL लेकर S3 में अपलोड होगा।</p>
      </section>

      <!-- Uploader -->
      <section class="card">
        <h3>Upload Photos</h3>
        <div id="drop" class="drop">इमेज यहाँ ड्रॉप करें या <input id="file" type="file" accept="image/*" multiple /></div>
        <div style="margin-top:10px" class="row">
          <div>
            <label>Max dimension (px)</label>
            <input id="maxDim" type="text" value="3000" />
          </div>
          <div>
            <label>JPEG quality</label>
            <input id="quality" type="text" value="0.88" />
          </div>
        </div>
        <div style="margin-top:10px" class="bar"><i id="pbar"></i></div>
        <div id="upMsg" class="muted"></div>
        <div class="thumbs" id="recent"></div>
      </section>

      <!-- Logs -->
      <section class="card">
        <h3>Search Logs</h3>
        <div class="row">
          <div>
            <label for="fromTs">From (epoch ms)</label>
            <input id="fromTs" type="text" placeholder="(optional)"/>
          </div>
          <div style="align-self:end"><button id="loadLogs" class="btn">लोड करें</button></div>
        </div>
        <div style="overflow:auto;max-height:360px;margin-top:8px">
          <table id="logsTbl">
            <thead><tr><th>TS</th><th>Event</th><th>Name</th><th>Phone</th><th>Note</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

<script>
// ====== CONFIG ======
const API_BASE = 'https://oidwg6gcx0.execute-api.ap-south-1.amazonaws.com/PROD2';
const URL_EVENTS = API_BASE + '/admin/events'; // GET list, POST create {eventId,eventName,date}
const URL_UPLOAD = API_BASE + '/upload-url';   // POST {eventId, filename, contentType}
const URL_LOGS   = API_BASE + '/logs';         // GET ?from=<ms>

// ====== ELEMENTS ======
const sel = document.getElementById('eventSel');
const bucketEl = document.getElementById('bucket');
const drop = document.getElementById('drop');
const file = document.getElementById('file');
const pbar = document.getElementById('pbar');
const upMsg = document.getElementById('upMsg');
const recent = document.getElementById('recent');
const maxDimEl = document.getElementById('maxDim');
const qualityEl = document.getElementById('quality');
const loadLogsBtn = document.getElementById('loadLogs');
const logsTbl = document.querySelector('#logsTbl tbody');

// ====== INIT ======
(async function init(){
  await loadEvents();
  // Try to detect bucket from first event's path convention if needed
  bucketEl.value = 'wedmatch-photos';
})();

async function loadEvents(){
  const res = await fetch(URL_EVENTS);
  const data = await res.json();
  const items = Array.isArray(data.items) ? data.items : (data.events||[]);
  sel.innerHTML = '';
  items.forEach(ev=>{
    const opt = document.createElement('option');
    opt.value = ev.eventId || ev.EventID || ev.id; opt.textContent = (ev.eventName||ev.name||opt.value);
    sel.appendChild(opt);
  });
}

// ====== UPLOAD FLOW ======
;['dragover','dragenter'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.background='#fff1dc';}));
;['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.background=''; if(ev==='drop'){ handleFiles(e.dataTransfer.files); }}));
file.addEventListener('change', e=> handleFiles(e.target.files));

async function handleFiles(list){
  const eventId = sel.value; if(!eventId){ alert('पहले Event चुनें'); return; }
  if(!list || !list.length) return;
  const maxDim = Math.max(256, parseInt(maxDimEl.value||'3000',10));
  const quality = Math.min(0.95, Math.max(0.5, parseFloat(qualityEl.value||'0.88')));

  let done=0; pbar.style.width='0%'; upMsg.textContent='Uploading...';

  for(const f of list){
    try{
      const {blob,ext} = await toJpegResized(f, maxDim, quality);
      const filename = (f.name.replace(/\.[^.]+$/,'')||('photo_'+Date.now())) + '.jpg';
      const contentType = 'image/jpeg';

      // 1) ask API for presigned URL
      const upReq = { eventId, filename, contentType };
      const r = await fetch(URL_UPLOAD,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(upReq)});
      const info = await r.json();

      // support both PUT style {uploadUrl,key} and POST style {url,fields,key}
      const key = info.key || info.s3Key || `events/${eventId}/${filename}`;

      if(info.uploadUrl){
        // PUT style
        await fetch(info.uploadUrl,{method:'PUT',headers:{'Content-Type':contentType},body:blob});
      } else if(info.url && info.fields){
        // POST style (HTML form data to S3)
        const fd = new FormData();
        Object.entries(info.fields).forEach(([k,v])=>fd.append(k,v));
        fd.append('Content-Type', contentType);
        fd.append('file', blob);
        await fetch(info.url,{method:'POST',body:fd});
      } else {
        // ultimate fallback (not ideal): direct PUT to bucket if CORS allows
        const url = `https://${bucketEl.value}.s3.ap-south-1.amazonaws.com/${encodeURIComponent(key)}`;
        await fetch(url,{method:'PUT',headers:{'Content-Type':contentType},body:blob});
      }

      // show recent tile
      const imgUrl = `https://${bucketEl.value}.s3.ap-south-1.amazonaws.com/${encodeURIComponent(key)}`;
      const div = document.createElement('div');
      div.className='card-img';
      const img = document.createElement('img');
      img.loading='lazy'; img.src = imgUrl; div.appendChild(img);
      recent.prepend(div);

    }catch(e){ console.error(e); alert('Upload failed: '+(e.message||e)); }
    finally{ done++; pbar.style.width = Math.round((done/list.length)*100)+'%'; }
  }

  upMsg.textContent = `Done: ${done}/${list.length}`;
}

function toJpegResized(file, maxDim, quality){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader(); fr.onerror = reject;
    fr.onload = ()=>{ const img = new Image(); img.onload=()=>{
      const iw=img.naturalWidth, ih=img.naturalHeight; const sc=Math.min(1, maxDim/Math.max(iw,ih));
      const w=Math.round(iw*sc), h=Math.round(ih*sc);
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      const cx=c.getContext('2d'); cx.drawImage(img,0,0,w,h);
      c.toBlob(b=> resolve({blob:b,ext:'jpg'}), 'image/jpeg', quality);
    }; img.src = fr.result; };
    fr.readAsDataURL(file);
  });
}

// ====== LOGS ======
loadLogsBtn.onclick = async ()=>{
  const from = document.getElementById('fromTs').value.trim();
  const url = from ? `${URL_LOGS}?from=${encodeURIComponent(from)}` : URL_LOGS;
  const res = await fetch(url); const data = await res.json();
  const items = data.items || data.logs || [];
  logsTbl.innerHTML = '';
  for(const it of items){
    const tr = document.createElement('tr');
    const ts = it.ts || it.timestamp || Date.now();
    const name = it.name || '';
    const phone = it.phone || '';
    const eventId = it.eventId || '';
    const note = it.note || it.info || '';
    tr.innerHTML = `<td>${new Date(Number(ts)).toLocaleString()}</td><td>${eventId}</td><td>${name}</td><td>${phone}</td><td>${note}</td>`;
    logsTbl.appendChild(tr);
  }
};
</script>
</body>
</html>
